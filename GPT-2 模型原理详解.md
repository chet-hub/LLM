# GPT-2 æ¨¡å‹åŸç†è¯¦è§£

åŸºäºè¿™ä»½ä»£ç ï¼Œæˆ‘æ¥è¯¦ç»†è§£é‡Š GPT-2 çš„å·¥ä½œåŸç†ã€‚

## ä¸€ã€æ•´ä½“æ¶æ„

GPT-2ï¼ˆGenerative Pre-trained Transformer 2ï¼‰æ˜¯ä¸€ä¸ªåŸºäº Transformer çš„**è‡ªå›å½’è¯­è¨€æ¨¡å‹**ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°æ ¸å¿ƒé…ç½®ï¼š

```c
typedef struct {
    int max_seq_len;        // æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆå¦‚ 1024ï¼‰
    int vocab_size;         // è¯æ±‡è¡¨å¤§å°ï¼ˆå¦‚ 50257ï¼‰
    int padded_vocab_size;  // å¡«å……åçš„è¯æ±‡è¡¨å¤§å°ï¼ˆå¦‚ 50304ï¼‰
    int num_layers;         // Transformer å±‚æ•°ï¼ˆå¦‚ 12ï¼‰
    int num_heads;          // æ³¨æ„åŠ›å¤´æ•°ï¼ˆå¦‚ 12ï¼‰
    int channels;           // éšè—å±‚ç»´åº¦ï¼ˆå¦‚ 768ï¼‰
} GPT2Config;
```

## äºŒã€æ ¸å¿ƒç»„ä»¶

### 1. **åµŒå…¥å±‚ï¼ˆEmbedding Layerï¼‰**

```c
void encoder_forward(float* out, int* inp, float* wte, float* wpe,
                     int B, int T, int C)
```

- **Token Embedding (wte)**: å°†è¯æ±‡ ID è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º
- **Position Embedding (wpe)**: ä¸ºæ¯ä¸ªä½ç½®æ·»åŠ ä½ç½®ä¿¡æ¯
- è¾“å‡ºï¼š`encoded = wte[token_id] + wpe[position]`

**åŸç†**ï¼šè¯­è¨€æ¨¡å‹éœ€è¦åŒæ—¶ç†è§£"è¯æ˜¯ä»€ä¹ˆ"å’Œ"è¯åœ¨å“ªé‡Œ"ï¼Œä¸¤ä¸ªåµŒå…¥å‘é‡ç›¸åŠ å½¢æˆåˆå§‹è¡¨ç¤ºã€‚

### 2. **Transformer å±‚**

æ¯ä¸ª Transformer å±‚åŒ…å«ä¸¤ä¸ªå­æ¨¡å—ï¼š

#### **A. è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰**

```c
void attention_forward(float* out, float* preatt, float* att,
                       float* inp, int B, int T, int C, int NH)
```

**å…³é”®æ­¥éª¤**ï¼š

1. **ç”Ÿæˆ Qã€Kã€V**ï¼ˆQueryã€Keyã€Valueï¼‰
   ```
   Q, K, V = Linear(input)  // é€šè¿‡çº¿æ€§å˜æ¢å¾—åˆ°
   ```

2. **è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°**
   ```c
   // å¯¹æ¯ä¸ªæŸ¥è¯¢ä½ç½® t
   for (int t2 = 0; t2 <= t; t2++) {
       val = dot(query_t, key_t2) * scale;  // ç‚¹ç§¯
       preatt[t2] = val;
   }
   ```
   - åªå…³æ³¨ `t2 <= t`ï¼ˆå› æœæ©ç ï¼‰ï¼Œä¿è¯åªçœ‹"è¿‡å»"
   - `scale = 1/âˆš(head_size)` é˜²æ­¢ç‚¹ç§¯è¿‡å¤§

3. **Softmax å½’ä¸€åŒ–**
   ```c
   expsum = sum(exp(preatt[t2] - maxval));
   att[t2] = exp(preatt[t2] - maxval) / expsum;
   ```

4. **åŠ æƒæ±‚å’Œ Value**
   ```c
   for (int t2 = 0; t2 <= t; t2++) {
       out[i] += att[t2] * value_t2[i];
   }
   ```

**ç›´è§‚ç†è§£**ï¼š
- Query é—®ï¼š"æˆ‘éœ€è¦ä»€ä¹ˆä¿¡æ¯ï¼Ÿ"
- Key ç­”ï¼š"æˆ‘è¿™é‡Œæœ‰ä»€ä¹ˆä¿¡æ¯ï¼Ÿ"
- Value æä¾›ï¼š"è¿™æ˜¯å…·ä½“å†…å®¹"
- Attention æƒé‡å†³å®š"å…³æ³¨å“ªäº›è¯"

#### **B. å‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFeed-Forward Networkï¼‰**

```c
// 1. ç¬¬ä¸€å±‚ï¼šæ‰©å±• 4 å€
matmul_forward(l_fch, l_ln2, l_fcw, l_fcb, B, T, C, 4*C);

// 2. GeLU æ¿€æ´»å‡½æ•°
gelu_forward(l_fch_gelu, l_fch, B*T*4*C);

// 3. ç¬¬äºŒå±‚ï¼šå‹ç¼©å›åŸç»´åº¦
matmul_forward(l_fcproj, l_fch_gelu, l_fcprojw, l_fcprojb, B, T, 4*C, C);
```

**GeLU æ¿€æ´»å‡½æ•°**ï¼š
```c
out = 0.5 * x * (1.0 + tanh(âˆš(2/Ï€) * (x + 0.044715 * xÂ³)))
```
æ¯” ReLU æ›´å¹³æ»‘ï¼Œåœ¨è´Ÿå€¼åŒºåŸŸæœ‰å°çš„æ¢¯åº¦ã€‚

### 3. **Layer Normalization**

```c
void layernorm_forward(float* out, float* mean, float* rstd,
                       float* inp, float* weight, float* bias,
                       int B, int T, int C)
```

**æ­¥éª¤**ï¼š
1. è®¡ç®—å‡å€¼ï¼š`mean = sum(x) / C`
2. è®¡ç®—æ ‡å‡†å·®ï¼š`std = âˆš(sum((x - mean)Â²) / C)`
3. å½’ä¸€åŒ–ï¼š`normalized = (x - mean) / std`
4. ç¼©æ”¾å’Œåç§»ï¼š`out = normalized * weight + bias`

**ä½œç”¨**ï¼šç¨³å®šè®­ç»ƒï¼ŒåŠ é€Ÿæ”¶æ•›ã€‚

### 4. **æ®‹å·®è¿æ¥ï¼ˆResidual Connectionï¼‰**

```c
void residual_forward(float* out, float* inp1, float* inp2, int N) {
    for (int i = 0; i < N; i++) {
        out[i] = inp1[i] + inp2[i];  // ç®€å•ç›¸åŠ 
    }
}
```

**æ„ä¹‰**ï¼šå…è®¸æ¢¯åº¦ç›´æ¥ä¼ æ’­ï¼Œè§£å†³æ·±å±‚ç½‘ç»œè®­ç»ƒå›°éš¾çš„é—®é¢˜ã€‚

## ä¸‰ã€å®Œæ•´å‰å‘ä¼ æ’­æµç¨‹

```c
void gpt2_forward(GPT2 *model, int* inputs, int* targets, size_t B, size_t T)
```

**é€æ­¥æ‰§è¡Œ**ï¼š

```
è¾“å…¥ tokens â†’ 
    Embedding (Token + Position) â†’
        [é‡å¤ L å±‚]
        â”œâ”€ LayerNorm â†’
        â”œâ”€ Multi-Head Attention â†’
        â”œâ”€ Residual Add â†’
        â”œâ”€ LayerNorm â†’
        â”œâ”€ Feed-Forward Network (FFN) â†’
        â””â”€ Residual Add â†’
    Final LayerNorm â†’
    Linear Projection (è¾“å‡ºè¯æ±‡è¡¨å¤§å°) â†’
    Softmax â†’ 
è¾“å‡ºæ¦‚ç‡åˆ†å¸ƒ
```

**ä»£ç ç¤ºä¾‹**ï¼ˆç¬¬ l å±‚ï¼‰ï¼š
```c
// æ³¨æ„åŠ›åˆ†æ”¯
layernorm_forward(l_ln1, ...);           // é¢„å½’ä¸€åŒ–
matmul_forward(l_qkv, l_ln1, ...);       // ç”Ÿæˆ Q,K,V
attention_forward(l_atty, ...);          // è‡ªæ³¨æ„åŠ›
matmul_forward(l_attproj, l_atty, ...);  // è¾“å‡ºæŠ•å½±
residual_forward(l_residual2, residual, l_attproj, ...); // æ®‹å·®è¿æ¥

// FFN åˆ†æ”¯
layernorm_forward(l_ln2, ...);           // é¢„å½’ä¸€åŒ–
matmul_forward(l_fch, l_ln2, ...);       // æ‰©å±•
gelu_forward(l_fch_gelu, l_fch, ...);    // æ¿€æ´»
matmul_forward(l_fcproj, l_fch_gelu, ...); // å‹ç¼©
residual_forward(l_residual3, l_residual2, l_fcproj, ...); // æ®‹å·®è¿æ¥
```

## å››ã€è®­ç»ƒè¿‡ç¨‹

### 1. **æŸå¤±è®¡ç®—**

```c
// Cross-Entropy Loss
crossentropy_forward(model->acts.losses, model->acts.probs, targets, B, T, Vp);
```

å¯¹äºæ¯ä¸ªä½ç½®ï¼ŒæŸå¤±ä¸ºï¼š`loss = -log(P(æ­£ç¡®è¯))`

### 2. **åå‘ä¼ æ’­**

```c
void gpt2_backward(GPT2 *model)
```

é€šè¿‡é“¾å¼æ³•åˆ™è®¡ç®—æ‰€æœ‰å‚æ•°çš„æ¢¯åº¦ï¼Œä»è¾“å‡ºå±‚åå‘åˆ°è¾“å…¥å±‚ã€‚

### 3. **å‚æ•°æ›´æ–°ï¼ˆAdamW ä¼˜åŒ–å™¨ï¼‰**

```c
void gpt2_update(GPT2 *model, float learning_rate, ...)
```

**AdamW å…¬å¼**ï¼š
```
m = Î²â‚ * m + (1 - Î²â‚) * grad          // ä¸€é˜¶çŸ©ä¼°è®¡ï¼ˆåŠ¨é‡ï¼‰
v = Î²â‚‚ * v + (1 - Î²â‚‚) * gradÂ²         // äºŒé˜¶çŸ©ä¼°è®¡ï¼ˆRMSpropï¼‰
m_hat = m / (1 - Î²â‚^t)                // åå·®ä¿®æ­£
v_hat = v / (1 - Î²â‚‚^t)
param -= lr * (m_hat / (âˆšv_hat + Îµ) + weight_decay * param)
```

## äº”ã€æ¨ç†ï¼ˆæ–‡æœ¬ç”Ÿæˆï¼‰

```c
// è‡ªå›å½’ç”Ÿæˆ
for (int t = 1; t < genT; t++) {
    gpt2_forward(&model, gen_tokens, NULL, B, T);
    float* probs = model.acts.probs + (t-1) * Vp;
    int next_token = sample_mult(probs, V, random_f32(&rng_state));
    gen_tokens[t] = next_token;
}
```

**æµç¨‹**ï¼š
1. è¾“å…¥å·²ç”Ÿæˆçš„ tokens
2. æ¨¡å‹è¾“å‡ºä¸‹ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒ
3. ä»åˆ†å¸ƒä¸­é‡‡æ ·ä¸€ä¸ª token
4. å°†å…¶åŠ å…¥åºåˆ—ï¼Œé‡å¤æ­¥éª¤ 1-3

## å…­ã€å…³é”®è®¾è®¡æ€æƒ³

1. **å› æœæ³¨æ„åŠ›**ï¼šåªçœ‹"è¿‡å»"çš„ tokensï¼Œç¡®ä¿ç”Ÿæˆçš„è‡ªå›å½’æ€§è´¨
2. **å¤šå¤´æ³¨æ„åŠ›**ï¼šä¸åŒçš„å¤´å­¦ä¹ ä¸åŒçš„è¯­ä¹‰å…³ç³»
3. **æ®‹å·®è¿æ¥ + LayerNorm**ï¼šç¨³å®šæ·±å±‚ç½‘ç»œè®­ç»ƒ
4. **ä½ç½®ç¼–ç **ï¼šå¼¥è¡¥ Transformer æ— åºæ€§
5. **é¢„è®­ç»ƒ + å¾®è°ƒ**ï¼šå…ˆåœ¨å¤§è§„æ¨¡è¯­æ–™ä¸Šå­¦ä¹ è¯­è¨€æ¨¡å¼ï¼Œå†é€‚é…å…·ä½“ä»»åŠ¡

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–äº®ç‚¹

ä»£ç ä¸­çš„ä¼˜åŒ–æŠ€å·§ï¼š
- **å¾ªç¯å±•å¼€**ï¼ˆLOOP_UNROLL=8ï¼‰å¤ç”¨æƒé‡
- **OpenMP å¹¶è¡ŒåŒ–**åŠ é€ŸçŸ©é˜µè¿ç®—
- **å†…å­˜è¿ç»­å¸ƒå±€**æé«˜ç¼“å­˜å‘½ä¸­ç‡
- **æ•°å€¼ç¨³å®šæ€§**ï¼ˆå‡å» maxval é˜²æ­¢ exp æº¢å‡ºï¼‰

---

è¿™ä»½ä»£ç æ˜¯ä¸€ä¸ª**æ•™å­¦çº§**çš„æ¸…æ™°å®ç°ï¼Œå±•ç¤ºäº† GPT-2 çš„æ ¸å¿ƒåŸç†ã€‚å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä¼šä½¿ç”¨ GPUã€æ··åˆç²¾åº¦è®­ç»ƒã€Flash Attention ç­‰æ›´å¤šä¼˜åŒ–æŠ€æœ¯ã€‚


# åµŒå…¥å±‚ æ˜¯ä»€ä¹ˆï¼Ÿç”¨æœ€é€šä¿—æ˜“æ‡‚çš„ä¾‹å­è§£é‡Š
# åµŒå…¥å±‚ï¼ˆEmbedding Layerï¼‰é€šä¿—è§£é‡Š

## ä¸€ã€æ ¸å¿ƒé—®é¢˜ï¼šè®¡ç®—æœºä¸æ‡‚æ–‡å­—

æƒ³è±¡ä½ è¦æ•™è®¡ç®—æœºç†è§£å¥å­ï¼š**"æˆ‘çˆ±åƒè‹¹æœ"**

**é—®é¢˜æ¥äº†**ï¼š
- è®¡ç®—æœºåªè®¤è¯†æ•°å­—ï¼ˆ0å’Œ1ï¼‰
- ä½†æ–‡å­—"æˆ‘"ã€"çˆ±"ã€"åƒ"ã€"è‹¹æœ"ä¸æ˜¯æ•°å­—
- æ€ä¹ˆè®©è®¡ç®—æœºå¤„ç†æ–‡å­—å‘¢ï¼Ÿ

## äºŒã€æœ€ç®€å•çš„æƒ³æ³•ï¼šç»™æ¯ä¸ªå­—ç¼–å·

### æ–¹æ³•1ï¼šç‹¬çƒ­ç¼–ç ï¼ˆOne-Hotï¼‰

```
è¯æ±‡è¡¨ï¼š["æˆ‘", "çˆ±", "åƒ", "è‹¹æœ", "é¦™è•‰", "è®¨åŒ", ...]

"æˆ‘"    â†’ [1, 0, 0, 0, 0, 0, ...]  (ç¬¬1ä¸ªè¯)
"çˆ±"    â†’ [0, 1, 0, 0, 0, 0, ...]  (ç¬¬2ä¸ªè¯)
"åƒ"    â†’ [0, 0, 1, 0, 0, 0, ...]  (ç¬¬3ä¸ªè¯)
"è‹¹æœ"  â†’ [0, 0, 0, 1, 0, 0, ...]  (ç¬¬4ä¸ªè¯)
```

**ç¼ºç‚¹**ï¼š
1. **å¤ªé•¿äº†**ï¼šè¯æ±‡è¡¨æœ‰50,000ä¸ªè¯ï¼Œæ¯ä¸ªè¯å˜æˆ50,000ç»´å‘é‡ï¼
2. **æ²¡æœ‰è¯­ä¹‰**ï¼š"è‹¹æœ"å’Œ"é¦™è•‰"æ˜æ˜éƒ½æ˜¯æ°´æœï¼Œä½†å‘é‡å®Œå…¨ä¸ç›¸ä¼¼

## ä¸‰ã€åµŒå…¥å±‚çš„è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€æƒ³ï¼šæŠŠè¯å˜æˆ**æµ“ç¼©çš„æ•°å­—å‘é‡**ï¼Œç›¸ä¼¼çš„è¯å‘é‡ä¹Ÿç›¸ä¼¼

```
æŠŠé«˜ç»´ç¨€ç–å‘é‡ â†’ å‹ç¼©æˆ â†’ ä½ç»´ç¨ å¯†å‘é‡

"è‹¹æœ"  [0,0,0,1,0,0,...]  â†’  [0.2, -0.5, 0.8, 0.1, ...]  (åªæœ‰768ä¸ªæ•°å­—)
        â†‘ 50,000ä¸ªæ•°å­—              â†‘ 768ä¸ªæ•°å­—
        (åªæœ‰1ä¸ªæ˜¯1)                (æ¯ä¸ªéƒ½æœ‰æ„ä¹‰)
```

## å››ã€ç”Ÿæ´»åŒ–ç±»æ¯”

### ç±»æ¯”1ï¼šè¶…å¸‚å•†å“ç¼–ç 

**ä¼ ç»Ÿç¼–å·**ï¼ˆåƒç‹¬çƒ­ç¼–ç ï¼‰ï¼š
- è‹¹æœ = è´§æ¶1åŒº3å·
- é¦™è•‰ = è´§æ¶5åŒº7å·
- å®Œå…¨çœ‹ä¸å‡ºå®ƒä»¬éƒ½æ˜¯æ°´æœ

**åµŒå…¥ç¼–ç **ï¼ˆåƒ Embeddingï¼‰ï¼š
```
è‹¹æœï¼š[æ°´æœåº¦:0.9, ç”œåº¦:0.7, ä»·æ ¼:0.3, çº¢è‰²:0.8, åœ†å½¢:0.9]
é¦™è•‰ï¼š[æ°´æœåº¦:0.9, ç”œåº¦:0.8, ä»·æ ¼:0.2, çº¢è‰²:0.1, åœ†å½¢:0.3]
ç‰›å¥¶ï¼š[æ°´æœåº¦:0.1, ç”œåº¦:0.3, ä»·æ ¼:0.5, çº¢è‰²:0.0, åœ†å½¢:0.0]
```

ç°åœ¨ä¸€çœ¼çœ‹å‡ºï¼š**è‹¹æœå’Œé¦™è•‰å¾ˆåƒ**ï¼ˆå‰3ä¸ªæ•°å­—æ¥è¿‘ï¼‰ï¼Œéƒ½å’Œç‰›å¥¶ä¸åŒï¼

### ç±»æ¯”2ï¼šäººçš„ç‰¹å¾

ä¸åŒçš„äººå¯ä»¥ç”¨å¤šä¸ªç»´åº¦æè¿°ï¼š

```
å¼ ä¸‰ï¼š[èº«é«˜:180, ä½“é‡:70, å¹´é¾„:25, å¹½é»˜:8, å†…å‘:3]
æå››ï¼š[èº«é«˜:175, ä½“é‡:68, å¹´é¾„:26, å¹½é»˜:7, å†…å‘:4]
ç‹äº”ï¼š[èº«é«˜:160, ä½“é‡:90, å¹´é¾„:50, å¹½é»˜:2, å†…å‘:9]
```

å¼ ä¸‰å’Œæå››"è·ç¦»"å¾ˆè¿‘ï¼ˆç›¸ä¼¼ï¼‰ï¼Œéƒ½å’Œç‹äº”å·®å¼‚å¤§ã€‚

## äº”ã€ä»£ç é‡Œæ€ä¹ˆåšçš„ï¼Ÿ

### çœ‹ GPT-2 çš„åµŒå…¥å±‚ä»£ç ï¼š

```c
void encoder_forward(float* out,
                   int* inp,      // è¾“å…¥ï¼šè¯çš„IDç¼–å·
                   float* wte,    // TokenåµŒå…¥è¡¨
                   float* wpe,    // PositionåµŒå…¥è¡¨
                   int B, int T, int C) {
    
    for (int b = 0; b < B; b++) {
        for (int t = 0; t < T; t++) {
            int ix = inp[b * T + t];  // ç¬¬tä¸ªè¯çš„ID
            
            // ä»åµŒå…¥è¡¨é‡Œ"æŸ¥æ‰¾"è¿™ä¸ªè¯çš„å‘é‡
            float* wte_ix = wte + ix * C;     // è¯å‘é‡
            float* wpe_t = wpe + t * C;       // ä½ç½®å‘é‡
            
            // æŠŠä¸¤ä¸ªå‘é‡åŠ èµ·æ¥
            for (int i = 0; i < C; i++) {
                out[i] = wte_ix[i] + wpe_t[i];
            }
        }
    }
}
```

### å…·ä½“ä¾‹å­ï¼š

å‡è®¾ï¼š
- è¯æ±‡è¡¨å¤§å° V = 50,000
- åµŒå…¥ç»´åº¦ C = 768
- è¾“å…¥å¥å­ï¼š"æˆ‘çˆ±åƒè‹¹æœ"

**æ­¥éª¤1ï¼šåˆ†è¯å¹¶ç¼–å·**
```
"æˆ‘"    â†’ ID: 1234
"çˆ±"    â†’ ID: 5678
"åƒ"    â†’ ID: 9012
"è‹¹æœ"  â†’ ID: 3456
```

**æ­¥éª¤2ï¼šæŸ¥è¯¢åµŒå…¥è¡¨ï¼ˆwteï¼‰**
```
wte æ˜¯ä¸€ä¸ªå·¨å¤§çš„è¡¨æ ¼ï¼š50,000è¡Œ Ã— 768åˆ—

ID 1234 ("æˆ‘") â†’ æŸ¥è¡¨ â†’ [0.12, -0.45, 0.78, ..., 0.23]  (768ä¸ªæ•°å­—)
ID 5678 ("çˆ±") â†’ æŸ¥è¡¨ â†’ [0.56, 0.23, -0.34, ..., 0.89]
ID 9012 ("åƒ") â†’ æŸ¥è¡¨ â†’ [-0.23, 0.67, 0.12, ..., -0.45]
ID 3456 ("è‹¹æœ") â†’ æŸ¥è¡¨ â†’ [0.34, -0.12, 0.89, ..., 0.56]
```

**å°±åƒæŸ¥å­—å…¸**ï¼šç»™ä½ ä¸€ä¸ªè¯IDï¼Œä»è¡¨é‡Œæ‰¾åˆ°å¯¹åº”çš„768ä¸ªæ•°å­—ã€‚

## å…­ã€ä¸ºä»€ä¹ˆè¿˜è¦åŠ ä½ç½®ç¼–ç ï¼ˆwpeï¼‰ï¼Ÿ

### é—®é¢˜ï¼šé¡ºåºå¾ˆé‡è¦ï¼

```
"æˆ‘åƒäº†è‹¹æœ"  â‰   "è‹¹æœåƒäº†æˆ‘"
```

ä½†å¦‚æœåªç”¨è¯åµŒå…¥ï¼Œè¿™ä¸¤å¥è¯çš„å‘é‡é›†åˆæ˜¯ä¸€æ ·çš„ï¼

### è§£å†³æ–¹æ¡ˆï¼šåŠ ä¸Šä½ç½®ä¿¡æ¯

```
ç¬¬0ä¸ªä½ç½®çš„è¯ ("æˆ‘")    = è¯å‘é‡("æˆ‘")    + ä½ç½®å‘é‡(0)
ç¬¬1ä¸ªä½ç½®çš„è¯ ("åƒ")    = è¯å‘é‡("åƒ")    + ä½ç½®å‘é‡(1)
ç¬¬2ä¸ªä½ç½®çš„è¯ ("äº†")    = è¯å‘é‡("äº†")    + ä½ç½®å‘é‡(2)
ç¬¬3ä¸ªä½ç½®çš„è¯ ("è‹¹æœ")  = è¯å‘é‡("è‹¹æœ")  + ä½ç½®å‘é‡(3)
```

### å½¢è±¡ç†è§£ï¼š

**è¯åµŒå…¥**å‘Šè¯‰æ¨¡å‹ï¼š"è¿™æ˜¯ä»€ä¹ˆè¯"  
**ä½ç½®åµŒå…¥**å‘Šè¯‰æ¨¡å‹ï¼š"è¿™ä¸ªè¯åœ¨å¥å­çš„å“ªé‡Œ"

å°±åƒç»™æ¯ä¸ªäººè´´ä¸¤ä¸ªæ ‡ç­¾ï¼š
- æ ‡ç­¾1ï¼šå§“åï¼ˆè¯åµŒå…¥ï¼‰
- æ ‡ç­¾2ï¼šåº§ä½å·ï¼ˆä½ç½®åµŒå…¥ï¼‰

## ä¸ƒã€åµŒå…¥å±‚çš„"å­¦ä¹ "è¿‡ç¨‹

### åˆå§‹çŠ¶æ€ï¼šéšæœºæ•°

åˆšå¼€å§‹è®­ç»ƒæ—¶ï¼ŒåµŒå…¥è¡¨é‡Œéƒ½æ˜¯**éšæœºæ•°**ï¼š
```
"è‹¹æœ" â†’ [0.01, -0.23, 0.45, ...]  (éšæœºçš„)
"é¦™è•‰" â†’ [0.87, 0.12, -0.56, ...]  (å®Œå…¨ä¸ç›¸å…³)
```

### è®­ç»ƒåï¼šæœ‰æ„ä¹‰çš„å‘é‡

æ¨¡å‹è§è¿‡å¾ˆå¤šå¥å­ï¼š
- "æˆ‘å–œæ¬¢åƒ**è‹¹æœ**"
- "**è‹¹æœ**å¾ˆç”œ"
- "ä¹°äº†ä¸€ä¸ªçº¢**è‹¹æœ**"
- "**é¦™è•‰**ä¹Ÿå¾ˆç”œ"
- "**é¦™è•‰**æ˜¯é»„è‰²çš„"

**æ¨¡å‹æ…¢æ…¢å­¦åˆ°**ï¼š
```
"è‹¹æœ" â†’ [æ°´æœ:0.9, ç”œ:0.8, çº¢:0.7, åœ†:0.8, ...]
"é¦™è•‰" â†’ [æ°´æœ:0.9, ç”œ:0.8, çº¢:0.1, åœ†:0.2, ...]
"æ±½è½¦" â†’ [æ°´æœ:0.1, ç”œ:0.0, çº¢:0.3, åœ†:0.6, ...]
```

ç°åœ¨"è‹¹æœ"å’Œ"é¦™è•‰"çš„å‘é‡å¾ˆæ¥è¿‘äº†ï¼

## å…«ã€æ€»ç»“

### åµŒå…¥å±‚ = è¶…çº§å‹ç¼©çš„"è¯ç‰¹å¾è¡¨"

| æ¦‚å¿µ | é€šä¿—ç†è§£ |
|------|---------|
| **è¾“å…¥** | è¯çš„IDå·ï¼ˆå¦‚ 1234ï¼‰ |
| **åµŒå…¥è¡¨** | ä¸€ä¸ªå¤§å­—å…¸ï¼šID â†’ å‘é‡ |
| **è¾“å‡º** | 768ç»´å‘é‡ï¼ˆè¯çš„"DNA"ï¼‰ |
| **ä½œç”¨** | è®©è®¡ç®—æœºç†è§£è¯çš„"å«ä¹‰"å’Œ"ç›¸ä¼¼æ€§" |

### ä¸ºä»€ä¹ˆå«"åµŒå…¥"ï¼ˆEmbeddingï¼‰ï¼Ÿ

å› ä¸ºæŠŠ**é«˜ç»´ç¨€ç–ç©ºé—´**çš„è¯ï¼Œ**åµŒå…¥ï¼ˆembedï¼‰åˆ°ä½ç»´ç¨ å¯†ç©ºé—´**ï¼Œå°±åƒæŠŠä¸‰ç»´ç‰©ä½“çš„å½±å­æŠ•å½±åˆ°äºŒç»´å¹³é¢ä¸Šã€‚

### å…³é”®ç‚¹è®°ä½ï¼š

1. **åµŒå…¥ = æŸ¥è¡¨**ï¼šç»™è¯IDï¼ŒæŸ¥å‡ºä¸€ä¸²æ•°å­—
2. **ç›¸ä¼¼è¯çš„å‘é‡ç›¸è¿‘**ï¼šæ¨¡å‹è®­ç»ƒå‡ºæ¥çš„
3. **é™ç»´**ï¼š50,000ç»´ â†’ 768ç»´
4. **å¯å­¦ä¹ **ï¼šåµŒå…¥è¡¨çš„æ•°å­—ä¼šåœ¨è®­ç»ƒä¸­ä¸æ–­è°ƒæ•´

è¿™å°±æ˜¯åµŒå…¥å±‚çš„å…¨éƒ¨ç§˜å¯†ï¼ğŸ¯


# åˆ†è¯ç¼–å·å è¯å’Œidä¸€ä¸€å¯¹åº”å—ï¼Ÿ 768 æ˜¯æ¯ä¸ªåˆ†è¯çš„ç»´åº¦å—
# éå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†è§£ç­”

## ä¸€ã€è¯å’ŒIDæ˜¯ä¸€ä¸€å¯¹åº”çš„å—ï¼Ÿ

### ç­”æ¡ˆï¼š**æ˜¯çš„ï¼ä¸¥æ ¼ä¸€ä¸€å¯¹åº”**

åœ¨ GPT-2 ä¸­æœ‰ä¸€ä¸ª**å›ºå®šçš„è¯æ±‡è¡¨**ï¼ˆvocabularyï¼‰ï¼Œå°±åƒä¸€æœ¬å­—å…¸ï¼š

```
è¯æ±‡è¡¨ï¼ˆ50,257ä¸ªè¯ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯    â”‚   ID   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   "a"   â”‚    0   â”‚
â”‚   "the" â”‚    1   â”‚
â”‚   "I"   â”‚    2   â”‚
â”‚   "you" â”‚    3   â”‚
â”‚   ...   â”‚   ...  â”‚
â”‚ "apple" â”‚  1234  â”‚
â”‚ "banana"â”‚  5678  â”‚
â”‚   ...   â”‚   ...  â”‚
â”‚  "<END>"â”‚ 50256  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç‰¹ç‚¹ï¼š

1. **åŒå‘æ˜ å°„**ï¼š
   ```
   "apple" â†â†’ 1234  ï¼ˆæ°¸è¿œæ˜¯è¿™ä¸ªå¯¹åº”å…³ç³»ï¼‰
   ```

2. **å…¨å±€å”¯ä¸€**ï¼š
   - åŒä¸€ä¸ªè¯æ°¸è¿œå¯¹åº”åŒä¸€ä¸ªID
   - ä¸åŒçš„è¯å¯¹åº”ä¸åŒçš„ID

3. **å›ºå®šä¸å˜**ï¼š
   - è®­ç»ƒæ—¶ï¼šè¯è¡¨å›ºå®š
   - æ¨ç†æ—¶ï¼šè¯è¡¨å›ºå®š
   - æ¨¡å‹åŠ è½½æ—¶ï¼Œè¯è¡¨ä¸€èµ·åŠ è½½

### çœ‹ä»£ç éªŒè¯ï¼š

```c
// tokenizer.h é‡Œçš„ç»“æ„
typedef struct {
    char** vocab;           // è¯æ±‡è¡¨ï¼šID â†’ è¯
    int vocab_size;         // è¯æ±‡è¡¨å¤§å°
    // ... å…¶ä»–å­—æ®µ
} Tokenizer;

// ä½¿ç”¨æ—¶ï¼š
tokenizer_init(&tokenizer, "gpt2_tokenizer.bin");  // åŠ è½½å›ºå®šçš„è¯è¡¨
```

## äºŒã€768 æ˜¯æ¯ä¸ªåˆ†è¯çš„ç»´åº¦å—ï¼Ÿ

### ç­”æ¡ˆï¼š**æ˜¯çš„ï¼è¿™æ˜¯æ¯ä¸ªè¯çš„å‘é‡ç»´åº¦**

```c
typedef struct {
    int channels;  // 768 å°±å­˜åœ¨è¿™é‡Œï¼
} GPT2Config;
```

### è¯¦ç»†è§£é‡Šï¼š

#### 1. **åµŒå…¥è¡¨çš„ç»“æ„**

```c
float* wte;  // TokenåµŒå…¥è¡¨ï¼š(V, C) = (50257, 768)
```

å¯ä»¥æƒ³è±¡æˆä¸€ä¸ª**å·¨å¤§çš„è¡¨æ ¼**ï¼š

```
        ç»´åº¦0    ç»´åº¦1    ç»´åº¦2    ...   ç»´åº¦767
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
ID 0  â”‚  0.12    -0.45    0.78   ...    0.23  â”‚ â† "a" çš„å‘é‡
ID 1  â”‚  0.56     0.23   -0.34   ...    0.89  â”‚ â† "the" çš„å‘é‡
ID 2  â”‚ -0.23     0.67    0.12   ...   -0.45  â”‚ â† "I" çš„å‘é‡
...   â”‚   ...      ...     ...   ...     ...  â”‚
ID 1234â”‚ 0.34   -0.12    0.89   ...    0.56  â”‚ â† "apple" çš„å‘é‡
...   â”‚   ...      ...     ...   ...     ...  â”‚
ID 50256â”‚0.78    0.45   -0.23   ...    0.12  â”‚ â† æœ€åä¸€ä¸ªè¯
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                                      â†‘
     768ä¸ªæ•°å­—ï¼ˆæ¯ä¸ªè¯éƒ½æ˜¯è¿™ä¹ˆå¤šï¼‰
```

#### 2. **æŸ¥è¡¨è¿‡ç¨‹**

```c
int ix = inp[b * T + t];         // æ¯”å¦‚ ix = 1234 ("apple")
float* wte_ix = wte + ix * C;    // è·³åˆ°ç¬¬1234è¡Œï¼Œå–å‡º768ä¸ªæ•°å­—

// wte_ix ç°åœ¨æŒ‡å‘çš„å†…å­˜ï¼š
// [0.34, -0.12, 0.89, ..., 0.56]  â† 768ä¸ªfloat
```

#### 3. **å…·ä½“ä¾‹å­**

å‡è®¾è¾“å…¥å¥å­ï¼š**"I love apple"**

```
åˆ†è¯ + ç¼–å·ï¼š
"I"     â†’ ID: 2
"love"  â†’ ID: 3456
"apple" â†’ ID: 1234

æŸ¥è¯¢åµŒå…¥è¡¨ï¼š
ID 2    â†’ wte[2*768 åˆ° 3*768-1]    = [aâ‚€, aâ‚, ..., aâ‚‡â‚†â‚‡]  â† 768ä¸ªæ•°
ID 3456 â†’ wte[3456*768 åˆ° 3457*768-1] = [bâ‚€, bâ‚, ..., bâ‚‡â‚†â‚‡]  â† 768ä¸ªæ•°
ID 1234 â†’ wte[1234*768 åˆ° 1235*768-1] = [câ‚€, câ‚, ..., câ‚‡â‚†â‚‡]  â† 768ä¸ªæ•°
```

**ç»“æœ**ï¼š3ä¸ªè¯ â†’ 3ä¸ª768ç»´å‘é‡

## ä¸‰ã€ä¸ºä»€ä¹ˆæ˜¯ 768 ç»´ï¼Ÿ

### ä¸æ˜¯éšä¾¿é€‰çš„ï¼è¿™æ˜¯è®¾è®¡é€‰æ‹©

```
GPT-2 æ¨¡å‹å®¶æ—ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å‹    â”‚  å±‚æ•°   â”‚ å¤´æ•°   â”‚ ç»´åº¦ (C)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GPT-2 å° â”‚   12    â”‚  12    â”‚   768     â”‚  â† ä»£ç é‡Œçš„é…ç½®
â”‚ GPT-2 ä¸­ â”‚   24    â”‚  16    â”‚   1024    â”‚
â”‚ GPT-2 å¤§ â”‚   36    â”‚  20    â”‚   1280    â”‚
â”‚ GPT-2 XL â”‚   48    â”‚  25    â”‚   1600    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»´åº¦çš„å«ä¹‰ï¼š

å¯ä»¥æŠŠ 768 ç»´ç†è§£ä¸º **768 ç§ä¸åŒçš„"ç‰¹å¾"**ï¼š

```
"apple" çš„ 768 ç»´å‘é‡ï¼ˆæƒ³è±¡çš„ä¾‹å­ï¼‰ï¼š
[
  0.9,   â† ç»´åº¦0ï¼šæ˜¯å¦æ˜¯åè¯
  0.8,   â† ç»´åº¦1ï¼šæ˜¯å¦æ˜¯é£Ÿç‰©
  0.7,   â† ç»´åº¦2ï¼šç”œåº¦
  0.2,   â† ç»´åº¦3ï¼šæ˜¯å¦æ˜¯åŠ¨ç‰©
  -0.5,  â† ç»´åº¦4ï¼šè´Ÿé¢æƒ…ç»ªç¨‹åº¦
  ...    â† è¿˜æœ‰ 763 ä¸ªç»´åº¦
  0.3    â† ç»´åº¦767ï¼šæŸç§æŠ½è±¡ç‰¹å¾
]
```

è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“æ¯ä¸ªç»´åº¦å…·ä½“ä»£è¡¨ä»€ä¹ˆï¼Œä½†æ¨¡å‹ä¼šå­¦åˆ°æœ‰ç”¨çš„è¡¨ç¤ºï¼

## å››ã€å®Œæ•´æµç¨‹å¯è§†åŒ–

### ä»æ–‡æœ¬åˆ°å‘é‡çš„å…¨è¿‡ç¨‹ï¼š

```
è¾“å…¥æ–‡æœ¬ï¼š
"I love apple"

â†“ æ­¥éª¤1ï¼šåˆ†è¯ï¼ˆTokenizationï¼‰

Tokens:
["I", "love", "apple"]

â†“ æ­¥éª¤2ï¼šè½¬IDï¼ˆå›ºå®šæ˜ å°„ï¼‰

IDs:
[2, 3456, 1234]

â†“ æ­¥éª¤3ï¼šæŸ¥åµŒå…¥è¡¨ï¼ˆæ¯ä¸ªID â†’ 768ç»´å‘é‡ï¼‰

Embeddings:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "I":    [0.12, -0.45, ..., 0.23]  (768)â”‚
â”‚ "love": [0.56,  0.23, ..., 0.89]  (768)â”‚
â”‚ "apple":[0.34, -0.12, ..., 0.56]  (768)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†“ æ­¥éª¤4ï¼šåŠ ä½ç½®ç¼–ç 

æœ€ç»ˆè¾“å…¥åˆ°æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ç½®0: [0.12, -0.45, ...] + [posâ‚€ç‰¹å¾]    â”‚
â”‚ ä½ç½®1: [0.56,  0.23, ...] + [posâ‚ç‰¹å¾]    â”‚
â”‚ ä½ç½®2: [0.34, -0.12, ...] + [posâ‚‚ç‰¹å¾]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿›å…¥ Transformer å±‚å¤„ç†...
```

## äº”ã€ä»£ç ä¸­çš„å®é™…å­˜å‚¨

### å†…å­˜å¸ƒå±€ï¼š

```c
// åµŒå…¥è¡¨åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼š
float* wte = malloc(50257 * 768 * sizeof(float));

// æ’åˆ—æ–¹å¼ï¼š
// [è¯0çš„768ä¸ªæ•°, è¯1çš„768ä¸ªæ•°, è¯2çš„768ä¸ªæ•°, ..., è¯50256çš„768ä¸ªæ•°]
//  â†‘____________â†‘  â†‘____________â†‘
//    768ä¸ªfloat      768ä¸ªfloat
```

### è®¿é—®æ–¹å¼ï¼š

```c
// è·å–è¯ID=1234çš„åµŒå…¥å‘é‡
int word_id = 1234;
int embedding_dim = 768;

float* word_vector = wte + word_id * embedding_dim;
// ç°åœ¨ word_vector[0] åˆ° word_vector[767] å°±æ˜¯è¿™ä¸ªè¯çš„768ä¸ªç‰¹å¾
```

## å…­ã€æ€»ç»“

### å…³é”®ç‚¹ï¼š

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **è¯å’ŒIDå¯¹åº”å…³ç³»** | ä¸€ä¸€å¯¹åº”ï¼Œå›ºå®šä¸å˜ |
| **768çš„å«ä¹‰** | æ¯ä¸ªè¯çš„å‘é‡ç»´åº¦ï¼ˆç‰¹å¾æ•°é‡ï¼‰ |
| **è¯æ±‡è¡¨å¤§å°** | 50,257 ä¸ªä¸åŒçš„è¯/å­è¯ |
| **åµŒå…¥è¡¨å¤§å°** | 50,257 Ã— 768 = 38,597,376 ä¸ªå‚æ•° |

### å½¢è±¡è®°å¿†ï¼š

```
è¯æ±‡è¡¨ = ä¸€æœ¬å­—å…¸ï¼ˆ50,257ä¸ªè¯æ¡ï¼‰
æ¯ä¸ªè¯æ¡ = ä¸€ä¸ªèº«ä»½è¯ï¼ˆIDå·ï¼‰
åµŒå…¥å‘é‡ = æ¯ä¸ªäººçš„768é¡¹ä½“æ£€æŠ¥å‘Š
```

æ¯æ¬¡è¾“å…¥ä¸€ä¸ªè¯ï¼Œå°±ï¼š
1. æŸ¥å­—å…¸æ‰¾åˆ°IDï¼ˆå›ºå®šæ˜ å°„ï¼‰
2. æ ¹æ®IDæ‰¾åˆ°å¯¹åº”çš„768é¡¹"ä½“æ£€æ•°æ®"
3. æŠŠè¿™768ä¸ªæ•°å­—äº¤ç»™æ¨¡å‹å¤„ç†

è¿™å°±æ˜¯åµŒå…¥å±‚çš„å®Œæ•´å·¥ä½œæµç¨‹ï¼âœ¨

# ä½ç½®ç¼–ç æ•°æ®å­˜åˆ°å“ªé‡Œï¼Ÿ

# ä½ç½®ç¼–ç å­˜å‚¨ä½ç½®è¯¦è§£

## ä¸€ã€ç›´æ¥ç­”æ¡ˆï¼šå­˜åœ¨ `wpe` å‚æ•°é‡Œ

### çœ‹ä»£ç ä¸­çš„å®šä¹‰ï¼š

```c
typedef struct {
    float* wte;  // TokenåµŒå…¥è¡¨ (V, C) = (50257, 768)
    float* wpe;  // PositionåµŒå…¥è¡¨ (maxT, C) = (1024, 768) â† ä½ç½®ç¼–ç åœ¨è¿™ï¼
    float* ln1w; // ...å…¶ä»–å‚æ•°
    // ...
} ParameterTensors;
```

## äºŒã€wpe çš„ç»“æ„è¯¦è§£

### 1. **å¤§å°å’Œå½¢çŠ¶**

```c
// åœ¨é…ç½®ä¸­ï¼š
model->config.max_seq_len = 1024;  // æœ€å¤§åºåˆ—é•¿åº¦
model->config.channels = 768;       // å‘é‡ç»´åº¦

// wpe çš„å¤§å°ï¼š
size_t wpe_size = maxT * C = 1024 * 768 = 786,432 ä¸ªfloat
```

### 2. **å­˜å‚¨å¸ƒå±€**

wpe æ˜¯ä¸€ä¸ª**äºŒç»´è¡¨æ ¼**ï¼Œåœ¨å†…å­˜ä¸­è¿ç»­å­˜å‚¨ï¼š

```
wpe çš„ç»“æ„ï¼š(1024, 768)

        ç»´åº¦0    ç»´åº¦1    ç»´åº¦2    ...   ç»´åº¦767
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
ä½ç½®0  â”‚  0.01    0.23   -0.45   ...    0.67  â”‚ â† ä½ç½®0çš„ç¼–ç å‘é‡
ä½ç½®1  â”‚  0.12   -0.34    0.56   ...   -0.23  â”‚ â† ä½ç½®1çš„ç¼–ç å‘é‡
ä½ç½®2  â”‚ -0.45    0.78    0.12   ...    0.89  â”‚ â† ä½ç½®2çš„ç¼–ç å‘é‡
ä½ç½®3  â”‚  0.34   -0.12    0.90   ...   -0.56  â”‚
...    â”‚   ...     ...     ...   ...     ...  â”‚
ä½ç½®1023â”‚ 0.78    0.45   -0.23   ...    0.12  â”‚ â† ä½ç½®1023çš„ç¼–ç å‘é‡
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                                      â†‘
     æ¯ä¸ªä½ç½®éƒ½æœ‰768ä¸ªæ•°å­—
```

### 3. **å†…å­˜ä¸­çš„æ ·å­**

```c
// è¿ç»­çš„å†…å­˜å—ï¼š
float* wpe = malloc(1024 * 768 * sizeof(float));

// æ’åˆ—ï¼š
// [ä½ç½®0çš„768ä¸ªæ•°, ä½ç½®1çš„768ä¸ªæ•°, ..., ä½ç½®1023çš„768ä¸ªæ•°]
//  â†‘____________â†‘  â†‘____________â†‘
//    768ä¸ªfloat      768ä¸ªfloat
```

## ä¸‰ã€å¦‚ä½•ä½¿ç”¨ä½ç½®ç¼–ç 

### åœ¨å‰å‘ä¼ æ’­ä¸­çš„ä»£ç ï¼š

```c
void encoder_forward(float* out,
                   int* inp,      // è¾“å…¥token IDs
                   float* wte,    // tokenåµŒå…¥è¡¨
                   float* wpe,    // positionåµŒå…¥è¡¨ â† è¿™é‡Œï¼
                   int B, int T, int C) {
    
    for (int b = 0; b < B; b++) {
        for (int t = 0; t < T; t++) {  // t å°±æ˜¯ä½ç½®ï¼š0, 1, 2, ...
            float* out_bt = out + b * T * C + t * C;
            
            // 1. è·å–tokenåµŒå…¥
            int ix = inp[b * T + t];        // token ID
            float* wte_ix = wte + ix * C;   // æŸ¥tokenè¡¨
            
            // 2. è·å–ä½ç½®åµŒå…¥
            float* wpe_t = wpe + t * C;     // æŸ¥ä½ç½®è¡¨ â† å…³é”®è¡Œï¼
            //                   â†‘
            //              ä½ç½®ç´¢å¼• t
            
            // 3. ç›¸åŠ 
            for (int i = 0; i < C; i++) {
                out_bt[i] = wte_ix[i] + wpe_t[i];
            }
        }
    }
}
```

### å…·ä½“ä¾‹å­ï¼š

å‡è®¾è¾“å…¥åºåˆ—ï¼š**"I love apple"**ï¼ˆ3ä¸ªè¯ï¼‰

```
ä½ç½®0: "I"
ä½ç½®1: "love"  
ä½ç½®2: "apple"

å¤„ç†è¿‡ç¨‹ï¼š

ä½ç½®0 çš„ "I":
  tokenå‘é‡ = wte[2]           = wte + 2*768    = [aâ‚€, aâ‚, ..., aâ‚‡â‚†â‚‡]
  ä½ç½®å‘é‡ = wpe[0]           = wpe + 0*768    = [pâ‚€, pâ‚, ..., pâ‚‡â‚†â‚‡]
  æœ€ç»ˆå‘é‡ = [aâ‚€+pâ‚€, aâ‚+pâ‚, ..., aâ‚‡â‚†â‚‡+pâ‚‡â‚†â‚‡]

ä½ç½®1 çš„ "love":
  tokenå‘é‡ = wte[3456]        = wte + 3456*768 = [bâ‚€, bâ‚, ..., bâ‚‡â‚†â‚‡]
  ä½ç½®å‘é‡ = wpe[1]           = wpe + 1*768    = [qâ‚€, qâ‚, ..., qâ‚‡â‚†â‚‡]
  æœ€ç»ˆå‘é‡ = [bâ‚€+qâ‚€, bâ‚+qâ‚, ..., bâ‚‡â‚†â‚‡+qâ‚‡â‚†â‚‡]

ä½ç½®2 çš„ "apple":
  tokenå‘é‡ = wte[1234]        = wte + 1234*768 = [câ‚€, câ‚, ..., câ‚‡â‚†â‚‡]
  ä½ç½®å‘é‡ = wpe[2]           = wpe + 2*768    = [râ‚€, râ‚, ..., râ‚‡â‚†â‚‡]
  æœ€ç»ˆå‘é‡ = [câ‚€+râ‚€, câ‚+râ‚, ..., câ‚‡â‚†â‚‡+râ‚‡â‚†â‚‡]
```

## å››ã€ä½ç½®ç¼–ç ä»å“ªé‡Œæ¥ï¼Ÿ

### 1. **åˆå§‹åŒ–ï¼šä»æ£€æŸ¥ç‚¹æ–‡ä»¶åŠ è½½**

```c
void gpt2_build_from_checkpoint(GPT2 *model, const char* checkpoint_path) {
    FILE *model_file = fopen(checkpoint_path, "rb");
    
    // è¯»å–å‚æ•°å¤§å°é…ç½®
    fill_in_parameter_sizes(model->param_sizes, model->config);
    
    // åˆ†é…å†…å­˜
    model->params_memory = malloc_and_point_parameters(&model->params, model->param_sizes);
    
    // ä»æ–‡ä»¶è¯»å–æ‰€æœ‰å‚æ•°ï¼ˆåŒ…æ‹¬ wpeï¼‰
    fread(model->params_memory, sizeof(float), num_parameters, model_file);
    //     â†‘
    // wpe çš„æ•°æ®ä¹Ÿåœ¨è¿™é‡Œé¢ï¼
}
```

### 2. **å‚æ•°åˆ†é…çš„é¡ºåº**

```c
void fill_in_parameter_sizes(size_t* param_sizes, GPT2Config config) {
    size_t Vp = config.padded_vocab_size;  // 50304
    size_t C = config.channels;            // 768
    size_t maxT = config.max_seq_len;      // 1024
    size_t L = config.num_layers;          // 12
    
    param_sizes[0] = Vp * C;       // wte: 50304 * 768
    param_sizes[1] = maxT * C;     // wpe: 1024 * 768 â† ä½ç½®ç¼–ç åœ¨è¿™ï¼
    param_sizes[2] = L * C;        // ln1w: 12 * 768
    // ... å…¶ä»–å‚æ•°
}
```

### 3. **æŒ‡é’ˆæŒ‡å‘**

```c
float* malloc_and_point_parameters(ParameterTensors* params, size_t* param_sizes) {
    // åˆ†é…ä¸€å¤§å—è¿ç»­å†…å­˜
    float* params_memory = malloc(total_size * sizeof(float));
    
    // ä¾æ¬¡æŒ‡å‘å„éƒ¨åˆ†
    float* ptr = params_memory;
    
    params->wte = ptr;                    // wte åœ¨æœ€å‰é¢
    ptr += param_sizes[0];                // è·³è¿‡ wte
    
    params->wpe = ptr;                    // wpe åœ¨ wte åé¢ â† è¿™é‡Œï¼
    ptr += param_sizes[1];                // è·³è¿‡ wpe
    
    params->ln1w = ptr;                   // æ¥ä¸‹æ¥æ˜¯ ln1w
    // ...
}
```

## äº”ã€å†…å­˜å¸ƒå±€å¯è§†åŒ–

### æ•´ä¸ª params_memory çš„å¸ƒå±€ï¼š

```
params_memory (ä¸€å¤§å—è¿ç»­å†…å­˜):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  wte (50304Ã—768)  â”‚  wpe (1024Ã—768)  â”‚  ln1w  â”‚ ... â”‚
â”‚  â†‘                â”‚  â†‘                â”‚               â”‚
â”‚  TokenåµŒå…¥è¡¨       â”‚  PositionåµŒå…¥è¡¨   â”‚  å…¶ä»–å‚æ•°      â”‚
â”‚                   â”‚                   â”‚               â”‚
â”‚  38,633,472ä¸ªfloatâ”‚  786,432ä¸ªfloat   â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘                   â†‘
  params->wte         params->wpe
```

### è®¿é—® wpe çš„ä»£ç ï¼š

```c
// è·å–ä½ç½® t çš„ç¼–ç å‘é‡
int position = t;           // æ¯”å¦‚ position = 5
int C = 768;

float* position_vector = model->params.wpe + position * C;
// position_vector[0] åˆ° position_vector[767] å°±æ˜¯ä½ç½®5çš„768ç»´å‘é‡
```

## å…­ã€ä½ç½®ç¼–ç çš„ç‰¹ç‚¹

### 1. **å¯å­¦ä¹ çš„å‚æ•°**

GPT-2 çš„ä½ç½®ç¼–ç æ˜¯**å¯å­¦ä¹ çš„**ï¼ˆä¸æ˜¯å›ºå®šçš„æ­£å¼¦å‡½æ•°ï¼‰ï¼š

```c
// åœ¨è®­ç»ƒæ—¶ï¼Œwpe çš„å€¼ä¼šæ›´æ–°
void gpt2_backward(GPT2 *model) {
    // ...
    encoder_backward(grads.wte, grads.wpe, grads_acts.encoded, model->inputs, B, T, C);
    //                          â†‘
    //                    wpe ä¹Ÿä¼šå¾—åˆ°æ¢¯åº¦ï¼
}

void gpt2_update(GPT2 *model, float learning_rate, ...) {
    // wpe å’Œå…¶ä»–å‚æ•°ä¸€èµ·æ›´æ–°
    for (size_t i = 0; i < model->num_parameters; i++) {
        model->params_memory[i] -= learning_rate * gradient[i];
        //                         â†‘
        //                   wpe çš„å‚æ•°ä¹Ÿåœ¨è¿™é‡Œæ›´æ–°
    }
}
```

### 2. **æœ€å¤§é•¿åº¦é™åˆ¶**

```c
// åªæœ‰ 1024 ä¸ªä½ç½®çš„ç¼–ç 
model->config.max_seq_len = 1024;

// æ‰€ä»¥è¾“å…¥åºåˆ—ä¸èƒ½è¶…è¿‡ 1024 ä¸ªtoken
if (T > 1024) {
    // é”™è¯¯ï¼æ²¡æœ‰ä½ç½®1024, 1025, ... çš„ç¼–ç 
}
```

### 3. **ä½ç½®ç¼–ç çš„å¤ç”¨**

```
åŒä¸€ä¸ªä½ç½®ï¼Œæ— è®ºä»€ä¹ˆè¯ï¼Œéƒ½ç”¨ç›¸åŒçš„ä½ç½®ç¼–ç ï¼š

"I love apple"     ä½ç½®0ç”¨ wpe[0]
"The cat sleeps"   ä½ç½®0ä¹Ÿç”¨ wpe[0]

"I love apple"     ä½ç½®1ç”¨ wpe[1]  
"The cat sleeps"   ä½ç½®1ä¹Ÿç”¨ wpe[1]
```

## ä¸ƒã€å®Œæ•´æ•°æ®æµ

```
åŠ è½½æ¨¡å‹ï¼š
gpt2_124M.bin æ–‡ä»¶
    â†“
è¯»å…¥å†…å­˜: params_memory
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ wte[50304Ã—768] â”‚ wpe[1024Ã—768] â”‚ ...â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                â†“
    params.wte      params.wpe
    
å‰å‘ä¼ æ’­ï¼š
è¾“å…¥: "I love apple" â†’ IDs: [2, 3456, 1234]
    â†“
ä½ç½®0: wte[2] + wpe[0] â†’ 768ç»´å‘é‡
ä½ç½®1: wte[3456] + wpe[1] â†’ 768ç»´å‘é‡
ä½ç½®2: wte[1234] + wpe[2] â†’ 768ç»´å‘é‡
    â†“
è¿›å…¥ Transformer å±‚...
```

## å…«ã€æ€»ç»“

### å…³é”®ç‚¹ï¼š

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **ä½ç½®ç¼–ç å­˜å“ª** | `params.wpe` æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ |
| **å¤§å°** | 1024 Ã— 768 = 786,432 ä¸ªfloat |
| **åœ¨æ–‡ä»¶ä¸­** | ç´§è·Ÿåœ¨ wte ä¹‹å |
| **ä½¿ç”¨æ–¹å¼** | `wpe + position * 768` æŸ¥è¡¨ |
| **æ˜¯å¦å¯å­¦ä¹ ** | æ˜¯ï¼è®­ç»ƒæ—¶ä¼šæ›´æ–° |

### è®°å¿†è¦ç‚¹ï¼š

```
wpe = "Where Position Encoding"ï¼ˆä½ç½®ç¼–ç åœ¨å“ªé‡Œï¼‰
      â†“
  ä¸€ä¸ª (1024, 768) çš„æŸ¥æ‰¾è¡¨
      â†“
  æ ¹æ®ä½ç½®ç´¢å¼•æŸ¥è¯¢å¯¹åº”çš„768ç»´å‘é‡
```

å°±åƒ wte æ˜¯"è¯çš„å­—å…¸"ï¼Œwpe æ˜¯"ä½ç½®çš„å­—å…¸"ï¼ğŸ“


# wte å…¨å±€åªæœ‰ä¸€ä»½ï¼Œè€Œwpeæ¯ä¸ªå¥å­æœ‰ä¸€ä»½å¯¹å§

# ä¸å¯¹ï¼è®©æˆ‘çº æ­£è¿™ä¸ªç†è§£

## ä¸€ã€æ ¸å¿ƒç­”æ¡ˆï¼šwte å’Œ wpe **éƒ½æ˜¯å…¨å±€å”¯ä¸€**çš„ï¼

### **é‡è¦ç»“è®º**ï¼š
- **wte**ï¼šå…¨å±€åªæœ‰ä¸€ä»½ âœ…
- **wpe**ï¼šå…¨å±€ä¹Ÿåªæœ‰ä¸€ä»½ âœ…ï¼ˆ**ä¸æ˜¯æ¯ä¸ªå¥å­ä¸€ä»½**ï¼‰

## äºŒã€ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªè¯¯è§£ï¼Ÿ

### è®©æˆ‘ä»¬çœ‹çœ‹å®é™…çš„å­˜å‚¨ç»“æ„ï¼š

```c
typedef struct {
    // æ¨¡å‹å‚æ•°ï¼ˆå…¨å±€å”¯ä¸€ï¼Œæ‰€æœ‰è¾“å…¥å…±äº«ï¼‰
    ParameterTensors params;
    float* params_memory;        // æ‰€æœ‰å‚æ•°çš„å†…å­˜
    
    // æ¿€æ´»å€¼ï¼ˆæ¯æ¬¡å‰å‘ä¼ æ’­äº§ç”Ÿçš„ä¸­é—´ç»“æœï¼‰
    ActivationTensors acts;
    float* acts_memory;          // æ¯æ¬¡å‰å‘ä¼ æ’­çš„ä¸´æ—¶æ•°æ®
    
} GPT2;
```

### å‚æ•° vs æ¿€æ´»å€¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ¨¡å‹å‚æ•° (Parameters)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   wte    â”‚   wpe    â”‚  ln1w   â”‚  ...  â”‚    â”‚
â”‚  â”‚(50304Ã—768)â”‚(1024Ã—768)â”‚         â”‚       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â†‘                                              â”‚
â”‚  å…¨å±€å”¯ä¸€ï¼Œæ‰€æœ‰è¾“å…¥å…±äº«ï¼Œä»æ–‡ä»¶åŠ è½½             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ¿€æ´»å€¼ (Activations)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ encoded  â”‚   ln1    â”‚  atty   â”‚  ...  â”‚    â”‚
â”‚  â”‚ (B,T,C)  â”‚ (L,B,T,C)â”‚(L,B,T,C)â”‚       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â†‘                                              â”‚
â”‚  æ¯æ¬¡å‰å‘ä¼ æ’­äº§ç”Ÿï¼Œå­˜å‚¨å½“å‰æ‰¹æ¬¡çš„è®¡ç®—ç»“æœ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸‰ã€wpe å¦‚ä½•è¢«å¤ç”¨ï¼Ÿ

### çœ‹å®é™…ä»£ç ï¼š

```c
void encoder_forward(float* out,
                   int* inp,      // è¾“å…¥ï¼šä¸åŒå¥å­çš„token IDs
                   float* wte,    // å‚æ•°ï¼šå…¨å±€å”¯ä¸€çš„tokenè¡¨
                   float* wpe,    // å‚æ•°ï¼šå…¨å±€å”¯ä¸€çš„ä½ç½®è¡¨ â† æ³¨æ„ï¼
                   int B, int T, int C) {
    
    for (int b = 0; b < B; b++) {      // å¤„ç†æ‰¹æ¬¡ä¸­çš„æ¯ä¸ªå¥å­
        for (int t = 0; t < T; t++) {  // å¤„ç†å¥å­ä¸­çš„æ¯ä¸ªä½ç½®
            
            // 1. æŸ¥è¯¢å…¨å±€å”¯ä¸€çš„ wpe
            float* wpe_t = wpe + t * C;  // åªä¾èµ–ä½ç½® tï¼Œä¸ä¾èµ–å¥å­ b
            //                   â†‘
            //              æ‰€æœ‰å¥å­çš„ä½ç½®téƒ½ç”¨åŒä¸€ä¸ªç¼–ç ï¼
            
            // 2. æŸ¥è¯¢å…¨å±€å”¯ä¸€çš„ wte
            int ix = inp[b * T + t];
            float* wte_ix = wte + ix * C;
            
            // 3. ç›¸åŠ å¾—åˆ°è¿™ä¸ªå¥å­è¿™ä¸ªä½ç½®çš„åµŒå…¥
            float* out_bt = out + b * T * C + t * C;
            for (int i = 0; i < C; i++) {
                out_bt[i] = wte_ix[i] + wpe_t[i];
            }
        }
    }
}
```

### å…³é”®è§‚å¯Ÿï¼š

```c
float* wpe_t = wpe + t * C;  // åªæœ‰ tï¼ˆä½ç½®ï¼‰ï¼Œæ²¡æœ‰ bï¼ˆå¥å­ï¼‰
```

**è¿™æ„å‘³ç€**ï¼š
- ç¬¬1ä¸ªå¥å­çš„ä½ç½®0ï¼šç”¨ `wpe[0]`
- ç¬¬2ä¸ªå¥å­çš„ä½ç½®0ï¼šä¹Ÿç”¨ `wpe[0]`
- ç¬¬3ä¸ªå¥å­çš„ä½ç½®0ï¼šè¿˜æ˜¯ç”¨ `wpe[0]`

**æ‰€æœ‰å¥å­å…±äº«åŒä¸€ä¸ª wpeï¼**

## å››ã€å…·ä½“ä¾‹å­

### æ‰¹æ¬¡å¤§å° B=3ï¼Œå¤„ç†3ä¸ªä¸åŒçš„å¥å­ï¼š

```
æ‰¹æ¬¡è¾“å…¥ï¼ˆB=3ï¼‰ï¼š
å¥å­1: "I love cats"      â†’ IDs: [2, 100, 200]
å¥å­2: "You hate dogs"    â†’ IDs: [5, 150, 250]  
å¥å­3: "We like birds"    â†’ IDs: [8, 180, 280]

ä½¿ç”¨çš„ wteï¼ˆæ¯ä¸ªå¥å­ä¸åŒï¼‰ï¼š
å¥å­1-ä½ç½®0: wte[2]    + wpe[0]
å¥å­1-ä½ç½®1: wte[100]  + wpe[1]
å¥å­1-ä½ç½®2: wte[200]  + wpe[2]

å¥å­2-ä½ç½®0: wte[5]    + wpe[0]  â† å’Œå¥å­1ç”¨åŒä¸€ä¸ª wpe[0]ï¼
å¥å­2-ä½ç½®1: wte[150]  + wpe[1]  â† å’Œå¥å­1ç”¨åŒä¸€ä¸ª wpe[1]ï¼
å¥å­2-ä½ç½®2: wte[250]  + wpe[2]  â† å’Œå¥å­1ç”¨åŒä¸€ä¸ª wpe[2]ï¼

å¥å­3-ä½ç½®0: wte[8]    + wpe[0]  â† è¿˜æ˜¯åŒä¸€ä¸ª wpe[0]ï¼
å¥å­3-ä½ç½®1: wte[180]  + wpe[1]
å¥å­3-ä½ç½®2: wte[280]  + wpe[2]
```

### å†…å­˜è§†å›¾ï¼š

```
å…¨å±€å‚æ•°ï¼ˆæ‰€æœ‰å¥å­å…±äº«ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ wpe (1024Ã—768)              â”‚
â”‚  [ä½ç½®0ç¼–ç ] â”€â”€â”€â”€â”€â”          â”‚
â”‚  [ä½ç½®1ç¼–ç ] â”€â”€â”  â”‚          â”‚
â”‚  [ä½ç½®2ç¼–ç ]   â”‚  â”‚          â”‚
â”‚  ...          â”‚  â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“  â†“  â†“
    æ‰€æœ‰å¥å­çš„ç›¸åŒä½ç½®éƒ½æŒ‡å‘è¿™é‡Œï¼

å½“å‰æ‰¹æ¬¡çš„æ¿€æ´»å€¼ï¼ˆæ¯ä¸ªå¥å­ç‹¬ç«‹ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ acts.encoded (3, 3, 768)    â”‚
â”‚                             â”‚
â”‚  å¥å­0: [pos0] [pos1] [pos2]â”‚ â† å„è‡ªæ˜¯ wte[?] + wpe[0/1/2]
â”‚  å¥å­1: [pos0] [pos1] [pos2]â”‚ â† å„è‡ªæ˜¯ wte[?] + wpe[0/1/2]
â”‚  å¥å­2: [pos0] [pos1] [pos2]â”‚ â† å„è‡ªæ˜¯ wte[?] + wpe[0/1/2]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äº”ã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### 1. **ä½ç½®ç¼–ç åº”è¯¥æ˜¯é€šç”¨çš„**

```
ä½ç½®çš„å«ä¹‰æ˜¯é€šç”¨çš„ï¼š
- "ç¬¬1ä¸ªä½ç½®" åœ¨ä»»ä½•å¥å­ä¸­éƒ½æ˜¯ "ç¬¬1ä¸ªä½ç½®"
- "ç¬¬5ä¸ªä½ç½®" åœ¨ä»»ä½•å¥å­ä¸­éƒ½æ˜¯ "ç¬¬5ä¸ªä½ç½®"

æ‰€ä»¥ä¸éœ€è¦æ¯ä¸ªå¥å­ä¸€ä»½ï¼
```

### 2. **èŠ‚çœå†…å­˜**

```
å¦‚æœæ¯ä¸ªå¥å­ä¸€ä»½ wpeï¼š
  æ¯æ‰¹æ¬¡ B=32, T=64
  éœ€è¦ï¼š32 Ã— 64 Ã— 768 = 1,572,864 ä¸ªfloat âœ—

å…¨å±€ä¸€ä»½ wpeï¼š
  åªéœ€è¦ï¼š1024 Ã— 768 = 786,432 ä¸ªfloat âœ“
  
è¿˜èƒ½å¤„ç†ä»»æ„çš„å¥å­ï¼
```

### 3. **ä¾¿äºå­¦ä¹ é€šç”¨æ¨¡å¼**

```
è®­ç»ƒæ—¶çœ‹åˆ°ï¼š
å¥å­A: "The cat sat on the mat"
å¥å­B: "A dog ran in the park"

ä½ç½®0 çš„æ¨¡å¼ï¼ˆå¼€å¤´è¯ï¼‰ï¼š
  - å¥å­A å’Œ B éƒ½ç”¨ wpe[0]
  - æ¨¡å‹å­¦åˆ° "å¥å­å¼€å¤´" çš„é€šç”¨ç‰¹å¾
  
å¦‚æœæ¯ä¸ªå¥å­ç‹¬ç«‹çš„ä½ç½®ç¼–ç ï¼Œå°±å­¦ä¸åˆ°é€šç”¨è§„å¾‹äº†ï¼
```

## å…­ã€é‚£ä»€ä¹ˆæ˜¯"æ¯ä¸ªå¥å­ä¸€ä»½"çš„ï¼Ÿ

### ç­”æ¡ˆï¼š**æ¿€æ´»å€¼**ï¼ˆActivationsï¼‰

```c
// è¿™äº›æ˜¯æ¯æ¬¡å‰å‘ä¼ æ’­è®¡ç®—å‡ºæ¥çš„ï¼Œæ¯ä¸ªå¥å­éƒ½ä¸åŒï¼š
typedef struct {
    float* encoded;    // (B, T, C) â† Bä¸ªå¥å­ï¼Œæ¯ä¸ªæœ‰è‡ªå·±çš„ç¼–ç ç»“æœ
    float* ln1;        // (L, B, T, C)
    float* qkv;        // (L, B, T, 3*C)
    float* att;        // (L, B, NH, T, T)
    // ...
} ActivationTensors;
```

### å¯¹æ¯”ï¼š

```
å‚æ•°ï¼ˆParametersï¼‰- å…¨å±€å”¯ä¸€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ wte, wpe, ln1w, qkvw, ...   â”‚
â”‚ ä»æ£€æŸ¥ç‚¹æ–‡ä»¶åŠ è½½              â”‚
â”‚ è®­ç»ƒæ—¶æ›´æ–°                    â”‚
â”‚ æ‰€æœ‰è¾“å…¥å…±äº«                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¿€æ´»å€¼ï¼ˆActivationsï¼‰- æ¯æ¬¡ä¸åŒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ encoded, ln1, qkv, att, ...  â”‚
â”‚ æ¯æ¬¡å‰å‘ä¼ æ’­è®¡ç®—              â”‚
â”‚ ä¾èµ–å½“å‰çš„è¾“å…¥                â”‚
â”‚ æ‰¹æ¬¡ä¸­æ¯ä¸ªå¥å­éƒ½ä¸åŒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸ƒã€è®­ç»ƒæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

### wpe æ˜¯å¦‚ä½•æ›´æ–°çš„ï¼š

```c
// æ­¥éª¤1ï¼šå‰å‘ä¼ æ’­ï¼ˆæ‰€æœ‰å¥å­å…±äº« wpeï¼‰
gpt2_forward(&model, inputs, targets, B, T);

// æ­¥éª¤2ï¼šåå‘ä¼ æ’­ï¼ˆè®¡ç®— wpe çš„æ¢¯åº¦ï¼‰
gpt2_backward(&model);
// æ‰€æœ‰å¥å­å¯¹ wpe çš„æ¢¯åº¦ä¼šç´¯åŠ ï¼

// åœ¨ encoder_backward ä¸­ï¼š
void encoder_backward(float* dwte, float* dwpe, ...) {
    for (int b = 0; b < B; b++) {      // éå†æ‰¹æ¬¡ä¸­çš„æ¯ä¸ªå¥å­
        for (int t = 0; t < T; t++) {  // éå†æ¯ä¸ªä½ç½®
            float* dwpe_t = dwpe + t * C;  // ä½ç½®tçš„æ¢¯åº¦
            for (int i = 0; i < C; i++) {
                dwpe_t[i] += dout_bt[i];   // ç´¯åŠ ï¼ä¸åŒå¥å­çš„æ¢¯åº¦åŠ åˆ°åŒä¸€ä¸ª wpe[t]
            }
        }
    }
}

// æ­¥éª¤3ï¼šæ›´æ–°å‚æ•°
gpt2_update(&model, learning_rate, ...);
// wpe æ ¹æ®ç´¯åŠ çš„æ¢¯åº¦æ›´æ–°
```

### æ¢¯åº¦ç´¯åŠ ç¤ºæ„ï¼š

```
æ‰¹æ¬¡æœ‰3ä¸ªå¥å­ï¼š

å¥å­1-ä½ç½®0 å¯¹ wpe[0] çš„æ¢¯åº¦: [0.1, 0.2, ...]
å¥å­2-ä½ç½®0 å¯¹ wpe[0] çš„æ¢¯åº¦: [0.3, 0.1, ...]
å¥å­3-ä½ç½®0 å¯¹ wpe[0] çš„æ¢¯åº¦: [0.2, 0.4, ...]
                              â†“ ç´¯åŠ 
              wpe[0] çš„æ€»æ¢¯åº¦: [0.6, 0.7, ...]

ç„¶åç”¨è¿™ä¸ªæ€»æ¢¯åº¦æ›´æ–° wpe[0]
```

## å…«ã€æ€»ç»“å¯¹æ¯”è¡¨

| ç‰¹æ€§ | wteï¼ˆTokenåµŒå…¥ï¼‰ | wpeï¼ˆPositionåµŒå…¥ï¼‰ |
|------|-----------------|-------------------|
| **æ•°é‡** | å…¨å±€å”¯ä¸€ä¸€ä»½ | å…¨å±€å”¯ä¸€ä¸€ä»½ |
| **å¤§å°** | (50304, 768) | (1024, 768) |
| **ç´¢å¼•æ–¹å¼** | æ ¹æ®è¯IDç´¢å¼• | æ ¹æ®ä½ç½®ç´¢å¼• |
| **æ˜¯å¦å…±äº«** | æ‰€æœ‰å¥å­å…±äº« | æ‰€æœ‰å¥å­å…±äº« |
| **æ˜¯å¦å¯å­¦ä¹ ** | æ˜¯ | æ˜¯ |
| **å­˜å‚¨ä½ç½®** | params_memory | params_memory |
| **æ¯ä¸ªå¥å­ä¸€ä»½ï¼Ÿ** | âŒ | âŒ |

### è®°å¿†å£è¯€ï¼š

```
wte å’Œ wpe æ˜¯æ¨¡å‹çš„"çŸ¥è¯†"
  â†“
çŸ¥è¯†æ˜¯é€šç”¨çš„ï¼Œä¸æ˜¯æ¯ä¸ªå¥å­ä¸€ä»½
  â†“
å°±åƒä¸€æœ¬å­—å…¸ï¼Œæ‰€æœ‰äººå…±ç”¨ä¸€æœ¬
  â†“
ä¸æ˜¯æ¯ä¸ªäººå¤å°ä¸€æœ¬ï¼
```

### çœŸæ­£"æ¯ä¸ªå¥å­ä¸€ä»½"çš„æ˜¯ï¼š

```
æ¿€æ´»å€¼ (acts.encoded, acts.ln1, ...)
  â†“
è¿™äº›æ˜¯è®¡ç®—ç»“æœï¼Œæ¯æ¬¡è¾“å…¥ä¸åŒï¼Œç»“æœå°±ä¸åŒ
  â†“
å°±åƒæ¯ä¸ªå­¦ç”Ÿçš„è€ƒå·ç­”æ¡ˆ
  â†“
çŸ¥è¯†ï¼ˆwte/wpeï¼‰æ˜¯å…±äº«çš„ï¼Œç­”æ¡ˆï¼ˆactsï¼‰æ˜¯å„è‡ªçš„ï¼
```

å¸Œæœ›è¿™æ¬¡å½»åº•æ¾„æ¸…äº†ï¼ğŸ˜Š



# æœ€ç»ˆå‘é‡ä¸­çš„æŸä¸ªå…ƒç´  aå’Œpç›¸åŠ åæ˜¯æ•°å€¼è¿˜æ˜¯å‘é‡

# éå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘å½»åº•è®²æ¸…æ¥š

## ä¸€ã€ç›´æ¥ç­”æ¡ˆï¼š**æ˜¯æ•°å€¼ï¼ˆæ ‡é‡ï¼‰ï¼Œä¸æ˜¯å‘é‡ï¼**

### çœ‹ä»£ç ï¼š

```c
for (int i = 0; i < C; i++) {
    out_bt[i] = wte_ix[i] + wpe_t[i];
    //   â†‘         â†‘           â†‘
    //  æ•°å€¼      æ•°å€¼        æ•°å€¼
    // (ä¸€ä¸ªfloat) (ä¸€ä¸ªfloat) (ä¸€ä¸ªfloat)
}
```

**æ¯æ¬¡å¾ªç¯å¤„ç†çš„æ˜¯ä¸€ä¸ª float æ•°å€¼ï¼**

## äºŒã€è¯¦ç»†æ‹†è§£

### å‡è®¾ C = 768ï¼ˆå‘é‡ç»´åº¦ï¼‰

```c
// wte_ix æŒ‡å‘ä¸€ä¸ª768ç»´å‘é‡çš„èµ·å§‹ä½ç½®
float* wte_ix = wte + token_id * 768;

// wpe_t æŒ‡å‘ä¸€ä¸ª768ç»´å‘é‡çš„èµ·å§‹ä½ç½®  
float* wpe_t = wpe + position * 768;

// out_bt æŒ‡å‘è¾“å‡º768ç»´å‘é‡çš„èµ·å§‹ä½ç½®
float* out_bt = out + ...;
```

### åœ¨å†…å­˜ä¸­çš„å®é™…å¸ƒå±€ï¼š

```
wte_ix æŒ‡å‘çš„å†…å­˜ï¼š
åœ°å€:    wte_ix[0]  wte_ix[1]  wte_ix[2]  ...  wte_ix[767]
å†…å®¹:      0.12      -0.45       0.78    ...     0.23
         â†‘ ä¸€ä¸ªfloat  â†‘ ä¸€ä¸ªfloat

wpe_t æŒ‡å‘çš„å†…å­˜ï¼š
åœ°å€:    wpe_t[0]   wpe_t[1]   wpe_t[2]   ...  wpe_t[767]
å†…å®¹:      0.05       0.10      -0.20    ...     0.15
         â†‘ ä¸€ä¸ªfloat  â†‘ ä¸€ä¸ªfloat

ç›¸åŠ çš„è¿‡ç¨‹ï¼š
i=0:  out_bt[0] = 0.12 + 0.05 = 0.17    â† æ•°å€¼ + æ•°å€¼ = æ•°å€¼
i=1:  out_bt[1] = -0.45 + 0.10 = -0.35  â† æ•°å€¼ + æ•°å€¼ = æ•°å€¼
i=2:  out_bt[2] = 0.78 + (-0.20) = 0.58 â† æ•°å€¼ + æ•°å€¼ = æ•°å€¼
...
i=767: out_bt[767] = 0.23 + 0.15 = 0.38 â† æ•°å€¼ + æ•°å€¼ = æ•°å€¼
```

## ä¸‰ã€å®Œæ•´çš„å…·ä½“ä¾‹å­

### å‡è®¾ç®€åŒ–ç‰ˆæœ¬ï¼šC = 5ï¼ˆåªæœ‰5ç»´ï¼Œæ–¹ä¾¿æ¼”ç¤ºï¼‰

```
è¾“å…¥è¯: "apple" (ID=1234)ï¼Œä½ç½®: 2

æ­¥éª¤1ï¼šæŸ¥è¯¢ token åµŒå…¥
wte_ix = wte + 1234 * 5
       = [0.1, 0.2, 0.3, 0.4, 0.5]
         â†‘    â†‘    â†‘    â†‘    â†‘
        5ä¸ªç‹¬ç«‹çš„floatæ•°å€¼

æ­¥éª¤2ï¼šæŸ¥è¯¢ä½ç½®åµŒå…¥  
wpe_t = wpe + 2 * 5
      = [0.01, 0.02, 0.03, 0.04, 0.05]
         â†‘     â†‘     â†‘     â†‘     â†‘
        5ä¸ªç‹¬ç«‹çš„floatæ•°å€¼

æ­¥éª¤3ï¼šé€å…ƒç´ ç›¸åŠ 
out_bt[0] = wte_ix[0] + wpe_t[0] = 0.1  + 0.01 = 0.11   â† æ•°å€¼
out_bt[1] = wte_ix[1] + wpe_t[1] = 0.2  + 0.02 = 0.22   â† æ•°å€¼
out_bt[2] = wte_ix[2] + wpe_t[2] = 0.3  + 0.03 = 0.33   â† æ•°å€¼
out_bt[3] = wte_ix[3] + wpe_t[3] = 0.4  + 0.04 = 0.44   â† æ•°å€¼
out_bt[4] = wte_ix[4] + wpe_t[4] = 0.5  + 0.05 = 0.55   â† æ•°å€¼

æœ€ç»ˆå‘é‡ï¼š
out_bt = [0.11, 0.22, 0.33, 0.44, 0.55]
          â†‘     â†‘     â†‘     â†‘     â†‘
         æ¯ä¸ªä½ç½®éƒ½æ˜¯ä¸€ä¸ªæ•°å€¼ï¼ˆfloatï¼‰
```

## å››ã€æ•°æ®ç±»å‹ç¡®è®¤

### åœ¨ C è¯­è¨€ä¸­ï¼š

```c
float* wte_ix;      // æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸²float
float* wpe_t;       // æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸²float
float* out_bt;      // æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸²float

// å¾ªç¯ä¸­ï¼š
for (int i = 0; i < C; i++) {
    // wte_ix[i] æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ
    float a = wte_ix[i];    // â† floatç±»å‹ï¼Œä¸€ä¸ªæ•°å€¼
    
    // wpe_t[i] æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ
    float p = wpe_t[i];     // â† floatç±»å‹ï¼Œä¸€ä¸ªæ•°å€¼
    
    // ç›¸åŠ 
    float result = a + p;   // â† float + float = float
    
    out_bt[i] = result;
}
```

### ç”¨ C è¯­è¨€æœ¯è¯­ï¼š

```
wte_ix        â†’ float* ç±»å‹ï¼ˆæŒ‡é’ˆï¼‰
wte_ix[i]     â†’ float ç±»å‹ï¼ˆæ•°å€¼/æ ‡é‡ï¼‰

wpe_t         â†’ float* ç±»å‹ï¼ˆæŒ‡é’ˆï¼‰
wpe_t[i]      â†’ float ç±»å‹ï¼ˆæ•°å€¼/æ ‡é‡ï¼‰

out_bt[i]     â†’ float ç±»å‹ï¼ˆæ•°å€¼/æ ‡é‡ï¼‰
```

## äº”ã€å‘é‡è¿ç®—çš„çœŸç›¸

### æ¦‚å¿µå±‚é¢ï¼šå‘é‡ç›¸åŠ 

```
ä»æ•°å­¦è§’åº¦è¯´ï¼Œæˆ‘ä»¬åœ¨åš"å‘é‡ç›¸åŠ "ï¼š

å‘é‡A = [aâ‚€, aâ‚, aâ‚‚, ..., aâ‚‡â‚†â‚‡]
å‘é‡B = [bâ‚€, bâ‚, bâ‚‚, ..., bâ‚‡â‚†â‚‡]
      â†“
å‘é‡C = [aâ‚€+bâ‚€, aâ‚+bâ‚, aâ‚‚+bâ‚‚, ..., aâ‚‡â‚†â‚‡+bâ‚‡â‚†â‚‡]
```

### å®ç°å±‚é¢ï¼šé€å…ƒç´ æ ‡é‡ç›¸åŠ 

```
è®¡ç®—æœºå†…éƒ¨æ˜¯è¿™æ ·åšçš„ï¼š

å¾ªç¯768æ¬¡ï¼Œæ¯æ¬¡åšä¸€ä¸ªæ ‡é‡åŠ æ³•ï¼š
  ç¬¬0æ¬¡: c[0] = a[0] + b[0]    â† æ•°å€¼åŠ æ³•
  ç¬¬1æ¬¡: c[1] = a[1] + b[1]    â† æ•°å€¼åŠ æ³•
  ç¬¬2æ¬¡: c[2] = a[2] + b[2]    â† æ•°å€¼åŠ æ³•
  ...
  ç¬¬767æ¬¡: c[767] = a[767] + b[767]  â† æ•°å€¼åŠ æ³•
```

### ç±»æ¯”ç†è§£ï¼š

```
å°±åƒè®¡ç®—ä¸¤ä¸ªäººçš„æ€»èµ„äº§ï¼š

å¼ ä¸‰ï¼š[ç°é‡‘:100, è‚¡ç¥¨:200, æˆ¿äº§:300]
æå››ï¼š[ç°é‡‘:50,  è‚¡ç¥¨:100, æˆ¿äº§:200]

ç›¸åŠ ï¼š
  ç°é‡‘æ€»è®¡: 100 + 50  = 150  â† æ•°å€¼åŠ æ•°å€¼
  è‚¡ç¥¨æ€»è®¡: 200 + 100 = 300  â† æ•°å€¼åŠ æ•°å€¼
  æˆ¿äº§æ€»è®¡: 300 + 200 = 500  â† æ•°å€¼åŠ æ•°å€¼

ç»“æœï¼š[ç°é‡‘:150, è‚¡ç¥¨:300, æˆ¿äº§:500]
```

## å…­ã€ä¸ºä»€ä¹ˆä¼šæœ‰ç–‘æƒ‘ï¼Ÿ

### å¯èƒ½æ˜¯å› ä¸ºè¿™ç§å†™æ³•ï¼š

```python
# Python/NumPy ä¸­å¯ä»¥è¿™æ ·å†™ï¼š
out = wte_vector + wpe_vector  # å‘é‡åŠ æ³•ï¼ˆè‡ªåŠ¨å¹¿æ’­ï¼‰

# ä½†åº•å±‚è¿˜æ˜¯é€å…ƒç´ çš„æ ‡é‡åŠ æ³•ï¼
# NumPy åªæ˜¯å¸®ä½ å†™äº†å¾ªç¯è€Œå·²
```

### C è¯­è¨€å¿…é¡»æ˜¾å¼å¾ªç¯ï¼š

```c
// C è¯­è¨€ä¸æ”¯æŒç›´æ¥çš„å‘é‡è¿ç®—
// out = wte_ix + wpe_t;  // âŒ é”™è¯¯ï¼ä¸èƒ½è¿™æ ·å†™

// å¿…é¡»æ‰‹åŠ¨å¾ªç¯
for (int i = 0; i < C; i++) {
    out[i] = wte_ix[i] + wpe_t[i];  // âœ“ æ­£ç¡®
}
```

## ä¸ƒã€å†…å­˜è§†è§’

### ç”»å‡ºçœŸå®çš„å†…å­˜å¸ƒå±€ï¼š

```
å‡è®¾ C=4ï¼ˆ4ç»´å‘é‡ï¼Œæ–¹ä¾¿æ¼”ç¤ºï¼‰

å†…å­˜åœ°å€:  0x1000   0x1004   0x1008   0x100C
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
wte_ix:  â”‚  0.1   â”‚  0.2   â”‚  0.3   â”‚  0.4   â”‚  â† 4ä¸ªè¿ç»­çš„float
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘ [0]    â†‘ [1]    â†‘ [2]    â†‘ [3]
          4å­—èŠ‚    4å­—èŠ‚    4å­—èŠ‚    4å­—èŠ‚

å†…å­˜åœ°å€:  0x2000   0x2004   0x2008   0x200C
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
wpe_t:   â”‚ 0.01   â”‚ 0.02   â”‚ 0.03   â”‚ 0.04   â”‚  â† 4ä¸ªè¿ç»­çš„float
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾ªç¯æ‰§è¡Œï¼š
i=0: ä»åœ°å€0x1000è¯»ä¸€ä¸ªfloat(0.1) + ä»åœ°å€0x2000è¯»ä¸€ä¸ªfloat(0.01) = 0.11
i=1: ä»åœ°å€0x1004è¯»ä¸€ä¸ªfloat(0.2) + ä»åœ°å€0x2004è¯»ä¸€ä¸ªfloat(0.02) = 0.22
i=2: ä»åœ°å€0x1008è¯»ä¸€ä¸ªfloat(0.3) + ä»åœ°å€0x2008è¯»ä¸€ä¸ªfloat(0.03) = 0.33
i=3: ä»åœ°å€0x100Cè¯»ä¸€ä¸ªfloat(0.4) + ä»åœ°å€0x200Cè¯»ä¸€ä¸ªfloat(0.04) = 0.44

ç»“æœå†™å…¥ï¼š
å†…å­˜åœ°å€:  0x3000   0x3004   0x3008   0x300C
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
out_bt:  â”‚  0.11  â”‚  0.22  â”‚  0.33  â”‚  0.44  â”‚  â† 4ä¸ªæ–°çš„float
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…«ã€å¯¹æ¯”å…¶ä»–ç¼–ç¨‹è¯­è¨€

### Python (NumPy):

```python
import numpy as np

wte_vector = np.array([0.1, 0.2, 0.3, 0.4])  # å‘é‡
wpe_vector = np.array([0.01, 0.02, 0.03, 0.04])  # å‘é‡

# çœ‹èµ·æ¥æ˜¯"å‘é‡ç›¸åŠ "
result = wte_vector + wpe_vector  
# ç»“æœ: [0.11, 0.22, 0.33, 0.44]

# ä½†åº•å±‚NumPyä¹Ÿæ˜¯å¾ªç¯æ¯ä¸ªå…ƒç´ åšæ ‡é‡åŠ æ³•ï¼
# åªæ˜¯è¯­æ³•ç³–è®©ä½ çœ‹ä¸åˆ°å¾ªç¯è€Œå·²
```

### C è¯­è¨€ï¼ˆä»£ç ä¸­çš„å®ç°ï¼‰:

```c
float wte_vector[4] = {0.1, 0.2, 0.3, 0.4};
float wpe_vector[4] = {0.01, 0.02, 0.03, 0.04};
float result[4];

// å¿…é¡»æ˜¾å¼å†™å¾ªç¯
for (int i = 0; i < 4; i++) {
    result[i] = wte_vector[i] + wpe_vector[i];  // æ ‡é‡åŠ æ³•
}
```

## ä¹ã€æ€»ç»“

### å…³é”®ç‚¹ï¼š

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **wte_ix[i] æ˜¯ä»€ä¹ˆ** | ä¸€ä¸ª float æ•°å€¼ï¼ˆæ ‡é‡ï¼‰ |
| **wpe_t[i] æ˜¯ä»€ä¹ˆ** | ä¸€ä¸ª float æ•°å€¼ï¼ˆæ ‡é‡ï¼‰ |
| **wte_ix[i] + wpe_t[i] æ˜¯ä»€ä¹ˆ** | æ•°å€¼ç›¸åŠ ï¼Œç»“æœæ˜¯æ•°å€¼ |
| **out_bt[i] æ˜¯ä»€ä¹ˆ** | å­˜å‚¨ç»“æœçš„ä¸€ä¸ª float æ•°å€¼ |
| **æ•´ä¸ªå‘é‡å‘¢** | 768ä¸ªæ•°å€¼ç»„æˆçš„æ•°ç»„ |

### å½¢è±¡è®°å¿†ï¼š

```
å‘é‡ = ä¸€æ’æ•°å­—ï¼ˆæ•°ç»„ï¼‰
å‘é‡çš„æ¯ä¸ªå…ƒç´  = å•ä¸ªæ•°å­—ï¼ˆæ ‡é‡ï¼‰

[0.1, 0.2, 0.3, 0.4]  â† è¿™æ˜¯å‘é‡ï¼ˆ4ä¸ªæ•°å­—çš„é›†åˆï¼‰
 â†‘    â†‘    â†‘    â†‘
æ¯ä¸ªéƒ½æ˜¯ä¸€ä¸ªæ•°å€¼ï¼ˆä¸æ˜¯å‘é‡ï¼‰

å‘é‡åŠ æ³• = å¯¹åº”ä½ç½®çš„æ•°å€¼åˆ†åˆ«ç›¸åŠ 
```

### ç±»æ¯”ç”Ÿæ´»ï¼š

```
å‘é‡ = ä¸€ç»„äºº
å‘é‡å…ƒç´  = å•ä¸ªäºº

[å¼ ä¸‰, æå››, ç‹äº”, èµµå…­]  â† å‘é‡ï¼ˆä¸€ç»„äººï¼‰
  â†‘     â†‘     â†‘     â†‘
 æ¯ä¸ªéƒ½æ˜¯ä¸€ä¸ªäººï¼ˆä¸æ˜¯ä¸€ç»„äººï¼‰

"ä¸¤ç»„äººåˆå¹¶" â‰ˆ å‘é‡åŠ æ³•
ä½†å®é™…æ˜¯ï¼š
  å¼ ä¸‰+æ–°å¼ ä¸‰, æå››+æ–°æå››, ...
  æ¯å¯¹éƒ½æ˜¯"ä¸ªä½“"çš„ç»„åˆï¼Œä¸æ˜¯"ç¾¤ä½“"çš„ç»„åˆ
```

æ‰€ä»¥ï¼š**a å’Œ p ç›¸åŠ åæ˜¯ä¸€ä¸ªæ•°å€¼ï¼ˆfloatï¼‰ï¼Œä¸æ˜¯å‘é‡ï¼** âœ…


# wte æ˜¯æ¯ä¸ªè¯çš„å‘é‡ï¼Œè¿™ä¸ªå¥½ç†è§£ï¼Œä½ç½®æ€ä¹ˆä¼šæœ‰å‘é‡å‘¢ï¼Ÿ ä»»ä½•ä¸€ä¸ªè¯å¯èƒ½å‡ºç°åœ¨ä»»ä½•ä¸€ä¸ªä½ç½®ï¼Œè¿™ä¸ªä¸å¥½ç†è§£ï¼Œå†è¯´ä¸€ä¸ªå¥å­å¯èƒ½æœ‰å¤§äº1024ä¸ªä½ç½®ï¼Œè¿™ç§æ€ä¹ˆå¤„ç†

# éå¸¸å¥½çš„æ·±åº¦æ€è€ƒï¼è®©æˆ‘é€ä¸€è§£ç­”

## ä¸€ã€ä½ç½®æ€ä¹ˆä¼šæœ‰å‘é‡ï¼Ÿ

### 1. **ä½ç½®å‘é‡çš„æœ¬è´¨ï¼šä½ç½®çš„"ç‰¹å¾æè¿°"**

ä½ç½®è™½ç„¶åªæ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆ0, 1, 2, ...ï¼‰ï¼Œä½†å®ƒåœ¨è¯­è¨€ä¸­æœ‰**ä¸°å¯Œçš„è¯­ä¹‰**ï¼

#### ç”Ÿæ´»ç±»æ¯”ï¼š

```
æƒ³è±¡ä¸€åœºæ¼”è®²çš„åº§ä½ï¼š

ç¬¬1æ’ï¼ˆä½ç½®0ï¼‰çš„ç‰¹ç‚¹ï¼š
  - è·ç¦»è®²å°è¿‘
  - èƒ½çœ‹æ¸…ç»†èŠ‚
  - æ³¨æ„åŠ›é›†ä¸­
  - é€šå¸¸æ˜¯é‡è¦å˜‰å®¾
  
ç¬¬10æ’ï¼ˆä½ç½®9ï¼‰çš„ç‰¹ç‚¹ï¼š
  - è·ç¦»é€‚ä¸­
  - è§†é‡å¼€é˜”
  - æ¯”è¾ƒæ”¾æ¾
  
æœ€åä¸€æ’ï¼ˆä½ç½®99ï¼‰çš„ç‰¹ç‚¹ï¼š
  - è·ç¦»è¿œ
  - å¯èƒ½åˆ†å¿ƒ
  - å®¹æ˜“èµ°ç¥
```

**æ¯ä¸ªä½ç½®éƒ½æœ‰è‡ªå·±çš„"ç‰¹æ€§"ï¼**

#### åœ¨è¯­è¨€ä¸­ï¼š

```
å¥å­ï¼š"æ˜¨å¤© æˆ‘ å» äº† åŒ—äº¬ æ—…æ¸¸"
ä½ç½®ï¼š  0    1  2  3   4    5

ä½ç½®0ï¼ˆå¥é¦–ï¼‰çš„ç‰¹ç‚¹ï¼š
  âœ“ é€šå¸¸æ˜¯æ—¶é—´çŠ¶è¯­
  âœ“ æœ‰å¼•å¯¼ä½œç”¨
  âœ“ è®¾å®šèƒŒæ™¯
  
ä½ç½®1-2ï¼ˆä¸»è°“ï¼‰çš„ç‰¹ç‚¹ï¼š
  âœ“ ä¸»è¯­ä½ç½®
  âœ“ åŠ¨è¯ä½ç½®
  âœ“ å¥å­æ ¸å¿ƒ
  
ä½ç½®æœ«å°¾çš„ç‰¹ç‚¹ï¼š
  âœ“ å¯èƒ½æ˜¯å®¾è¯­
  âœ“ å¥å­ç»“æŸ
  âœ“ è¯­æ°”è¯ä½ç½®
```

### 2. **ä½ç½®å‘é‡ç¼–ç è¿™äº›ç‰¹å¾**

```
ä½ç½®0 çš„å‘é‡å¯èƒ½å­¦åˆ°ï¼š
[å¥é¦–:0.9, é‡è¦åº¦:0.8, æ³¨æ„åŠ›:0.9, æ—¶é—´æ€§:0.7, ...]

ä½ç½®5 çš„å‘é‡å¯èƒ½å­¦åˆ°ï¼š
[å¥é¦–:0.1, é‡è¦åº¦:0.5, æ³¨æ„åŠ›:0.6, æ—¶é—´æ€§:0.2, ...]

ä½ç½®100 çš„å‘é‡å¯èƒ½å­¦åˆ°ï¼š
[å¥é¦–:0.0, é‡è¦åº¦:0.3, æ³¨æ„åŠ›:0.3, å¥å°¾:0.8, ...]
```

è™½ç„¶æˆ‘ä»¬çœ‹åˆ°çš„åªæ˜¯ 768 ä¸ªæ•°å­—ï¼Œä½†æ¨¡å‹åœ¨è®­ç»ƒä¸­å­¦ä¼šäº†ç”¨è¿™äº›æ•°å­—è¡¨è¾¾"ä½ç½®çš„è¯­ä¹‰ç‰¹å¾"ã€‚

### 3. **ä¸ºä»€ä¹ˆéœ€è¦å‘é‡è€Œä¸æ˜¯å•ä¸ªæ•°å­—ï¼Ÿ**

#### å¦‚æœåªç”¨ä½ç½®æ•°å­—æœ¬èº«ï¼š

```
ä½ç½®0 â†’ 0
ä½ç½®1 â†’ 1
ä½ç½®2 â†’ 2
```

**é—®é¢˜**ï¼š
- å•ä¸ªæ•°å­— "2" èƒ½è¡¨è¾¾ä»€ä¹ˆï¼Ÿåªèƒ½è¯´"è¿™æ˜¯ç¬¬3ä¸ªä½ç½®"
- æ— æ³•è¡¨è¾¾ï¼šå¥é¦–æ€§ã€é‡è¦æ€§ã€ä¸å…¶ä»–ä½ç½®çš„è¯­ä¹‰å…³ç³»

#### ç”¨ 768 ç»´å‘é‡ï¼š

```
ä½ç½®2 â†’ [0.3, -0.5, 0.8, ..., 0.2]
        â†‘
  768 ä¸ªæ•°å­—å¯ä»¥ç¼–ç ä¸°å¯Œçš„ä½ç½®ç‰¹å¾ï¼
```

## äºŒã€"ä»»ä½•è¯å¯èƒ½å‡ºç°åœ¨ä»»ä½•ä½ç½®" ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æœ‰æ•ˆï¼Ÿ

### 1. **æ ¸å¿ƒåŸç†ï¼šè¯å‘é‡ + ä½ç½®å‘é‡ = ç‹¬ç‰¹çš„ç»„åˆ**

è™½ç„¶åŒä¸€ä¸ªè¯å¯èƒ½å‡ºç°åœ¨ä¸åŒä½ç½®ï¼Œä½†**åŠ ä¸Šä½ç½®ç¼–ç åå°±ä¸åŒäº†**ï¼

#### å…·ä½“ä¾‹å­ï¼š

```
å¥å­1ï¼š"æˆ‘ çˆ± åƒ è‹¹æœ"
å¥å­2ï¼š"è‹¹æœ å¾ˆ ç”œ æˆ‘ çˆ± åƒ"

"è‹¹æœ" çš„tokenå‘é‡æ˜¯å›ºå®šçš„ï¼š
wte["è‹¹æœ"] = [0.5, 0.8, 0.3, ..., 0.9]  ï¼ˆæ°¸è¿œä¸€æ ·ï¼‰

ä½†åŠ ä¸Šä½ç½®åï¼š

å¥å­1ä¸­çš„"è‹¹æœ"ï¼ˆä½ç½®3ï¼‰ï¼š
  [0.5, 0.8, 0.3, ..., 0.9]  â† tokenå‘é‡
+ [0.1, 0.2, 0.1, ..., 0.3]  â† ä½ç½®3çš„å‘é‡
= [0.6, 1.0, 0.4, ..., 1.2]  â† æœ€ç»ˆå‘é‡A

å¥å­2ä¸­çš„"è‹¹æœ"ï¼ˆä½ç½®0ï¼‰ï¼š
  [0.5, 0.8, 0.3, ..., 0.9]  â† åŒæ ·çš„tokenå‘é‡
+ [0.9, 0.7, 0.8, ..., 0.5]  â† ä½ç½®0çš„å‘é‡ï¼ˆä¸åŒï¼ï¼‰
= [1.4, 1.5, 1.1, ..., 1.4]  â† æœ€ç»ˆå‘é‡Bï¼ˆä¸åŒï¼ï¼‰
```

**ç»“æœ**ï¼šè™½ç„¶æ˜¯åŒä¸€ä¸ªè¯"è‹¹æœ"ï¼Œä½†åœ¨ä¸åŒä½ç½®ï¼Œæ¨¡å‹çœ‹åˆ°çš„æ˜¯**å®Œå…¨ä¸åŒçš„å‘é‡**ï¼

### 2. **ç±»æ¯”ç†è§£**

#### ç±»æ¯”1ï¼šåŒä¸€ä¸ªæ¼”å‘˜æ¼”ä¸åŒè§’è‰²

```
æ¼”å‘˜ï¼šæˆé¾™ï¼ˆå›ºå®šçš„tokenï¼‰

åœ¨ã€Šè­¦å¯Ÿæ•…äº‹ã€‹ä¸­ï¼š
  æˆé¾™ + è­¦å¯Ÿè§’è‰² = æ­£ä¹‰å‡›ç„¶çš„è­¦å¯Ÿå½¢è±¡

åœ¨ã€Šé†‰æ‹³ã€‹ä¸­ï¼š
  æˆé¾™ + é†‰æ±‰è§’è‰² = è¯™è°å¹½é»˜çš„æ­¦è€…å½¢è±¡

åŒä¸€ä¸ªäººï¼ˆtokenï¼‰ï¼Œä¸åŒçš„è§’è‰²å®šä½ï¼ˆpositionï¼‰ï¼Œå‘ˆç°ä¸åŒçš„æ•ˆæœï¼
```

#### ç±»æ¯”2ï¼šåŒä¸€ä¸ªå­—æ¯åœ¨ä¸åŒä½ç½®

```
å•è¯ï¼š"banana"
      b a n a n a
      â†‘ â†‘ â†‘ â†‘ â†‘ â†‘
      0 1 2 3 4 5

å­—æ¯ 'a' å‡ºç°äº†3æ¬¡ï¼ˆä½ç½®1, 3, 5ï¼‰
ä½†æ¯æ¬¡çš„"æ„ä¹‰"ä¸åŒï¼š
  - ä½ç½®1çš„'a'ï¼šç¬¬ä¸€ä¸ªå…ƒéŸ³
  - ä½ç½®3çš„'a'ï¼šä¸­é—´çš„å…ƒéŸ³
  - ä½ç½®5çš„'a'ï¼šç»“å°¾çš„å…ƒéŸ³

è™½ç„¶å­—æ¯ç›¸åŒï¼Œä½†ä½ç½®ä¸åŒï¼Œåœ¨å•è¯ä¸­çš„ä½œç”¨å°±ä¸åŒï¼
```

### 3. **è®­ç»ƒæ—¶æ¨¡å‹å­¦åˆ°ä»€ä¹ˆï¼Ÿ**

```
æ¨¡å‹è§è¿‡å¤§é‡å¥å­åå­¦åˆ°ï¼š

"å¥é¦–çš„åè¯" é€šå¸¸æ˜¯ä¸»è¯­
  â†’ ä½ç½®0çš„å‘é‡ + åè¯å‘é‡ = "ä¸»è¯­ç‰¹å¾å¼º"

"åŠ¨è¯åé¢çš„åè¯" é€šå¸¸æ˜¯å®¾è¯­  
  â†’ ä½ç½®3çš„å‘é‡ + åè¯å‘é‡ = "å®¾è¯­ç‰¹å¾å¼º"

"å¥æœ«çš„è¯" å¯èƒ½æ˜¯è¯­æ°”è¯
  â†’ ä½ç½®10çš„å‘é‡ + æŸè¯å‘é‡ = "ç»“æŸè¯­æ°”"
```

## ä¸‰ã€è¶…è¿‡ 1024 ä¸ªä½ç½®æ€ä¹ˆåŠï¼Ÿ

### è¿™æ˜¯ä¸ªçœŸå®çš„é™åˆ¶ï¼GPT-2 çš„**ç¡¬ä¸Šé™å°±æ˜¯ 1024**

#### 1. **ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªé™åˆ¶ï¼Ÿ**

```c
// ä»£ç ä¸­çš„å®šä¹‰
model->config.max_seq_len = 1024;  // æœ€å¤§åºåˆ—é•¿åº¦

// ä½ç½®ç¼–ç è¡¨åªæœ‰ 1024 ä¸ª
float* wpe;  // (1024, 768)

// åªæœ‰è¿™äº›ä½ç½®çš„ç¼–ç ï¼š
wpe[0], wpe[1], wpe[2], ..., wpe[1023]

// æ²¡æœ‰ wpe[1024], wpe[1025], ... âŒ
```

#### 2. **å¦‚æœè¾“å…¥è¶…è¿‡ 1024 ä¼šæ€æ ·ï¼Ÿ**

```c
// å‡è®¾è¾“å…¥ T = 2000
for (int t = 0; t < T; t++) {
    float* wpe_t = wpe + t * C;  // å½“ t >= 1024 æ—¶...
    //                              è®¿é—®è¶Šç•Œï¼ç¨‹åºå´©æºƒï¼
}
```

**ç»“æœ**ï¼š
- ç¨‹åºä¼šå´©æºƒï¼ˆè®¿é—®éæ³•å†…å­˜ï¼‰
- æˆ–è€…å¾—åˆ°åƒåœ¾æ•°æ®

### 3. **å®é™…ä¸­å¦‚ä½•å¤„ç†é•¿æ–‡æœ¬ï¼Ÿ**

#### æ–¹æ³•1ï¼š**æˆªæ–­ï¼ˆTruncationï¼‰**

```
åŸæ–‡æœ¬ï¼š5000ä¸ªtoken
      â†“
åªå–å‰1024ä¸ªï¼š
[token_0, token_1, ..., token_1023]
åé¢çš„éƒ½ä¸¢å¼ƒ âŒ
```

**ç¼ºç‚¹**ï¼šä¸¢å¤±äº†å¤§é‡ä¿¡æ¯

#### æ–¹æ³•2ï¼š**æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰**

```
é•¿æ–‡æœ¬ï¼š[t0, t1, t2, ..., t5000]

ç¬¬1æ¬¡å¤„ç†ï¼š[t0    ... t1023]
ç¬¬2æ¬¡å¤„ç†ï¼š    [t512  ... t1535]
ç¬¬3æ¬¡å¤„ç†ï¼š           [t1024 ... t2047]
...

æ¯æ¬¡åªçœ‹ 1024 ä¸ªï¼Œä½†é€šè¿‡é‡å ä¿æŒä¸Šä¸‹æ–‡
```

#### æ–¹æ³•3ï¼š**åˆ†å—å¤„ç†ï¼ˆChunkingï¼‰**

```
é•¿æ–‡ç« åˆ‡æˆå¤šæ®µï¼š
  æ®µè½1 (1000 tokens) â†’ GPT-2å¤„ç†
  æ®µè½2 (800 tokens)  â†’ GPT-2å¤„ç†
  æ®µè½3 (1200 tokens) â†’ å†åˆ‡æˆä¸¤éƒ¨åˆ†
```

#### æ–¹æ³•4ï¼š**ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹**

```
ä¸åŒæ¨¡å‹çš„é™åˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ¨¡å‹     â”‚  æœ€å¤§é•¿åº¦    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GPT-2      â”‚    1024      â”‚
â”‚ GPT-3      â”‚    2048      â”‚
â”‚ GPT-4      â”‚    8192      â”‚ (æ—©æœŸ)
â”‚ GPT-4      â”‚   32768      â”‚ (32kç‰ˆæœ¬)
â”‚ Claude 2   â”‚  100000      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. **ä¸ºä»€ä¹ˆä¸ç›´æ¥æ‰©å±•åˆ°æ— é™é•¿ï¼Ÿ**

#### é—®é¢˜1ï¼šå†…å­˜å¼€é”€

```
1024 ä½ç½®ç¼–ç : 1024 Ã— 768 = 786,432 ä¸ªå‚æ•°
10240 ä½ç½®ç¼–ç : 10240 Ã— 768 = 7,864,320 ä¸ªå‚æ•°ï¼ˆ10å€ï¼ï¼‰
```

#### é—®é¢˜2ï¼šæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—å¤æ‚åº¦

```c
// æ³¨æ„åŠ›çŸ©é˜µå¤§å°ï¼š(T, T)
float* att;  // (B, NH, T, T)

T=1024:  1024 Ã— 1024 = 1,048,576 ä¸ªå…ƒç´ 
T=2048:  2048 Ã— 2048 = 4,194,304 ä¸ªå…ƒç´ ï¼ˆ4å€ï¼ï¼‰
T=4096:  4096 Ã— 4096 = 16,777,216 ä¸ªå…ƒç´ ï¼ˆ16å€ï¼ï¼‰

è®¡ç®—é‡æ˜¯ O(TÂ²)ï¼Œé•¿åº¦ç¿»å€ï¼Œè®¡ç®—é‡å˜4å€ï¼
```

#### é—®é¢˜3ï¼šä½ç½®ç¼–ç çš„æ³›åŒ–èƒ½åŠ›

```
è®­ç»ƒæ—¶åªè§è¿‡ 0-1023 çš„ä½ç½®
å¦‚æœçªç„¶è¾“å…¥ä½ç½® 5000ï¼Œæ¨¡å‹ä¼šå›°æƒ‘ï¼š
  - ä»æœªè§è¿‡è¿™ä¹ˆè¿œçš„ä½ç½®
  - ä¸çŸ¥é“å¦‚ä½•å¤„ç†
  - æ•ˆæœä¼šå¾ˆå·®
```

## å››ã€ç°ä»£è§£å†³æ–¹æ¡ˆ

### 1. **ç›¸å¯¹ä½ç½®ç¼–ç ï¼ˆRelative Positionï¼‰**

ä¸ç”¨ç»å¯¹ä½ç½®ï¼ˆ0, 1, 2, ...ï¼‰ï¼Œè€Œç”¨ç›¸å¯¹è·ç¦»ï¼š

```
ä¼ ç»Ÿï¼ˆç»å¯¹ä½ç½®ï¼‰ï¼š
  ä½ç½®5çš„è¯çœ‹ä½ç½®2çš„è¯ â†’ çœ‹çš„æ˜¯"ä½ç½®2"

ç›¸å¯¹ä½ç½®ï¼š
  ä½ç½®5çš„è¯çœ‹ä½ç½®2çš„è¯ â†’ çœ‹çš„æ˜¯"è·ç¦»-3"
  
å¥½å¤„ï¼š
  - "è·ç¦»-3"çš„æ¨¡å¼å¯ä»¥å¤ç”¨
  - ä¸å—æ€»é•¿åº¦é™åˆ¶
  - è§è¿‡"è·ç¦»-3"å°±èƒ½å¤„ç†ä»»ä½•ä½ç½®é—´éš”ä¸º3çš„æƒ…å†µ
```

### 2. **æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆRoPE - Rotary Position Embeddingï¼‰**

LLaMAã€GPT-NeoX ç­‰ä½¿ç”¨ï¼š

```
ä¸æ˜¯ç®€å•ç›¸åŠ ï¼Œè€Œæ˜¯"æ—‹è½¬"å‘é‡ï¼š

ä¼ ç»Ÿ: output = token_vec + pos_vec
RoPE: output = rotate(token_vec, angle=f(position))

å¥½å¤„ï¼š
  - å¯ä»¥å¤–æ¨åˆ°æ›´é•¿åºåˆ—
  - æ•°å­¦æ€§è´¨æ›´ä¼˜
```

### 3. **ALiBiï¼ˆAttention with Linear Biasesï¼‰**

```
ä¸ç”¨ä½ç½®ç¼–ç ï¼Œç›´æ¥åœ¨æ³¨æ„åŠ›åˆ†æ•°ä¸ŠåŠ åç½®ï¼š

att_score = QÂ·K - Î± Ã— distance

è·ç¦»è¶Šè¿œï¼Œæ³¨æ„åŠ›è¶Šå¼±ï¼ˆè‡ªç„¶çš„è¡°å‡ï¼‰
```

## äº”ã€ä»£ç ä¸­çš„é™åˆ¶æ£€æŸ¥

### GPT-2 ä¸­ç¼ºå°‘çš„ä¿æŠ¤ï¼š

```c
void gpt2_forward(GPT2 *model, int* inputs, int* targets, size_t B, size_t T) {
    // åº”è¯¥æœ‰è¿™æ ·çš„æ£€æŸ¥ï¼ˆä½†ä»£ç é‡Œæ²¡æœ‰ï¼‰ï¼š
    if (T > model->config.max_seq_len) {
        printf("Error: sequence length %zu exceeds max %d\n", 
               T, model->config.max_seq_len);
        exit(1);
    }
    
    // ...
}
```

### å®é™…ä½¿ç”¨å»ºè®®ï¼š

```c
// åœ¨è°ƒç”¨å‰ç¡®ä¿ï¼š
int T = seq_length;
if (T > 1024) {
    // æ–¹æ¡ˆ1ï¼šæˆªæ–­
    T = 1024;
    
    // æ–¹æ¡ˆ2ï¼šåˆ†å—å¤„ç†
    // process_in_chunks(inputs, 1024);
    
    // æ–¹æ¡ˆ3ï¼šæç¤ºç”¨æˆ·
    // printf("Warning: truncating to 1024 tokens\n");
}

gpt2_forward(&model, inputs, targets, B, T);
```

## å…­ã€æ€»ç»“

### å…³é”®ç‚¹å›ç­”ï¼š

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **ä½ç½®ä¸ºä»€ä¹ˆæœ‰å‘é‡** | ä½ç½®æœ‰è¯­ä¹‰ç‰¹å¾ï¼ˆå¥é¦–/å¥ä¸­/å¥æœ«ï¼‰ï¼Œéœ€è¦å¤šç»´è¡¨ç¤º |
| **åŒè¯ä¸åŒä½ç½®** | tokenå‘é‡ç›¸åŒï¼Œä½† + ä¸åŒçš„ä½ç½®å‘é‡ = ä¸åŒçš„æœ€ç»ˆå‘é‡ |
| **è¶…è¿‡1024æ€ä¹ˆåŠ** | ç¡¬é™åˆ¶ï¼å¿…é¡»æˆªæ–­ã€åˆ†å—æˆ–ç”¨æ›´å¤§çš„æ¨¡å‹ |
| **ä¸ºä»€ä¹ˆé™åˆ¶1024** | å†…å­˜ã€è®¡ç®—å¤æ‚åº¦ã€è®­ç»ƒæ•°æ®çš„é™åˆ¶ |

### å½¢è±¡è®°å¿†ï¼š

```
ä½ç½®å‘é‡ = ç»™è¯è´´çš„"åº§ä½æ ‡ç­¾"

"è‹¹æœ" è¿™ä¸ªè¯ï¼ˆtokenå‘é‡ï¼‰æ˜¯å›ºå®šçš„
ä½†ï¼š
  "è‹¹æœ"ååœ¨ç¬¬1æ’ï¼ˆä½ç½®0å‘é‡ï¼‰â†’ ä¸»è¯­çš„è‹¹æœ
  "è‹¹æœ"ååœ¨ç¬¬5æ’ï¼ˆä½ç½®4å‘é‡ï¼‰â†’ å®¾è¯­çš„è‹¹æœ
  "è‹¹æœ"ååœ¨ç¬¬10æ’ï¼ˆä½ç½®9å‘é‡ï¼‰â†’ è¡¥è¯­çš„è‹¹æœ

åŒä¸€ä¸ªäººï¼Œä¸åŒåº§ä½ï¼Œä¸åŒçš„æ„ä¹‰ï¼

ä½†åªæœ‰1024ä¸ªåº§ä½ï¼ˆç¡¬é™åˆ¶ï¼‰
ç¬¬1025ä¸ªäººè¿›ä¸æ¥ï¼âŒ
```

å¸Œæœ›è¿™æ¬¡å½»åº•è§£ç­”äº†ä½ çš„ç–‘æƒ‘ï¼ğŸ¯

# è‡ªæ³¨æ„åŠ›æœºåˆ¶Self-Attention è¿™å¿«ä¸æ¸…æ¥š è¯¦ç»†è§£é‡Š

# è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆSelf-Attentionï¼‰è¯¦è§£

è¿™æ˜¯ Transformer å’Œ GPT çš„**æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ**ï¼è®©æˆ‘ä»é›¶å¼€å§‹å½»åº•è®²æ¸…æ¥šã€‚

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦æ³¨æ„åŠ›æœºåˆ¶ï¼Ÿ

### 1. **é—®é¢˜ï¼šç†è§£å¥å­éœ€è¦çœ‹"ä¸Šä¸‹æ–‡"**

çœ‹è¿™ä¸ªå¥å­ï¼š

```
"é“¶è¡Œ" è¿™ä¸ªè¯çš„æ„æ€æ˜¯ä»€ä¹ˆï¼Ÿ

å¥å­1ï¼š"æˆ‘å»é“¶è¡Œå–é’±"
       â†’ é“¶è¡Œ = é‡‘èæœºæ„ ğŸ’°

å¥å­2ï¼š"æˆ‘åœ¨æ²³é“¶è¡Œæ•£æ­¥"  
       â†’ é“¶è¡Œ = æ²³è¾¹ ğŸï¸

åŒä¸€ä¸ªè¯ï¼Œæ„æ€å®Œå…¨ä¸åŒï¼
```

**å…³é”®**ï¼šè¦ç†è§£ä¸€ä¸ªè¯ï¼Œå¿…é¡»çœ‹å®ƒå‘¨å›´çš„å…¶ä»–è¯ï¼

### 2. **ä¼ ç»Ÿæ–¹æ³•çš„é—®é¢˜**

```
ç®€å•çš„è¯åµŒå…¥ï¼š
"é“¶è¡Œ" â†’ [0.5, 0.3, 0.8, ...]  ï¼ˆå›ºå®šå‘é‡ï¼‰

é—®é¢˜ï¼š
  âœ— åœ¨ä»»ä½•å¥å­ä¸­éƒ½æ˜¯åŒä¸€ä¸ªå‘é‡
  âœ— æ— æ³•æ ¹æ®ä¸Šä¸‹æ–‡æ”¹å˜
  âœ— æ— æ³•åŒºåˆ†ä¸åŒå«ä¹‰
```

### 3. **æ³¨æ„åŠ›æœºåˆ¶çš„è§£å†³æ–¹æ¡ˆ**

```
è®© "é“¶è¡Œ" è¿™ä¸ªè¯å»"çœ‹"å¥å­ä¸­çš„å…¶ä»–è¯ï¼š

å¥å­1ï¼š"æˆ‘ å» é“¶è¡Œ å–é’±"
              â†“ "é“¶è¡Œ"çœ‹å…¶ä»–è¯
         "å–é’±" æƒé‡é«˜ â†’ åˆ¤æ–­æ˜¯é‡‘èæœºæ„

å¥å­2ï¼š"æˆ‘ åœ¨ æ²³ é“¶è¡Œ æ•£æ­¥"
              â†“ "é“¶è¡Œ"çœ‹å…¶ä»–è¯  
         "æ²³" æƒé‡é«˜ â†’ åˆ¤æ–­æ˜¯æ²³è¾¹

åŒä¸€ä¸ªè¯ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡å¾—åˆ°ä¸åŒçš„è¡¨ç¤ºï¼
```

## äºŒã€æ³¨æ„åŠ›æœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³

### ç”¨æœ€ç®€å•çš„è¯è¯´ï¼š

> **æ¯ä¸ªè¯å»"è¯¢é—®"å…¶ä»–æ‰€æœ‰è¯ï¼Œå†³å®šåº”è¯¥å…³æ³¨è°ï¼Œç„¶åä»è¢«å…³æ³¨çš„è¯é‚£é‡Œ"æå–"ä¿¡æ¯ï¼Œæ›´æ–°è‡ªå·±çš„è¡¨ç¤ºã€‚**

### ç”Ÿæ´»ç±»æ¯”ï¼š

#### ç±»æ¯”1ï¼šä¸Šè¯¾æé—®

```
ä½ æ˜¯å­¦ç”Ÿï¼ˆå½“å‰è¯ï¼‰ï¼Œé‡åˆ°é—®é¢˜ï¼š

æ­¥éª¤1 - æé—®ï¼ˆQueryï¼‰ï¼š
  ä½ ï¼š"è°èƒ½å¸®æˆ‘è§£é‡Šè¿™ä¸ªæ¦‚å¿µï¼Ÿ"
  
æ­¥éª¤2 - å…¶ä»–åŒå­¦å“åº”ï¼ˆKeyï¼‰ï¼š
  åŒå­¦Aï¼š"æˆ‘æ•°å­¦å¥½ï¼"      â†’ ç›¸å…³åº¦ï¼šé«˜
  åŒå­¦Bï¼š"æˆ‘ä½“è‚²å¥½ï¼"      â†’ ç›¸å…³åº¦ï¼šä½
  åŒå­¦Cï¼š"æˆ‘ä¹Ÿæ‡‚æ•°å­¦ï¼"    â†’ ç›¸å…³åº¦ï¼šé«˜
  
æ­¥éª¤3 - è®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼š
  Açš„å¸®åŠ©å æ¯”ï¼š60%
  Bçš„å¸®åŠ©å æ¯”ï¼š5%
  Cçš„å¸®åŠ©å æ¯”ï¼š35%
  
æ­¥éª¤4 - è·å–ç­”æ¡ˆï¼ˆValueï¼‰ï¼š
  ä»Aé‚£é‡Œå¾—åˆ° 60% çš„è§£é‡Š
  ä»Cé‚£é‡Œå¾—åˆ° 35% çš„è§£é‡Š
  ä»Bé‚£é‡Œå¾—åˆ° 5% çš„è§£é‡Š
  
æ­¥éª¤5 - ç»¼åˆç†è§£ï¼š
  ä½ çš„æ–°ç†è§£ = 60%Ã—Açš„è§£é‡Š + 35%Ã—Cçš„è§£é‡Š + 5%Ã—Bçš„è§£é‡Š
```

#### ç±»æ¯”2ï¼šæ‰¾ä¸“å®¶å’¨è¯¢

```
ä½ è¦å†™å…³äº"é‡å­è®¡ç®—"çš„æŠ¥å‘Šï¼š

ä½ çš„é—®é¢˜ï¼ˆQueryï¼‰ï¼š"è°æ‡‚é‡å­è®¡ç®—ï¼Ÿ"

å¯å’¨è¯¢çš„äººï¼ˆKeyï¼‰ï¼š
  - ç‰©ç†æ•™æˆï¼šåŒ¹é…åº¦ 90% âœ“âœ“âœ“
  - å¨å¸ˆï¼š    åŒ¹é…åº¦ 2%  âœ—
  - ç¨‹åºå‘˜ï¼š  åŒ¹é…åº¦ 40% âœ“
  - è‰ºæœ¯å®¶ï¼š  åŒ¹é…åº¦ 5%  âœ—
  
æ³¨æ„åŠ›åˆ†é…ï¼š
  ä¸»è¦å¬ç‰©ç†æ•™æˆçš„ (75%)
  å…¶æ¬¡å¬ç¨‹åºå‘˜çš„ (20%)
  ç¨å¾®å‚è€ƒå…¶ä»–äººçš„ (5%)
  
è·å–ä¿¡æ¯ï¼ˆValueï¼‰ï¼š
  75% æ¥è‡ªç‰©ç†æ•™æˆçš„çŸ¥è¯†
  20% æ¥è‡ªç¨‹åºå‘˜çš„çŸ¥è¯†  
  5% æ¥è‡ªå…¶ä»–äººçš„çŸ¥è¯†
```

## ä¸‰ã€æ•°å­¦åŸç†ï¼ˆé€æ­¥æ¨å¯¼ï¼‰

### 1. **è¾“å…¥å‡†å¤‡**

```
å¥å­ï¼š"æˆ‘ çˆ± åƒ è‹¹æœ"ï¼ˆå·²ç»åŠ ä¸Šäº†tokenå’Œpositionç¼–ç ï¼‰

è¾“å…¥çŸ©é˜µ Xï¼š
        ç»´åº¦0  ç»´åº¦1  ç»´åº¦2  ...  ç»´åº¦767
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
"æˆ‘"   â”‚ 0.1    0.2    0.3   ...  0.8  â”‚  â† 768ç»´
"çˆ±"   â”‚ 0.4    0.5    0.6   ...  0.2  â”‚  â† 768ç»´
"åƒ"   â”‚ 0.7    0.8    0.9   ...  0.5  â”‚  â† 768ç»´
"è‹¹æœ" â”‚ 0.3    0.4    0.5   ...  0.9  â”‚  â† 768ç»´
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘ å½¢çŠ¶ï¼š(4, 768)
       4ä¸ªè¯ï¼Œæ¯ä¸ª768ç»´
```

### 2. **ç”Ÿæˆ Qã€Kã€Vï¼ˆQuery, Key, Valueï¼‰**

é€šè¿‡ä¸‰ä¸ªä¸åŒçš„**çº¿æ€§å˜æ¢**ï¼ˆçŸ©é˜µä¹˜æ³•ï¼‰ï¼š

```c
// ä»£ç ä¸­çš„å®ç°
matmul_forward(l_qkv, l_ln1, l_qkvw, l_qkvb, B, T, C, 3*C);
//             è¾“å‡º   è¾“å…¥   æƒé‡    åç½®
//            (B,T,3C) (B,T,C) (3C,C)
```

#### å…·ä½“è¿‡ç¨‹ï¼š

```
è¾“å…¥ X: (4, 768)

æƒé‡çŸ©é˜µï¼š
  Wq: (768, 768)  â† Queryæƒé‡
  Wk: (768, 768)  â† Keyæƒé‡  
  Wv: (768, 768)  â† Valueæƒé‡

è®¡ç®—ï¼š
  Q = X Ã— Wq  â†’  (4, 768)  QueryçŸ©é˜µ
  K = X Ã— Wk  â†’  (4, 768)  KeyçŸ©é˜µ
  V = X Ã— Wv  â†’  (4, 768)  ValueçŸ©é˜µ
```

#### Qã€Kã€V çš„å«ä¹‰ï¼š

```
ä»¥"è‹¹æœ"è¿™ä¸ªè¯ä¸ºä¾‹ï¼š

Queryï¼ˆæŸ¥è¯¢å‘é‡ï¼‰ï¼š
  "è‹¹æœåœ¨é—®ï¼šæˆ‘åº”è¯¥å…³æ³¨å¥å­é‡Œçš„å“ªäº›è¯ï¼Ÿ"
  [0.2, 0.5, 0.8, ..., 0.3]  â† 768ç»´

Keyï¼ˆé”®å‘é‡ï¼‰ï¼š
  æ¯ä¸ªè¯éƒ½æœ‰ä¸€ä¸ªKeyï¼Œè¡¨ç¤º"æˆ‘æœ‰ä»€ä¹ˆä¿¡æ¯"
  "æˆ‘":   [0.1, 0.3, 0.5, ..., 0.2]
  "çˆ±":   [0.4, 0.2, 0.7, ..., 0.6]
  "åƒ":   [0.3, 0.8, 0.2, ..., 0.4]
  "è‹¹æœ": [0.6, 0.5, 0.3, ..., 0.8]

Valueï¼ˆå€¼å‘é‡ï¼‰ï¼š
  æ¯ä¸ªè¯çš„"å®é™…å†…å®¹"
  "æˆ‘":   [0.8, 0.2, 0.4, ..., 0.1]
  "çˆ±":   [0.3, 0.7, 0.5, ..., 0.9]
  "åƒ":   [0.5, 0.6, 0.8, ..., 0.3]
  "è‹¹æœ": [0.2, 0.4, 0.6, ..., 0.7]
```

### 3. **è®¡ç®—æ³¨æ„åŠ›åˆ†æ•°ï¼ˆAttention Scoresï¼‰**

```c
// ä»£ç ä¸­çš„å®ç°
for (int t2 = 0; t2 <= t; t2++) {
    float* key_t2 = inp + b * T * C3 + t2 * C3 + h * hs + C;
    
    // Query ç‚¹ä¹˜ Key
    float val = 0.0f;
    for (int i = 0; i < hs; i++) {
        val += query_t[i] * key_t2[i];  // ç‚¹ç§¯
    }
    val *= scale;  // ç¼©æ”¾
    preatt_bth[t2] = val;
}
```

#### ä»¥"è‹¹æœ"ä¸ºä¾‹è®¡ç®—ï¼š

```
"è‹¹æœ"çš„Query: [0.2, 0.5, 0.8, ..., 0.3]

ä¸æ¯ä¸ªè¯çš„Keyåšç‚¹ç§¯ï¼š

score("æˆ‘")   = QueryÂ·Key("æˆ‘")   = 0.2Ã—0.1 + 0.5Ã—0.3 + ... = 10.5
score("çˆ±")   = QueryÂ·Key("çˆ±")   = 0.2Ã—0.4 + 0.5Ã—0.2 + ... = 15.2
score("åƒ")   = QueryÂ·Key("åƒ")   = 0.2Ã—0.3 + 0.5Ã—0.8 + ... = 25.8
score("è‹¹æœ") = QueryÂ·Key("è‹¹æœ") = 0.2Ã—0.6 + 0.5Ã—0.5 + ... = 30.3

åˆ†æ•°è¶Šé«˜ = ç›¸å…³æ€§è¶Šå¼º = è¶Šåº”è¯¥å…³æ³¨ï¼
```

#### ä¸ºä»€ä¹ˆç”¨ç‚¹ç§¯ï¼Ÿ

```
ç‚¹ç§¯ï¼ˆDot Productï¼‰è¡¡é‡å‘é‡ç›¸ä¼¼åº¦ï¼š

å‘é‡A = [1, 0, 0]
å‘é‡B = [1, 0, 0]  â†’ AÂ·B = 1Ã—1 + 0Ã—0 + 0Ã—0 = 1  ï¼ˆæ–¹å‘ç›¸åŒï¼‰

å‘é‡A = [1, 0, 0]  
å‘é‡C = [0, 1, 0]  â†’ AÂ·C = 1Ã—0 + 0Ã—1 + 0Ã—0 = 0  ï¼ˆå‚ç›´ï¼‰

å‘é‡A = [1, 0, 0]
å‘é‡D = [-1, 0, 0] â†’ AÂ·D = 1Ã—(-1) + 0Ã—0 + 0Ã—0 = -1 ï¼ˆæ–¹å‘ç›¸åï¼‰

ç‚¹ç§¯å¤§ â†’ ç›¸ä¼¼
ç‚¹ç§¯å° â†’ ä¸ç›¸ä¼¼
```

#### ç¼©æ”¾å› å­ scale

```c
float scale = 1.0 / sqrtf(hs);  // hs = head_sizeï¼Œé€šå¸¸æ˜¯64
```

**ä¸ºä»€ä¹ˆè¦é™¤ä»¥ âˆšdï¼Ÿ**

```
é—®é¢˜ï¼šå‘é‡ç»´åº¦å¤§æ—¶ï¼Œç‚¹ç§¯å€¼ä¼šå¾ˆå¤§

ä¾‹å¦‚ 768 ç»´ï¼š
  å¹³å‡æ¯ç»´è´¡çŒ® 0.5ï¼Œæ€»ç‚¹ç§¯ â‰ˆ 768 Ã— 0.5 = 384ï¼ˆå¤ªå¤§ï¼ï¼‰

åæœï¼š
  è¿›å…¥ softmax æ—¶ï¼Œexp(384) ä¼šçˆ†ç‚¸æˆ–æ¢¯åº¦æ¶ˆå¤±

è§£å†³ï¼š
  score = (QÂ·K) / âˆš768 â‰ˆ (QÂ·K) / 27.7
  384 / 27.7 â‰ˆ 13.9ï¼ˆåˆç†èŒƒå›´ï¼‰
```

### 4. **Softmax å½’ä¸€åŒ–**

```c
// pass 2: calculate the exp and keep track of sum
float expsum = 0.0f;
for (int t2 = 0; t2 <= t; t2++) {
    float expv = expf(preatt_bth[t2] - maxval);  // æŒ‡æ•°
    expsum += expv;
    att_bth[t2] = expv;
}
float expsum_inv = expsum == 0.0f ? 0.0f : 1.0f / expsum;

// pass 3: normalize to get the softmax
for (int t2 = 0; t2 <= t; t2++) {
    att_bth[t2] *= expsum_inv;  // å½’ä¸€åŒ–
}
```

#### å…·ä½“è®¡ç®—ï¼š

```
åŸå§‹åˆ†æ•°ï¼ˆ"è‹¹æœ"å¯¹å…¶ä»–è¯çš„æ³¨æ„åŠ›ï¼‰ï¼š
  score("æˆ‘")   = 10.5
  score("çˆ±")   = 15.2
  score("åƒ")   = 25.8
  score("è‹¹æœ") = 30.3

æ­¥éª¤1ï¼šæ‰¾æœ€å¤§å€¼ï¼ˆæ•°å€¼ç¨³å®šæ€§ï¼‰
  maxval = 30.3

æ­¥éª¤2ï¼šå‡å»æœ€å¤§å€¼å¹¶å–æŒ‡æ•°
  exp(10.5 - 30.3) = exp(-19.8) â‰ˆ 0.000000025
  exp(15.2 - 30.3) = exp(-15.1) â‰ˆ 0.00000027
  exp(25.8 - 30.3) = exp(-4.5)  â‰ˆ 0.011
  exp(30.3 - 30.3) = exp(0)     = 1.0

æ­¥éª¤3ï¼šæ±‚å’Œ
  sum = 0.000000025 + 0.00000027 + 0.011 + 1.0 â‰ˆ 1.011

æ­¥éª¤4ï¼šå½’ä¸€åŒ–ï¼ˆå˜æˆæ¦‚ç‡åˆ†å¸ƒï¼‰
  att("æˆ‘")   = 0.000000025 / 1.011 â‰ˆ 0.0000  (0%)
  att("çˆ±")   = 0.00000027  / 1.011 â‰ˆ 0.0000  (0%)
  att("åƒ")   = 0.011       / 1.011 â‰ˆ 0.011   (1.1%)
  att("è‹¹æœ") = 1.0         / 1.011 â‰ˆ 0.989   (98.9%)

ç»“æœï¼š
  "è‹¹æœ"è¿™ä¸ªè¯åº”è¯¥ï¼š
    âœ“ å¼ºçƒˆå…³æ³¨è‡ªå·± (98.9%)
    âœ“ ç¨å¾®å…³æ³¨"åƒ" (1.1%)
    âœ— åŸºæœ¬å¿½ç•¥"æˆ‘"å’Œ"çˆ±" (0%)
```

### 5. **åŠ æƒæ±‚å’Œ Value**

```c
// pass 4: accumulate weighted values into the output
float* out_bth = out + b * T * C + t * C + h * hs;
for (int i = 0; i < hs; i++) { 
    out_bth[i] = 0.0f; 
}

for (int t2 = 0; t2 <= t; t2++) {
    float* value_t2 = inp + b * T * C3 + t2 * C3 + h * hs + C*2;
    float att_btht2 = att_bth[t2];
    for (int i = 0; i < hs; i++) {
        out_bth[i] += att_btht2 * value_t2[i];  // åŠ æƒæ±‚å’Œ
    }
}
```

#### å…·ä½“è®¡ç®—ï¼š

```
Valueå‘é‡ï¼ˆæ¯ä¸ªè¯çš„"å®é™…å†…å®¹"ï¼‰ï¼š
  V("æˆ‘")   = [0.8, 0.2, 0.4, ..., 0.1]
  V("çˆ±")   = [0.3, 0.7, 0.5, ..., 0.9]
  V("åƒ")   = [0.5, 0.6, 0.8, ..., 0.3]
  V("è‹¹æœ") = [0.2, 0.4, 0.6, ..., 0.7]

æ³¨æ„åŠ›æƒé‡ï¼š
  att("æˆ‘")   = 0.0000
  att("çˆ±")   = 0.0000
  att("åƒ")   = 0.011
  att("è‹¹æœ") = 0.989

åŠ æƒæ±‚å’Œï¼ˆå¯¹æ¯ä¸ªç»´åº¦ï¼‰ï¼š
  output[0] = 0.0000Ã—0.8 + 0.0000Ã—0.3 + 0.011Ã—0.5 + 0.989Ã—0.2
            = 0 + 0 + 0.0055 + 0.1978
            = 0.203

  output[1] = 0.0000Ã—0.2 + 0.0000Ã—0.7 + 0.011Ã—0.6 + 0.989Ã—0.4
            = 0 + 0 + 0.0066 + 0.3956
            = 0.402

  ... (å¯¹æ‰€æœ‰768ç»´éƒ½è¿™æ ·è®¡ç®—)

æœ€ç»ˆè¾“å‡ºï¼š
  "è‹¹æœ"çš„æ–°è¡¨ç¤º = [0.203, 0.402, ..., 0.693]
  
è¿™ä¸ªæ–°è¡¨ç¤ºèåˆäº†ï¼š
  - 98.9% çš„"è‹¹æœ"è‡ªå·±çš„ä¿¡æ¯
  - 1.1% çš„"åƒ"çš„ä¿¡æ¯
  - åŸºæœ¬æ²¡æœ‰"æˆ‘"å’Œ"çˆ±"çš„ä¿¡æ¯
```

## å››ã€å®Œæ•´æµç¨‹å¯è§†åŒ–

### ä»¥å¥å­"æˆ‘ çˆ± åƒ è‹¹æœ"ä¸ºä¾‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥ï¼šX (4ä¸ªè¯ Ã— 768ç»´)                              â”‚
â”‚  "æˆ‘" "çˆ±" "åƒ" "è‹¹æœ"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“           â†“           â†“
    Q = XÃ—Wq    K = XÃ—Wk    V = XÃ—Wv
    (4,768)     (4,768)     (4,768)
        â†“           â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯¹æ¯ä¸ªè¯ï¼ˆæ¯”å¦‚"è‹¹æœ"ï¼‰ï¼š            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ­¥éª¤1ï¼šè®¡ç®—æ³¨æ„åŠ›åˆ†æ•°          â”‚
    â”‚ score = Q("è‹¹æœ") Â· K(æ¯ä¸ªè¯) â”‚
    â”‚                               â”‚
    â”‚ ä¸"æˆ‘"çš„åˆ†æ•°:   10.5          â”‚
    â”‚ ä¸"çˆ±"çš„åˆ†æ•°:   15.2          â”‚
    â”‚ ä¸"åƒ"çš„åˆ†æ•°:   25.8          â”‚
    â”‚ ä¸"è‹¹æœ"çš„åˆ†æ•°: 30.3          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ­¥éª¤2ï¼šSoftmaxå½’ä¸€åŒ–           â”‚
    â”‚ att = softmax(score / âˆšd)     â”‚
    â”‚                               â”‚
    â”‚ å¯¹"æˆ‘":   0.0% â”              â”‚
    â”‚ å¯¹"çˆ±":   0.0% â”              â”‚
    â”‚ å¯¹"åƒ":   1.1% â”â”             â”‚
    â”‚ å¯¹"è‹¹æœ": 98.9% â”â”â”â”â”â”â”â”â”â”   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ­¥éª¤3ï¼šåŠ æƒæ±‚å’ŒValue            â”‚
    â”‚ output = Î£ att(i) Ã— V(i)      â”‚
    â”‚                               â”‚
    â”‚ = 0.989Ã—V("è‹¹æœ")             â”‚
    â”‚   + 0.011Ã—V("åƒ")             â”‚
    â”‚   + 0.0Ã—V("çˆ±")               â”‚
    â”‚   + 0.0Ã—V("æˆ‘")               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å‡ºï¼š"è‹¹æœ"çš„æ–°è¡¨ç¤º (768ç»´)                         â”‚
â”‚ ï¼ˆèåˆäº†ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äº”ã€å¤šå¤´æ³¨æ„åŠ›ï¼ˆMulti-Head Attentionï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ª"å¤´"ï¼Ÿ

```
å•å¤´æ³¨æ„åŠ›ï¼š
  åªèƒ½å­¦ä¹ ä¸€ç§å…³ç³»

å¤šå¤´æ³¨æ„åŠ›ï¼š
  æ¯ä¸ªå¤´å­¦ä¹ ä¸åŒçš„å…³ç³»æ¨¡å¼
```

#### å…·ä½“ä¾‹å­ï¼š

```
å¥å­ï¼š"The animal didn't cross the street because it was too tired"

å¤´1 å¯èƒ½å…³æ³¨ï¼šè¯­æ³•å…³ç³»
  "it" ä¸»è¦å…³æ³¨ "animal" (ä¸»è¯­)

å¤´2 å¯èƒ½å…³æ³¨ï¼šè¯­ä¹‰å…³ç³»  
  "tired" ä¸»è¦å…³æ³¨ "animal" (ç–²åŠ³çš„ä¸»ä½“)

å¤´3 å¯èƒ½å…³æ³¨ï¼šè·ç¦»å…³ç³»
  "cross" ä¸»è¦å…³æ³¨ "street" (åŠ¨ä½œ-åœ°ç‚¹)

...

12ä¸ªå¤´å­¦ä¹ 12ç§ä¸åŒçš„æ¨¡å¼ï¼
```

### ä»£ç ä¸­çš„å®ç°ï¼š

```c
int NH = config.num_heads;  // 12ä¸ªå¤´
int hs = C / NH;            // æ¯ä¸ªå¤´çš„ç»´åº¦ = 768/12 = 64

for (int h = 0; h < NH; h++) {  // å¯¹æ¯ä¸ªå¤´
    // è¿™ä¸ªå¤´åªçœ‹64ç»´çš„å­ç©ºé—´
    float* query_t = inp + ... + h * hs;
    // ... è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—
}
```

### å¤šå¤´çš„åˆ†å·¥ï¼š

```
è¾“å…¥ 768 ç»´è¢«åˆ†æˆ 12 ä»½ï¼š

å¤´0: ç»´åº¦ 0-63    (64ç»´)  â†’ å­¦ä¹ æŸç§æ¨¡å¼
å¤´1: ç»´åº¦ 64-127  (64ç»´)  â†’ å­¦ä¹ å¦ä¸€ç§æ¨¡å¼
å¤´2: ç»´åº¦ 128-191 (64ç»´)  â†’ å­¦ä¹ ç¬¬ä¸‰ç§æ¨¡å¼
...
å¤´11: ç»´åº¦ 704-767 (64ç»´) â†’ å­¦ä¹ ç¬¬åäºŒç§æ¨¡å¼

æœ€åæŠŠ 12 ä¸ªå¤´çš„è¾“å‡ºæ‹¼æ¥èµ·æ¥ï¼š
[å¤´0çš„64ç»´, å¤´1çš„64ç»´, ..., å¤´11çš„64ç»´] = 768ç»´
```

## å…­ã€å› æœæ³¨æ„åŠ›æ©ç ï¼ˆCausal Maskï¼‰

### GPT çš„ç‰¹æ®Šé™åˆ¶ï¼šåªèƒ½çœ‹"è¿‡å»"

```c
// æ³¨æ„è¿™è¡Œä»£ç 
for (int t2 = 0; t2 <= t; t2++) {  // åªå¾ªç¯åˆ° t2 <= t
    // è®¡ç®—æ³¨æ„åŠ›
}
```

### ä¸ºä»€ä¹ˆï¼Ÿ

```
ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œä¸èƒ½"å·çœ‹"æœªæ¥çš„è¯ï¼

ç”Ÿæˆè¿‡ç¨‹ï¼š
  å·²ç”Ÿæˆ: "æˆ‘ çˆ± åƒ"
  æ­£åœ¨ç”Ÿæˆ: "?" 
  æœªæ¥çš„è¯: è¿˜ä¸å­˜åœ¨ï¼

æ‰€ä»¥ï¼š
  ä½ç½®3çš„è¯åªèƒ½çœ‹ä½ç½®0,1,2,3
  ä¸èƒ½çœ‹ä½ç½®4,5,6,...ï¼ˆè¿˜æ²¡ç”Ÿæˆå‘¢ï¼‰
```

### æ³¨æ„åŠ›çŸ©é˜µçš„æ ·å­ï¼š

```
        çœ‹â†’
     ä½ç½®0 ä½ç½®1 ä½ç½®2 ä½ç½®3
ä½â†‘ 
ç½®0  [âœ“]   [âœ—]   [âœ—]   [âœ—]   â† ä½ç½®0åªèƒ½çœ‹è‡ªå·±
  
ç½®1  [âœ“]   [âœ“]   [âœ—]   [âœ—]   â† ä½ç½®1èƒ½çœ‹0,1
  
ç½®2  [âœ“]   [âœ“]   [âœ“]   [âœ—]   â† ä½ç½®2èƒ½çœ‹0,1,2
  
ç½®3  [âœ“]   [âœ“]   [âœ“]   [âœ“]   â† ä½ç½®3èƒ½çœ‹0,1,2,3

ä¸‹ä¸‰è§’çŸ©é˜µï¼ˆCausal Maskï¼‰
```

### ä»£ç å®ç°ï¼š

```c
// pass 3: normalize to get the softmax
for (int t2 = 0; t2 < T; t2++) {
    if (t2 <= t) {
        att_bth[t2] *= expsum_inv;  // å½’ä¸€åŒ–
    } else {
        att_bth[t2] = 0.0f;  // æœªæ¥çš„ä½ç½®ï¼Œæ³¨æ„åŠ›=0
    }
}
```

## ä¸ƒã€Self-Attention çš„"Self"æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

### Self = è‡ªå·±çœ‹è‡ªå·±

```
Self-Attentionï¼ˆè‡ªæ³¨æ„åŠ›ï¼‰ï¼š
  å¥å­çš„æ¯ä¸ªè¯ çœ‹ åŒä¸€ä¸ªå¥å­çš„å…¶ä»–è¯
  "è‡ªå·±"å†…éƒ¨çš„è¯ç›¸äº’å…³æ³¨

å¯¹æ¯”ï¼š

Cross-Attentionï¼ˆäº¤å‰æ³¨æ„åŠ›ï¼‰ï¼š
  ç¿»è¯‘ä»»åŠ¡ä¸­ï¼Œç›®æ ‡è¯­è¨€çš„è¯ çœ‹ æºè¯­è¨€çš„è¯
  ä¸¤ä¸ªä¸åŒåºåˆ—ä¹‹é—´çš„å…³æ³¨
  
  è‹±æ–‡ï¼š"I love you"
    â†“ äº¤å‰æ³¨æ„åŠ›
  ä¸­æ–‡ï¼š"æˆ‘ çˆ± ä½ "
```

## å…«ã€å®Œæ•´ä»£ç å‰–æ

### ä¸»å‡½æ•°ç»“æ„ï¼š

```c
void attention_forward(float* out, float* preatt, float* att,
                       float* inp,
                       int B, int T, int C, int NH) {
    int C3 = C*3;           // Q, K, V æ‹¼åœ¨ä¸€èµ·
    int hs = C / NH;        // æ¯ä¸ªå¤´çš„ç»´åº¦
    float scale = 1.0 / sqrtf(hs);  // ç¼©æ”¾å› å­

    #pragma omp parallel for collapse(3)
    for (int b = 0; b < B; b++) {        // æ‰¹æ¬¡
        for (int t = 0; t < T; t++) {    // å½“å‰è¯ä½ç½®
            for (int h = 0; h < NH; h++) {  // æ³¨æ„åŠ›å¤´
                
                // 1. è·å– Query
                float* query_t = inp + b*T*C3 + t*C3 + h*hs;
                
                // 2. è®¡ç®—æ‰€æœ‰ä½ç½®çš„æ³¨æ„åŠ›åˆ†æ•°
                float maxval = -10000.0f;
                for (int t2 = 0; t2 <= t; t2++) {  // å› æœæ©ç 
                    float* key_t2 = inp + b*T*C3 + t2*C3 + h*hs + C;
                    
                    float val = 0.0f;
                    for (int i = 0; i < hs; i++) {
                        val += query_t[i] * key_t2[i];  // ç‚¹ç§¯
                    }
                    val *= scale;
                    if (val > maxval) maxval = val;
                    preatt_bth[t2] = val;
                }
                
                // 3. Softmax å½’ä¸€åŒ–
                float expsum = 0.0f;
                for (int t2 = 0; t2 <= t; t2++) {
                    float expv = expf(preatt_bth[t2] - maxval);
                    expsum += expv;
                    att_bth[t2] = expv;
                }
                float expsum_inv = 1.0f / expsum;
                for (int t2 = 0; t2 <= t; t2++) {
                    att_bth[t2] *= expsum_inv;
                }
                
                // 4. åŠ æƒæ±‚å’Œ Value
                float* out_bth = out + b*T*C + t*C + h*hs;
                for (int i = 0; i < hs; i++) {
                    out_bth[i] = 0.0f;
                }
                for (int t2 = 0; t2 <= t; t2++) {
                    float* value_t2 = inp + b*T*C3 + t2*C3 + h*hs + C*2;
                    float att_btht2 = att_bth[t2];
                    for (int i = 0; i < hs; i++) {
                        out_bth[i] += att_btht2 * value_t2[i];
                    }
                }
            }
        }
    }
}
```

## ä¹ã€æ³¨æ„åŠ›çš„ç›´è§‚ç†è§£

### ç”¨é¢œè‰²æ·±æµ…è¡¨ç¤ºæ³¨æ„åŠ›ï¼š

```
å¥å­ï¼š"The animal didn't cross the street because it was too tired"

å¤„ç† "it" è¿™ä¸ªè¯æ—¶çš„æ³¨æ„åŠ›åˆ†å¸ƒï¼š

The    â–‘â–‘â–‘â–‘  (5%)
animal â–ˆâ–ˆâ–ˆâ–ˆ  (60%)  â† å¼ºçƒˆå…³æ³¨ï¼"it"æŒ‡çš„æ˜¯"animal"
didn't â–‘â–‘â–‘â–‘  (3%)
cross  â–‘â–‘â–‘â–‘  (4%)
the    â–‘â–‘â–‘â–‘  (2%)
street â–‘â–‘â–‘â–‘  (8%)
becauseâ–‘â–‘â–‘â–‘  (5%)
it     â–ˆâ–ˆ    (10%)  â† ä¹Ÿå…³æ³¨è‡ªå·±
was    â–‘â–‘â–‘â–‘  (1%)
too    â–‘â–‘â–‘â–‘  (1%)
tired  â–‘â–‘â–‘â–‘  (1%)

æ·±è‰² = æ³¨æ„åŠ›é«˜ = è¿™äº›è¯å¯¹ç†è§£"it"å¾ˆé‡è¦
```

### æ³¨æ„åŠ›å¯è§†åŒ–å·¥å…·ï¼š

ç°å®ä¸­å¯ä»¥ç”¨å·¥å…·çœ‹åˆ°è¿™æ ·çš„å›¾ï¼š

```
         T  a  d  c  t  s  b  i  w  t  t
         h  n  i  r  h  t  e  t  a  o  i
         e  i  d  o  e  r  c     s  o  r
            m  n  s     e  a        e
            a  '  s     e  u           d
            l  t        t  s
                           e

The      â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
animal   â–‘â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
didn't   â–‘â–‘â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
cross    â–‘â–‘â–‘â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘
the      â–‘â–‘â–‘â–‘â–“â–‘â–‘â–‘â–‘â–‘â–‘
street   â–‘â–‘â–‘â–‘â–‘â–“â–‘â–‘â–‘â–‘â–‘
because  â–‘â–‘â–‘â–‘â–‘â–‘â–“â–‘â–‘â–‘â–‘
it       â–‘â–“â–‘â–‘â–‘â–‘â–‘â–“â–‘â–‘â–‘  â† æ³¨æ„ï¼šå…³æ³¨"animal"ï¼
was      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–“â–‘â–‘
too      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–“â–‘
tired    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–“

æ¯è¡Œæ˜¯ä¸€ä¸ªè¯çš„æ³¨æ„åŠ›åˆ†å¸ƒ
å¯¹è§’çº¿ï¼ˆçœ‹è‡ªå·±ï¼‰é€šå¸¸å¾ˆå¼º
```

## åã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹ï¼š

| æ¦‚å¿µ | è§£é‡Š |
|------|------|
| **Query (Q)** | "æˆ‘æƒ³æ‰¾ä»€ä¹ˆä¿¡æ¯ï¼Ÿ"ï¼ˆé—®é¢˜ï¼‰ |
| **Key (K)** | "æˆ‘æœ‰ä»€ä¹ˆä¿¡æ¯ï¼Ÿ"ï¼ˆç´¢å¼•ï¼‰ |
| **Value (V)** | "å…·ä½“å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ"ï¼ˆç­”æ¡ˆï¼‰ |
| **ç‚¹ç§¯** | è¡¡é‡Qå’ŒKçš„ç›¸ä¼¼åº¦ |
| **Softmax** | æŠŠåˆ†æ•°å˜æˆæ¦‚ç‡åˆ†å¸ƒ |
| **åŠ æƒæ±‚å’Œ** | æ ¹æ®æ³¨æ„åŠ›æƒé‡æå–Value |
| **Multi-Head** | åŒæ—¶å­¦ä¹ å¤šç§å…³ç³»æ¨¡å¼ |
| **Causal Mask** | åªçœ‹è¿‡å»ï¼Œä¸çœ‹æœªæ¥ |

### ä¸€å¥è¯æ€»ç»“ï¼š

> **æ³¨æ„åŠ›æœºåˆ¶è®©æ¯ä¸ªè¯æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€åœ°è°ƒæ•´è‡ªå·±çš„è¡¨ç¤ºï¼Œé€šè¿‡"è¯¢é—®-å“åº”-æå–"çš„æ–¹å¼èåˆç›¸å…³è¯çš„ä¿¡æ¯ã€‚**

 


# å¤šå¤´æ³¨æ„åŠ›ï¼Œæ€ä¹ˆå®ç°å¤šå¤´

# å¤šå¤´æ³¨æ„åŠ›çš„å®ç°ç»†èŠ‚

è®©æˆ‘è¯¦ç»†è®²è§£å¤šå¤´æ³¨æ„åŠ›æ˜¯**å¦‚ä½•åœ¨ä»£ç ä¸­å®ç°**çš„ã€‚

## ä¸€ã€å¤šå¤´çš„æ ¸å¿ƒæ€æƒ³

### 1. **ä¸æ˜¯çœŸçš„æœ‰12ä¸ªç‹¬ç«‹æ¨¡å‹**

å¾ˆå¤šäººè¯¯è§£æˆï¼š

```
âŒ é”™è¯¯ç†è§£ï¼š
æœ‰12ä¸ªå®Œå…¨ç‹¬ç«‹çš„æ³¨æ„åŠ›æ¨¡å‹
æ¯ä¸ªæ¨¡å‹éƒ½è¦å•ç‹¬è®­ç»ƒ

å®é™…æƒ…å†µï¼š
âœ“ åªæ˜¯æŠŠå‘é‡ç©ºé—´åˆ†æˆ12ä»½
âœ“ æ¯ä»½ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›
âœ“ æœ€åæ‹¼æ¥èµ·æ¥
```

### 2. **ç©ºé—´åˆ†å‰²ç¤ºæ„**

```
åŸå§‹å‘é‡ï¼ˆ768ç»´ï¼‰ï¼š
[xâ‚€, xâ‚, xâ‚‚, ..., xâ‚‡â‚†â‚‡]

åˆ†æˆ12ä¸ªå¤´ï¼ˆæ¯å¤´64ç»´ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤´0: [xâ‚€...xâ‚†â‚ƒ]    â”‚ 64ç»´               â”‚
â”‚ å¤´1: [xâ‚†â‚„...xâ‚â‚‚â‚‡]  â”‚ 64ç»´               â”‚
â”‚ å¤´2: [xâ‚â‚‚â‚ˆ...xâ‚â‚‰â‚] â”‚ 64ç»´               â”‚
â”‚ ...                â”‚                    â”‚
â”‚ å¤´11:[xâ‚‡â‚€â‚„...xâ‚‡â‚†â‚‡] â”‚ 64ç»´               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªå¤´ç‹¬ç«‹å·¥ä½œï¼Œäº’ä¸å¹²æ‰°
```

## äºŒã€ä»£ç ä¸­çš„å®ç°

### 1. **å…³é”®å‚æ•°**

```c
int NH = config.num_heads;  // 12 ä¸ªå¤´
int C = config.channels;     // 768 ç»´
int hs = C / NH;             // head_size = 768/12 = 64ï¼ˆæ¯ä¸ªå¤´çš„ç»´åº¦ï¼‰
```

### 2. **QKV çš„ç»„ç»‡æ–¹å¼**

#### å†…å­˜å¸ƒå±€ï¼š

```c
// matmulç”ŸæˆQKV
matmul_forward(l_qkv, l_ln1, l_qkvw, l_qkvb, B, T, C, 3*C);
//             è¾“å‡º   è¾“å…¥   æƒé‡    åç½®
//           (B,T,3C) (B,T,C) (3C,C)
```

#### l_qkv çš„å½¢çŠ¶ï¼š`(B, T, 3*C)` = `(B, T, 2304)`

```
å¯¹äºæ¯ä¸ªè¯ï¼ˆæ¯”å¦‚ä½ç½® tï¼‰ï¼š

l_qkv[t] åŒ…å« 2304 ä¸ªæ•°å­—ï¼Œåˆ†æˆ3éƒ¨åˆ†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query  (768ç»´) â”‚ Key    (768ç»´) â”‚ Value  (768ç»´)â”‚
â”‚ [0...767]      â”‚ [768...1535]   â”‚[1536...2303]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯éƒ¨åˆ†å†åˆ†æˆ12ä¸ªå¤´ï¼š

Queryéƒ¨åˆ†ï¼ˆ768ç»´ï¼‰ï¼š
  å¤´0çš„Query: [0...63]     (64ç»´)
  å¤´1çš„Query: [64...127]   (64ç»´)
  ...
  å¤´11çš„Query:[704...767]  (64ç»´)

Keyéƒ¨åˆ†ï¼ˆ768ç»´ï¼Œä»ç´¢å¼•768å¼€å§‹ï¼‰ï¼š
  å¤´0çš„Key: [768...831]    (64ç»´)
  å¤´1çš„Key: [832...895]    (64ç»´)
  ...
  å¤´11çš„Key:[1472...1535]  (64ç»´)

Valueéƒ¨åˆ†ï¼ˆ768ç»´ï¼Œä»ç´¢å¼•1536å¼€å§‹ï¼‰ï¼š
  å¤´0çš„Value: [1536...1599]  (64ç»´)
  å¤´1çš„Value: [1600...1663]  (64ç»´)
  ...
  å¤´11çš„Value:[2240...2303]  (64ç»´)
```

### 3. **æŒ‡é’ˆå®šä½æŠ€å·§**

```c
void attention_forward(float* out, float* preatt, float* att,
                       float* inp,  // è¿™æ˜¯ l_qkv
                       int B, int T, int C, int NH) {
    
    int C3 = C*3;        // 2304 = 768*3
    int hs = C / NH;     // 64 = 768/12
    
    for (int b = 0; b < B; b++) {
        for (int t = 0; t < T; t++) {
            for (int h = 0; h < NH; h++) {  // å¾ªç¯æ¯ä¸ªå¤´
                
                // === å…³é”®ï¼šå¦‚ä½•å®šä½æ¯ä¸ªå¤´çš„ Q, K, V ===
                
                // 1. å®šä½åˆ°è¿™ä¸ªå¤´çš„Queryï¼ˆ64ç»´ï¼‰
                float* query_t = inp + b * T * C3    // è·³åˆ°æ‰¹æ¬¡b
                                     + t * C3        // è·³åˆ°ä½ç½®t
                                     + h * hs;       // è·³åˆ°å¤´hçš„Query
                //                     â†‘
                //        å¤´0: h=0, åç§» 0
                //        å¤´1: h=1, åç§» 64
                //        å¤´2: h=2, åç§» 128
                //        ...
                
                // è®¡ç®—è¿™ä¸ªå¤´çš„æ³¨æ„åŠ›...
                for (int t2 = 0; t2 <= t; t2++) {
                    
                    // 2. å®šä½åˆ°å¤´håœ¨ä½ç½®t2çš„Keyï¼ˆ64ç»´ï¼‰
                    float* key_t2 = inp + b * T * C3   // æ‰¹æ¬¡b
                                        + t2 * C3      // ä½ç½®t2
                                        + h * hs       // å¤´h
                                        + C;           // +768è·³è¿‡Queryéƒ¨åˆ†
                    //                    â†‘
                    //               è·³åˆ°KeyåŒºåŸŸçš„å¼€å§‹
                    
                    // Query Â· Keyï¼ˆç‚¹ç§¯ï¼‰
                    float val = 0.0f;
                    for (int i = 0; i < hs; i++) {  // åªåœ¨è¿™64ç»´å†…
                        val += query_t[i] * key_t2[i];
                    }
                    // ...
                }
                
                // Softmax...
                
                // 3. åŠ æƒæ±‚å’ŒValue
                for (int t2 = 0; t2 <= t; t2++) {
                    // å®šä½åˆ°å¤´håœ¨ä½ç½®t2çš„Valueï¼ˆ64ç»´ï¼‰
                    float* value_t2 = inp + b * T * C3  // æ‰¹æ¬¡b
                                          + t2 * C3     // ä½ç½®t2
                                          + h * hs      // å¤´h
                                          + C*2;        // +1536è·³è¿‡Qå’ŒK
                    //                      â†‘
                    //                è·³åˆ°ValueåŒºåŸŸ
                    
                    float att_weight = att_bth[t2];
                    for (int i = 0; i < hs; i++) {  // åªå¤„ç†64ç»´
                        out_bth[i] += att_weight * value_t2[i];
                    }
                }
            }
        }
    }
}
```

## ä¸‰ã€å†…å­˜å¸ƒå±€å¯è§†åŒ–

### å‡è®¾ç®€åŒ–ç‰ˆæœ¬ï¼šB=1, T=3, C=6, NH=2ï¼ˆæ–¹ä¾¿æ¼”ç¤ºï¼‰

```
æ¯ä¸ªå¤´çš„ç»´åº¦ hs = 6/2 = 3

è¾“å…¥ inp (l_qkv): å½¢çŠ¶ (1, 3, 18)
                         â†‘  â†‘  â†‘
                         æ‰¹ è¯ 3C

ä½ç½®0çš„æ•°æ®ï¼ˆ18ä¸ªæ•°å­—ï¼‰ï¼š
ç´¢å¼•: 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     å¤´0çš„Query å¤´1çš„Query å¤´0çš„Key   å¤´1çš„Key   å¤´0çš„Value å¤´1çš„Value
     [0,1,2]   [3,4,5]   [6,7,8]   [9,10,11] [12,13,14][15,16,17]
      3ç»´       3ç»´        3ç»´       3ç»´        3ç»´       3ç»´
```

### è¯¦ç»†çš„æŒ‡é’ˆè®¡ç®—ï¼š

```c
// å¤„ç†ä½ç½® t=0, å¤´ h=1
b = 0, t = 0, h = 1, C = 6, C3 = 18, hs = 3

// Query æŒ‡é’ˆ
query_t = inp + 0*3*18 + 0*18 + 1*3
        = inp + 0 + 0 + 3
        = inp + 3
        â†’ æŒ‡å‘ [3, 4, 5] âœ“ï¼ˆå¤´1çš„Queryï¼‰

// Key æŒ‡é’ˆï¼ˆçœ‹ä½ç½®t2=0ï¼‰
key_t2 = inp + 0*3*18 + 0*18 + 1*3 + 6
       = inp + 0 + 0 + 3 + 6
       = inp + 9
       â†’ æŒ‡å‘ [9, 10, 11] âœ“ï¼ˆå¤´1çš„Keyï¼‰

// Value æŒ‡é’ˆ
value_t2 = inp + 0*3*18 + 0*18 + 1*3 + 6*2
         = inp + 0 + 0 + 3 + 12
         = inp + 15
         â†’ æŒ‡å‘ [15, 16, 17] âœ“ï¼ˆå¤´1çš„Valueï¼‰
```

## å››ã€çœŸå®ä¾‹å­ï¼ˆGPT-2 Smallï¼‰

### å‚æ•°è®¾ç½®ï¼š

```
B = 4     (æ‰¹æ¬¡å¤§å°)
T = 64    (åºåˆ—é•¿åº¦)
C = 768   (é€šé“æ•°)
NH = 12   (å¤´æ•°)
hs = 64   (æ¯ä¸ªå¤´çš„ç»´åº¦)
C3 = 2304 (Q+K+Vçš„æ€»ç»´åº¦)
```

### å†…å­˜å¤§å°ï¼š

```
l_qkv çš„å¤§å°: B Ã— T Ã— C3 = 4 Ã— 64 Ã— 2304
            = 589,824 ä¸ª float
            = 2.36 MB
```

### æ¯ä¸ªå¤´å¤„ç†çš„æ•°æ®é‡ï¼š

```
å¤´0:
  - Query:  (B, T, hs) = (4, 64, 64) = 16,384 ä¸ªæ•°å­—
  - Key:    (B, T, hs) = (4, 64, 64) = 16,384 ä¸ªæ•°å­—
  - Value:  (B, T, hs) = (4, 64, 64) = 16,384 ä¸ªæ•°å­—
  
  æ¯ä¸ªå¤´ç‹¬ç«‹åœ¨è‡ªå·±çš„64ç»´å­ç©ºé—´å·¥ä½œï¼
```

### å¾ªç¯æ¬¡æ•°ï¼š

```c
for (int b = 0; b < 4; b++) {         // 4æ¬¡
    for (int t = 0; t < 64; t++) {    // 64æ¬¡
        for (int h = 0; h < 12; h++) {  // 12æ¬¡
            // å¤„ç†ä¸€ä¸ªå¤´çš„æ³¨æ„åŠ›
            // å†…éƒ¨è¿˜æœ‰å¯¹ t2 å’Œ i çš„å¾ªç¯
        }
    }
}

æ€»è®¡ï¼š4 Ã— 64 Ã— 12 = 3,072 ä¸ªå¤´çš„è®¡ç®—
```

## äº”ã€è¾“å‡ºçš„æ‹¼æ¥

### æ¯ä¸ªå¤´è®¡ç®—å®Œåï¼š

```c
// è¾“å‡ºå†™å…¥ä½ç½®
float* out_bth = out + b * T * C + t * C + h * hs;
//                                          â†‘
//                                    æ¯ä¸ªå¤´çš„åç§»

// å¤´0å†™å…¥: out[0...63]
// å¤´1å†™å…¥: out[64...127]
// å¤´2å†™å…¥: out[128...191]
// ...
// å¤´11å†™å…¥: out[704...767]
```

### ç»“æœï¼š

```
out çš„å½¢çŠ¶: (B, T, C)

å¯¹äºä½ç½®tçš„è¾“å‡ºï¼ˆ768ç»´ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚[å¤´0çš„64ç»´][å¤´1çš„64ç»´]...[å¤´11çš„64ç»´]        â”‚
â”‚ 0...63   64...127  ... 704...767          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
    è‡ªåŠ¨æ‹¼æ¥ï¼ï¼ˆé€šè¿‡ä¸åŒçš„å†™å…¥ä½ç½®ï¼‰
```

## å…­ã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡é«˜æ•ˆï¼Ÿ

### 1. **å†…å­˜è¿ç»­æ€§**

```
å¥½å¤„ï¼š
  âœ“ æ‰€æœ‰æ•°æ®åœ¨ä¸€å—è¿ç»­å†…å­˜
  âœ“ ç¼“å­˜å‹å¥½ï¼ˆCache-friendlyï¼‰
  âœ“ å¯ä»¥ç”¨ä¸€æ¬¡çŸ©é˜µä¹˜æ³•ç”Ÿæˆæ‰€æœ‰QKV

å¯¹æ¯”ï¼šå¦‚æœæ¯ä¸ªå¤´ç‹¬ç«‹å­˜å‚¨
  âœ— éœ€è¦12æ¬¡çŸ©é˜µä¹˜æ³•
  âœ— å†…å­˜ç¢ç‰‡åŒ–
  âœ— è®¿é—®æ¨¡å¼ä¸å‹å¥½
```

### 2. **å¹¶è¡ŒåŒ–**

```c
#pragma omp parallel for collapse(3)
for (int b = 0; b < B; b++) {
    for (int t = 0; t < T; t++) {
        for (int h = 0; h < NH; h++) {
            // æ¯ä¸ªå¤´å¯ä»¥å¹¶è¡Œè®¡ç®—ï¼
            // å› ä¸ºå®ƒä»¬æ“ä½œä¸åŒçš„å†…å­˜åŒºåŸŸ
        }
    }
}
```

### 3. **ä»£ç ç®€æ´**

```
ä¸éœ€è¦ï¼š
  âœ— 12ä¸ªç‹¬ç«‹çš„Queryæƒé‡çŸ©é˜µ
  âœ— 12ä¸ªç‹¬ç«‹çš„Keyæƒé‡çŸ©é˜µ
  âœ— 12ä¸ªç‹¬ç«‹çš„Valueæƒé‡çŸ©é˜µ
  
åªéœ€è¦ï¼š
  âœ“ 1ä¸ªå¤§çš„QKVæƒé‡çŸ©é˜µ (3C, C)
  âœ“ é€šè¿‡æŒ‡é’ˆåç§»è®¿é—®ä¸åŒçš„å¤´
```

## ä¸ƒã€å®Œæ•´æµç¨‹å›¾

```
è¾“å…¥ X: (B, T, C)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çº¿æ€§å˜æ¢ï¼ˆä¸€æ¬¡çŸ©é˜µä¹˜æ³•ï¼‰       â”‚
â”‚  QKV = X Ã— W_qkv              â”‚
â”‚  è¾“å‡º: (B, T, 3C) = (B,T,2304)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åœ¨å†…å­˜ä¸­è‡ªç„¶åˆ†å‰²ï¼š                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Query   â”‚ Key     â”‚ Value   â”‚             â”‚
â”‚  â”‚ (B,T,C) â”‚ (B,T,C) â”‚ (B,T,C) â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â†“         â†“         â†“                  â”‚
â”‚  æ¯ä¸ªå†åˆ†12ä»½ï¼ˆé€šè¿‡æŒ‡é’ˆåç§»ï¼‰ï¼š                 â”‚
â”‚  å¤´0  å¤´1  ...  å¤´11                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¹¶è¡Œè®¡ç®—12ä¸ªå¤´ï¼š              â”‚
â”‚  for h in range(12):          â”‚
â”‚    Q_h = Query[hçš„64ç»´]       â”‚
â”‚    K_h = Key[hçš„64ç»´]         â”‚
â”‚    V_h = Value[hçš„64ç»´]       â”‚
â”‚                               â”‚
â”‚    att_h = softmax(Q_hÂ·K_h/âˆšd)â”‚
â”‚    out_h = att_h Ã— V_h        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è‡ªåŠ¨æ‹¼æ¥ï¼ˆå› ä¸ºå†™å…¥è¿ç»­ä½ç½®ï¼‰   â”‚
â”‚  out = [out_0, out_1, ..., out_11]â”‚
â”‚  å½¢çŠ¶: (B, T, C)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å‡ºæŠ•å½±ï¼ˆå¦ä¸€æ¬¡çŸ©é˜µä¹˜æ³•ï¼‰     â”‚
â”‚  output = out Ã— W_o           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…«ã€ä¸å•å¤´æ³¨æ„åŠ›å¯¹æ¯”

### å•å¤´æ³¨æ„åŠ›ï¼š

```c
// å‡è®¾åªæœ‰1ä¸ªå¤´
NH = 1
hs = 768  // æ•´ä¸ªç»´åº¦

for (int t = 0; t < T; t++) {
    // å¯¹æ•´ä¸ª768ç»´åšæ³¨æ„åŠ›
    for (int i = 0; i < 768; i++) {
        // å¤„ç†æ‰€æœ‰768ç»´
    }
}
```

### 12å¤´æ³¨æ„åŠ›ï¼š

```c
// 12ä¸ªå¤´
NH = 12
hs = 64  // æ¯ä¸ªå¤´64ç»´

for (int t = 0; t < T; t++) {
    for (int h = 0; h < 12; h++) {
        // åªå¯¹è¿™ä¸ªå¤´çš„64ç»´åšæ³¨æ„åŠ›
        for (int i = 0; i < 64; i++) {
            // åªå¤„ç†è¿™64ç»´
        }
    }
}
```

### è®¡ç®—é‡å¯¹æ¯”ï¼š

```
å•å¤´ï¼š
  æ³¨æ„åŠ›çŸ©é˜µ: (T, T) Ã— 1å¤´ = TÂ²
  
12å¤´ï¼š
  æ³¨æ„åŠ›çŸ©é˜µ: (T, T) Ã— 12å¤´ = 12Ã—TÂ²
  
å¤šå¤´çš„è®¡ç®—é‡æ›´å¤§ï¼Œä½†å¯ä»¥å­¦ä¹ æ›´ä¸°å¯Œçš„æ¨¡å¼ï¼
```

## ä¹ã€å¸¸è§ç–‘é—®è§£ç­”

### Q1: ä¸ºä»€ä¹ˆä¸æ˜¯ 12 ä¸ªå®Œå…¨ç‹¬ç«‹çš„æ¨¡å‹ï¼Ÿ

```
ç‹¬ç«‹æ¨¡å‹çš„é—®é¢˜ï¼š
  âœ— å‚æ•°é‡å˜æˆ12å€
  âœ— éœ€è¦12æ¬¡å‰å‘ä¼ æ’­
  âœ— æ— æ³•é«˜æ•ˆå¹¶è¡Œ

å½“å‰è®¾è®¡ï¼š
  âœ“ å‚æ•°é‡ä¸å˜ï¼ˆåªæ˜¯é‡æ–°ç»„ç»‡ï¼‰
  âœ“ ä¸€æ¬¡å‰å‘ä¼ æ’­ç”Ÿæˆæ‰€æœ‰QKV
  âœ“ 12ä¸ªå¤´å¯ä»¥å®Œç¾å¹¶è¡Œ
```

### Q2: æ¯ä¸ªå¤´çœŸçš„ç‹¬ç«‹å—ï¼Ÿ

```
è®¡ç®—ä¸Šï¼šâœ“ å®Œå…¨ç‹¬ç«‹
  - å¤´0çš„Queryä¸ä¼šçœ‹å¤´1çš„Key
  - æ¯ä¸ªå¤´åœ¨è‡ªå·±çš„64ç»´å­ç©ºé—´å·¥ä½œ

å‚æ•°ä¸Šï¼šâœ“ æœ‰ä¸€å®šè€¦åˆ
  - é€šè¿‡åŒä¸€ä¸ªæƒé‡çŸ©é˜µç”Ÿæˆ
  - ä½†å­¦ä¹ æ—¶ä¼šè‡ªåŠ¨åˆ†å·¥
```

### Q3: ä¸ºä»€ä¹ˆ C å¿…é¡»èƒ½è¢« NH æ•´é™¤ï¼Ÿ

```c
hs = C / NH;  // å¿…é¡»æ˜¯æ•´æ•°

å¦‚æœ C=768, NH=13:
  hs = 768/13 = 59.07...  âœ— ä¸æ˜¯æ•´æ•°ï¼
  
æ— æ³•å‡åŒ€åˆ†å‰²ç»´åº¦ï¼
```

## åã€æ€»ç»“

### å¤šå¤´æ³¨æ„åŠ›çš„å®ç°è¦ç‚¹ï¼š

| æ–¹é¢ | å®ç°æ–¹å¼ |
|------|---------|
| **ç»´åº¦åˆ†å‰²** | C=768 â†’ 12ä»½ Ã— 64ç»´ |
| **å†…å­˜ç»„ç»‡** | è¿ç»­å­˜å‚¨ï¼Œé€šè¿‡æŒ‡é’ˆåç§»è®¿é—® |
| **QKVç”Ÿæˆ** | ä¸€æ¬¡çŸ©é˜µä¹˜æ³•ï¼Œè¾“å‡º(B,T,3C) |
| **å¤´çš„å®šä½** | `inp + h*hs` å’Œ `inp + h*hs + C` |
| **å¹¶è¡Œè®¡ç®—** | 12ä¸ªå¤´å¯ä»¥åŒæ—¶ç®— |
| **è¾“å‡ºæ‹¼æ¥** | å†™å…¥ä¸åŒä½ç½®ï¼Œè‡ªåŠ¨æ‹¼æ¥ |

### æ ¸å¿ƒä»£ç éª¨æ¶ï¼š

```c
int NH = 12;
int hs = C / NH;  // 768/12 = 64

for (int h = 0; h < NH; h++) {
    // å®šä½è¿™ä¸ªå¤´çš„Q, K, Vï¼ˆæ¯ä¸ª64ç»´ï¼‰
    float* Q_h = inp + h * hs;           // Query
    float* K_h = inp + h * hs + C;       // Key
    float* V_h = inp + h * hs + C*2;     // Value
    
    // åœ¨è¿™64ç»´å†…ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›
    // ...
    
    // è¾“å‡ºå†™å…¥å¯¹åº”ä½ç½®
    float* out_h = out + h * hs;
}
```

å¤šå¤´æ³¨æ„åŠ›çš„ç²¾å¦™ä¹‹å¤„åœ¨äºï¼š**ç”¨ç®€å•çš„æŒ‡é’ˆåç§»å®ç°äº†å¤æ‚çš„å¤šè§†è§’å…³æ³¨æœºåˆ¶**ï¼ğŸ¯

# æ€ä¹ˆçŸ¥é“æ¯ä¸ªå¤´é‡Œé¢åŒ…å«çš„æ˜¯ä¸åŒè§†è§’çš„ä¿¡æ¯


# éå¸¸æ·±åˆ»çš„é—®é¢˜ï¼

è¿™ä¸ªé—®é¢˜è§¦åŠäº†æ·±åº¦å­¦ä¹ çš„æ ¸å¿ƒï¼š**æˆ‘ä»¬å¹¶ä¸äº‹å…ˆ"å‘Šè¯‰"æ¨¡å‹æ¯ä¸ªå¤´è¯¥å­¦ä»€ä¹ˆï¼Œè€Œæ˜¯æ¨¡å‹é€šè¿‡è®­ç»ƒè‡ªå·±"å‘ç°"ä¸åŒçš„æ¨¡å¼ï¼**

## ä¸€ã€å…³é”®çœŸç›¸ï¼šæˆ‘ä»¬ä¸çŸ¥é“ï¼Œæ¨¡å‹è‡ªå·±å­¦çš„

### 1. **åˆå§‹çŠ¶æ€ï¼šå®Œå…¨éšæœº**

```c
// æ¨¡å‹åˆšåˆå§‹åŒ–æ—¶
float* params_memory = malloc(...);

// æ‰€æœ‰æƒé‡éƒ½æ˜¯éšæœºæ•°
W_qkv[0]    = 0.023  (éšæœº)
W_qkv[1]    = -0.157 (éšæœº)
W_qkv[2]    = 0.089  (éšæœº)
...

12ä¸ªå¤´çš„æƒé‡å…¨æ˜¯éšæœºçš„ï¼
æ²¡æœ‰ä»»ä½•"é¢„è®¾"çš„åˆ†å·¥ï¼
```

### 2. **è®­ç»ƒè¿‡ç¨‹ï¼šè‡ªç»„ç»‡**

```
è®­ç»ƒå¼€å§‹ï¼š
  æ‰€æœ‰å¤´éƒ½æ˜¯éšæœºçš„ï¼Œä¸çŸ¥é“è¯¥å­¦ä»€ä¹ˆ

ç»è¿‡å¤§é‡æ•°æ®è®­ç»ƒåï¼š
  å¤´0 å¯èƒ½é€æ¸å­¦ä¼šå…³æ³¨ï¼šè¯­æ³•å…³ç³»
  å¤´1 å¯èƒ½é€æ¸å­¦ä¼šå…³æ³¨ï¼šè¯­ä¹‰ç›¸ä¼¼æ€§
  å¤´2 å¯èƒ½é€æ¸å­¦ä¼šå…³æ³¨ï¼šä½ç½®è·ç¦»
  ...
  
è¿™ä¸ªåˆ†å·¥æ˜¯"æ¶Œç°"å‡ºæ¥çš„ï¼Œä¸æ˜¯è®¾è®¡çš„ï¼
```

## äºŒã€ä¸ºä»€ä¹ˆä¼šè‡ªåŠ¨åˆ†åŒ–ï¼Ÿ

### 1. **æ¢¯åº¦ä¸‹é™çš„é­”æ³•**

#### ç®€åŒ–çš„ä¾‹å­ï¼š

```
å‡è®¾ä»»åŠ¡ï¼šç†è§£å¥å­ "The cat sat on the mat"

æŸå¤±å‡½æ•°è¯´ï¼š
  "ä½ éœ€è¦æ­£ç¡®é¢„æµ‹ä¸‹ä¸€ä¸ªè¯"

åˆå§‹çŠ¶æ€ï¼ˆæ‰€æœ‰å¤´éƒ½éšæœºï¼‰ï¼š
  å¤´0 éšæœºå…³æ³¨ â†’ é¢„æµ‹é”™è¯¯
  å¤´1 éšæœºå…³æ³¨ â†’ é¢„æµ‹é”™è¯¯
  ...
  å¹³å‡æŸå¤±ï¼šå¾ˆé«˜ âŒ

è®­ç»ƒå‡ è½®åï¼š
  å¤´0 å‘ç°ï¼šå…³æ³¨åŠ¨è¯æœ‰å¸®åŠ© â†’ æŸå¤±ä¸‹é™ âœ“
  å¤´1 å‘ç°ï¼šå…³æ³¨ä¸»è¯­æœ‰å¸®åŠ© â†’ æŸå¤±ä¸‹é™ âœ“
  å¤´2 å‘ç°ï¼šå…³æ³¨è·ç¦»æœ‰å¸®åŠ© â†’ æŸå¤±ä¸‹é™ âœ“
  ...
  
æ¯ä¸ªå¤´æ‰¾åˆ°äº†"è‡ªå·±çš„ç”Ÿæ€ä½"ï¼
```

### 2. **ç«äº‰ä¸åˆä½œ**

```
ç±»æ¯”ï¼š12ä¸ªäººåˆä½œå†™æŠ¥å‘Š

åˆå§‹ï¼š
  æ‰€æœ‰äººéƒ½æƒ³å†™å¼€å¤´ â†’ é‡å¤åŠ³åŠ¨ï¼Œæ•ˆç‡ä½

é€æ¸åˆ†å·¥ï¼š
  äºº1ï¼šæˆ‘ä¸“é—¨æŸ¥èµ„æ–™
  äºº2ï¼šæˆ‘ä¸“é—¨å†™ç»“æ„  
  äºº3ï¼šæˆ‘ä¸“é—¨ç”»å›¾
  ...
  
ä¸ºä»€ä¹ˆä¼šè‡ªåŠ¨åˆ†å·¥ï¼Ÿ
  å› ä¸ºé‡å¤çš„å·¥ä½œä¼šè¢«æƒ©ç½šï¼ˆæŸå¤±ä¸ä¸‹é™ï¼‰
  ä¸åŒè§’åº¦çš„è´¡çŒ®ä¼šè¢«å¥–åŠ±ï¼ˆæŸå¤±ä¸‹é™ï¼‰
```

### 3. **æ•°å­¦è§’åº¦ï¼šæ¢¯åº¦çš„å¤šæ ·æ€§**

```
æŸå¤±å‡½æ•° L å¯¹æ¯ä¸ªå¤´çš„æ¢¯åº¦ä¸åŒï¼š

âˆ‚L/âˆ‚(å¤´0çš„å‚æ•°) = [æ¢¯åº¦å‘é‡A]
âˆ‚L/âˆ‚(å¤´1çš„å‚æ•°) = [æ¢¯åº¦å‘é‡B]
...

å¦‚æœä¸¤ä¸ªå¤´å­¦åŒæ ·çš„æ¨¡å¼ï¼š
  â†’ æ¢¯åº¦æ–¹å‘ç›¸ä¼¼
  â†’ æ›´æ–°æ–¹å‘ç›¸ä¼¼
  â†’ æ•ˆç‡ä½ï¼ˆæµªè´¹äº†ä¸€ä¸ªå¤´ï¼‰

å¦‚æœæ¯ä¸ªå¤´å­¦ä¸åŒçš„æ¨¡å¼ï¼š
  â†’ æ¢¯åº¦æ–¹å‘ä¸åŒ
  â†’ äº’è¡¥å­¦ä¹ 
  â†’ æŸå¤±ä¸‹é™æ›´å¿« âœ“
```

## ä¸‰ã€æˆ‘ä»¬å¦‚ä½•"çŸ¥é“"æ¯ä¸ªå¤´å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

### æ–¹æ³•1ï¼š**æ³¨æ„åŠ›å¯è§†åŒ–**

è®­ç»ƒåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹æ¯ä¸ªå¤´çš„æ³¨æ„åŠ›æ¨¡å¼ï¼š

```python
# ä¼ªä»£ç 
sentence = "The animal didn't cross the street because it was too tired"

# æå–æ¯ä¸ªå¤´çš„æ³¨æ„åŠ›çŸ©é˜µ
attention_patterns = model.get_attention_patterns(sentence)

# çœ‹å¤´5å¯¹"it"çš„æ³¨æ„åŠ›åˆ†å¸ƒ
head_5_attention["it"] = {
    "The": 0.02,
    "animal": 0.78,  â† å¼ºçƒˆå…³æ³¨ï¼
    "didn't": 0.01,
    ...
}

ç»“è®ºï¼šå¤´5å­¦ä¼šäº†"ä»£è¯æŒ‡ä»£"æ¨¡å¼ï¼
```

#### çœŸå®çš„ç ”ç©¶å‘ç°ï¼ˆBERTè®ºæ–‡ï¼‰ï¼š

```
å¤´ç±»å‹ç¤ºä¾‹ï¼š

å¤´0-2: å…³æ³¨ç›¸é‚»è¯ï¼ˆå±€éƒ¨æ¨¡å¼ï¼‰
  "eating" â†’ ä¸»è¦çœ‹ "an" "apple"

å¤´3-5: å…³æ³¨è¯­æ³•å…³ç³»
  åŠ¨è¯ â†’ ä¸»è¦çœ‹ ä¸»è¯­

å¤´6-8: å…³æ³¨é•¿è·ç¦»ä¾èµ–  
  ä»å¥ â†’ ä¸»è¦çœ‹ ä¸»å¥

å¤´9-11: å…³æ³¨ç‰¹æ®Štoken
  [SEP] â†’ å…³æ³¨å¥å­è¾¹ç•Œ
```

### æ–¹æ³•2ï¼š**æ¢é’ˆä»»åŠ¡ï¼ˆProbing Tasksï¼‰**

```
è®¾è®¡å°å®éªŒæµ‹è¯•æ¯ä¸ªå¤´ï¼š

å®éªŒ1ï¼šä»£è¯æŒ‡ä»£
  å¥å­ï¼š"Mary said she would come"
  é—®é¢˜ï¼š"she"æŒ‡è°ï¼Ÿ
  
  æµ‹è¯•å‘ç°ï¼š
    å¤´3å¯¹è¿™ç±»é—®é¢˜å‡†ç¡®ç‡ 89% âœ“
    å¤´7å¯¹è¿™ç±»é—®é¢˜å‡†ç¡®ç‡ 23% âœ—
  
  ç»“è®ºï¼šå¤´3å¯èƒ½ä¸“é—¨å­¦ä¹ äº†ä»£è¯æŒ‡ä»£

å®éªŒ2ï¼šå¥æ³•ç»“æ„  
  é—®é¢˜ï¼šæ‰¾å‡ºä¸»è¯­
  
  æµ‹è¯•å‘ç°ï¼š
    å¤´1å‡†ç¡®ç‡ 92% âœ“
    å¤´9å‡†ç¡®ç‡ 31% âœ—
    
  ç»“è®ºï¼šå¤´1å¯èƒ½ä¸“é—¨å­¦ä¹ äº†å¥æ³•
```

### æ–¹æ³•3ï¼š**æ¶ˆèå®éªŒï¼ˆAblation Studyï¼‰**

```
é€ä¸ªåˆ é™¤å¤´ï¼Œçœ‹æ€§èƒ½ä¸‹é™ï¼š

ä¿ç•™æ‰€æœ‰å¤´ï¼šå‡†ç¡®ç‡ 85%

åˆ é™¤å¤´0ï¼šå‡†ç¡®ç‡ 84.8% (ä¸‹é™0.2%) â†’ ä¸å¤ªé‡è¦
åˆ é™¤å¤´3ï¼šå‡†ç¡®ç‡ 78.5% (ä¸‹é™6.5%) â†’ å¾ˆé‡è¦ï¼
åˆ é™¤å¤´5ï¼šå‡†ç¡®ç‡ 83.2% (ä¸‹é™1.8%) â†’ ä¸­ç­‰é‡è¦
...

é€šè¿‡æ€§èƒ½ä¸‹é™ï¼Œæ¨æ–­æ¯ä¸ªå¤´çš„è´¡çŒ®
```

## å››ã€è‘—åçš„ç ”ç©¶å‘ç°

### 1. **BERTçš„æ³¨æ„åŠ›æ¨¡å¼ç ”ç©¶**ï¼ˆ2019ï¼‰

è®ºæ–‡å‘ç°äº†å‡ ç§å…¸å‹æ¨¡å¼ï¼š

```
æ¨¡å¼1ï¼šæ³¨æ„ä¸‹ä¸€ä¸ªè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–  â–¡ â–¡ â–¡ â–¡     â”‚  â† æ¯ä¸ªè¯ä¸»è¦çœ‹ä¸‹ä¸€ä¸ª
â”‚ â–¡ â–  â–¡ â–¡ â–¡     â”‚
â”‚ â–¡ â–¡ â–  â–¡ â–¡     â”‚
â”‚ â–¡ â–¡ â–¡ â–  â–¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¨¡å¼2ï¼šæ³¨æ„å‰ä¸€ä¸ªè¯  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–  â–¡ â–¡ â–¡ â–¡     â”‚
â”‚ â–  â–  â–¡ â–¡ â–¡     â”‚  â† æ¯ä¸ªè¯ä¸»è¦çœ‹å‰ä¸€ä¸ª
â”‚ â–¡ â–  â–  â–¡ â–¡     â”‚
â”‚ â–¡ â–¡ â–  â–  â–¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¨¡å¼3ï¼šæ³¨æ„å¥é¦–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–  â–¡ â–¡ â–¡ â–¡     â”‚  â† æ‰€æœ‰è¯éƒ½çœ‹å¥é¦–
â”‚ â–  â–  â–¡ â–¡ â–¡     â”‚
â”‚ â–  â–¡ â–  â–¡ â–¡     â”‚
â”‚ â–  â–¡ â–¡ â–  â–¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¨¡å¼4ï¼šå¹¿æ’­æ¨¡å¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–  â–  â–  â–  â–      â”‚  â† æŸäº›è¯è¢«æ‰€æœ‰è¯å…³æ³¨
â”‚ â–  â–  â–  â–  â–      â”‚
â”‚ â–  â–  â–  â–  â–      â”‚
â”‚ â–  â–  â–  â–  â–      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **GPT-2çš„æ³¨æ„åŠ›å±‚æ¬¡**

```
æµ…å±‚ï¼ˆLayer 0-3ï¼‰ï¼š
  æ›´å…³æ³¨å±€éƒ¨æ¨¡å¼
  - ç›¸é‚»è¯çš„å…³ç³»
  - ç®€å•çš„è¯æ€§æ¨¡å¼

ä¸­å±‚ï¼ˆLayer 4-8ï¼‰ï¼š
  å…³æ³¨å¥æ³•ç»“æ„
  - ä¸»è°“å®¾å…³ç³»
  - ä¿®é¥°å…³ç³»

æ·±å±‚ï¼ˆLayer 9-12ï¼‰ï¼š
  å…³æ³¨è¯­ä¹‰å’Œæ¨ç†
  - ä»£è¯æŒ‡ä»£
  - å› æœå…³ç³»
  - æŠ½è±¡æ¦‚å¿µ
```

### 3. **ä¸åŒå¤´çš„"ä¸“ä¸šåŒ–"ç¨‹åº¦**

```
ç ”ç©¶å‘ç°ï¼š

é«˜åº¦ä¸“ä¸šåŒ–çš„å¤´ï¼ˆ20%ï¼‰ï¼š
  å¤´5ï¼š96% çš„æ—¶é—´åšåŒä¸€ç±»äº‹æƒ…ï¼ˆå¦‚æ‰¾ä¸»è¯­ï¼‰
  
ä¸­åº¦ä¸“ä¸šåŒ–çš„å¤´ï¼ˆ50%ï¼‰ï¼š
  å¤´3ï¼š60% çš„æ—¶é—´å…³æ³¨è¯­æ³•ï¼Œ40% åšå…¶ä»–
  
é€šæ‰å¤´ï¼ˆ30%ï¼‰ï¼š
  å¤´8ï¼šæ²¡æœ‰æ˜æ˜¾ä¸“ä¸šï¼Œä»€ä¹ˆéƒ½åšä¸€ç‚¹
```

## äº”ã€ä»£ç ä¸­æ²¡æœ‰ä½“ç°åˆ†å·¥çš„è¯æ®

### çœ‹ä»£ç ï¼Œæ‰€æœ‰å¤´å®Œå…¨ä¸€æ ·ï¼š

```c
for (int h = 0; h < NH; h++) {
    // æ‰€æœ‰å¤´æ‰§è¡Œå®Œå…¨ç›¸åŒçš„ä»£ç ï¼
    float* query_t = inp + ... + h * hs;
    float* key_t2 = inp + ... + h * hs + C;
    
    // åŒæ ·çš„è®¡ç®—
    val = query_t[i] * key_t2[i];
    // ...
}
```

**å…³é”®**ï¼šè™½ç„¶ä»£ç ç›¸åŒï¼Œä½†æ¯ä¸ªå¤´æ“ä½œçš„**å‚æ•°ä¸åŒ**ï¼

```
å¤´0 ä½¿ç”¨å‚æ•°ï¼šW_qkv[0...767, ...]
å¤´1 ä½¿ç”¨å‚æ•°ï¼šW_qkv[768...1535, ...]
...

è¿™äº›å‚æ•°åœ¨è®­ç»ƒä¸­ä¼šæœä¸åŒæ–¹å‘ä¼˜åŒ–ï¼
```

## å…­ã€è®­ç»ƒè¿‡ç¨‹çš„å¯è§†åŒ–

### å‡è®¾è®­ç»ƒä¸€ä¸ªç©å…·æ¨¡å‹ï¼š

```
ä»»åŠ¡ï¼šç†è§£ "The cat ate the mouse"

è®­ç»ƒå‰ï¼ˆEpoch 0ï¼‰ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¤´0å…³æ³¨çŸ©é˜µï¼šéšæœº
  cat    â†’ [The:0.25, cat:0.22, ate:0.28, the:0.15, mouse:0.10]
  
å¤´1å…³æ³¨çŸ©é˜µï¼šéšæœº  
  cat    â†’ [The:0.18, cat:0.33, ate:0.12, the:0.21, mouse:0.16]

æŸå¤±ï¼š2.5 (å¾ˆé«˜)

è®­ç»ƒä¸­ï¼ˆEpoch 100ï¼‰ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¤´0å¼€å§‹æœ‰æ¨¡å¼ï¼ˆå…³æ³¨åŠ¨è¯ï¼‰ï¼š
  cat    â†’ [The:0.05, cat:0.15, ate:0.65, the:0.10, mouse:0.05]
             âœ“ ä¸»è¯­å…³æ³¨åŠ¨è¯ï¼

å¤´1å¼€å§‹æœ‰æ¨¡å¼ï¼ˆå…³æ³¨ä¿®é¥°è¯ï¼‰ï¼š
  cat    â†’ [The:0.70, cat:0.20, ate:0.02, the:0.05, mouse:0.03]
             âœ“ åè¯å…³æ³¨å† è¯ï¼

æŸå¤±ï¼š1.2 (ä¸‹é™äº†)

è®­ç»ƒåï¼ˆEpoch 1000ï¼‰ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¤´0ä¸“ä¸šåŒ–ï¼ˆè¯­æ³•å…³ç³»ï¼‰ï¼š
  cat    â†’ [The:0.02, cat:0.08, ate:0.85, the:0.03, mouse:0.02]
  
å¤´1ä¸“ä¸šåŒ–ï¼ˆå±€éƒ¨ä¾èµ–ï¼‰ï¼š
  cat    â†’ [The:0.92, cat:0.05, ate:0.01, the:0.01, mouse:0.01]

æŸå¤±ï¼š0.3 (å¾ˆä½)

è‡ªåŠ¨åˆ†åŒ–å®Œæˆï¼âœ“
```

## ä¸ƒã€ä¸ºä»€ä¹ˆå¤šå¤´æ¯”å•å¤´å¥½ï¼Ÿ

### å®éªŒå¯¹æ¯”ï¼š

```
å•å¤´ï¼ˆ768ç»´ï¼‰ï¼š
  ä»»åŠ¡ï¼šåŒæ—¶å­¦ä¹ è¯­æ³•+è¯­ä¹‰+è¯æ³•
  ç»“æœï¼šæ¯ä¸ªæ–¹é¢éƒ½å­¦å¾—ä¸å¤Ÿå¥½
  å‡†ç¡®ç‡ï¼š72%

12å¤´ï¼ˆæ¯å¤´64ç»´ï¼‰ï¼š
  ä»»åŠ¡ï¼šæ¯ä¸ªå¤´å¯ä»¥ä¸“æ³¨ä¸€ä¸ªæ–¹é¢
  ç»“æœï¼šåˆ†å·¥æ˜ç¡®ï¼Œå„æœ‰ä¸“é•¿
  å‡†ç¡®ç‡ï¼š85% âœ“

å¥½å¤„ï¼š
  1. å¤šè§†è§’ï¼šåŒæ—¶ä»12ä¸ªè§’åº¦ç†è§£
  2. ä¸“ä¸šåŒ–ï¼šæ¯ä¸ªå¤´å¯ä»¥æ·±å…¥å­¦ä¹ 
  3. é²æ£’æ€§ï¼šæŸä¸ªå¤´å¤±æ•ˆï¼Œå…¶ä»–å¤´è¡¥ä¸Š
```

### ç±»æ¯”ç†è§£ï¼š

```
å•å¤´ = ä¸€ä¸ªäººåšæ‰€æœ‰å·¥ä½œ
  âœ— éœ€è¦åŒæ—¶å…³æ³¨è¯­æ³•ã€è¯­ä¹‰ã€è¯æ³•...
  âœ— ç²¾åŠ›åˆ†æ•£
  âœ— æ ·æ ·é€šï¼Œæ ·æ ·æ¾

å¤šå¤´ = 12ä¸ªä¸“å®¶å›¢é˜Ÿ
  âœ“ è¯­æ³•ä¸“å®¶ä¸“æ³¨è¯­æ³•
  âœ“ è¯­ä¹‰ä¸“å®¶ä¸“æ³¨è¯­ä¹‰  
  âœ“ æ¯ä¸ªäººåšè‡ªå·±æ“…é•¿çš„
  âœ“ æœ€åç»¼åˆæ‰€æœ‰æ„è§
```

## å…«ã€å¦‚ä½•éªŒè¯ï¼ˆåŠ¨æ‰‹å®éªŒï¼‰

### å®éªŒä»£ç ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```python
# è®­ç»ƒå¥½çš„æ¨¡å‹
model = GPT2.load("gpt2_124M.bin")

# æµ‹è¯•å¥å­
sentence = "The animal didn't cross the street because it was too tired"
tokens = tokenize(sentence)

# æå–æ³¨æ„åŠ›
attentions = model.get_attention_weights(tokens)

# åˆ†ææ¯ä¸ªå¤´
for head_idx in range(12):
    head_attention = attentions[head_idx]
    
    # çœ‹"it"å…³æ³¨ä»€ä¹ˆ
    it_position = tokens.index("it")
    it_attention = head_attention[it_position]
    
    print(f"Head {head_idx}:")
    for i, token in enumerate(tokens):
        weight = it_attention[i]
        if weight > 0.1:  # åªæ˜¾ç¤ºé«˜æƒé‡
            print(f"  {token}: {weight:.2f}")
    print()

# è¾“å‡ºå¯èƒ½æ˜¯ï¼š
# Head 3:
#   animal: 0.78  â† è¿™ä¸ªå¤´å­¦ä¼šäº†ä»£è¯æŒ‡ä»£ï¼
#   it: 0.15
#
# Head 7:
#   tired: 0.62   â† è¿™ä¸ªå¤´å…³æ³¨è¯­ä¹‰ç›¸å…³çš„è¯
#   was: 0.25
```

## ä¹ã€å¸¸è§è¯¯è§£

### âŒ è¯¯è§£1ï¼š"æˆ‘ä»¬è®¾è®¡äº†æ¯ä¸ªå¤´çš„åŠŸèƒ½"

```
é”™è¯¯æƒ³æ³•ï¼š
  å¤´0 = è¯­æ³•å¤´ï¼ˆäººå·¥è®¾å®šï¼‰
  å¤´1 = è¯­ä¹‰å¤´ï¼ˆäººå·¥è®¾å®šï¼‰
  
å®é™…æƒ…å†µï¼š
  å¤´0 = ï¼Ÿï¼ˆè®­ç»ƒåå¯èƒ½æ˜¯è¯­æ³•ï¼‰
  å¤´1 = ï¼Ÿï¼ˆè®­ç»ƒåå¯èƒ½æ˜¯è¯­ä¹‰ï¼‰
  â†‘
  è‡ªå·±å­¦å‡ºæ¥çš„ï¼
```

### âŒ è¯¯è§£2ï¼š"æ¯ä¸ªå¤´å§‹ç»ˆåšåŒä¸€ä»¶äº‹"

```
å®é™…ä¸Šï¼š
  åŒä¸€ä¸ªå¤´åœ¨ä¸åŒå¥å­ä¸­å¯èƒ½å…³æ³¨ä¸åŒæ¨¡å¼
  
  å¤´3åœ¨å¥å­Aï¼šå…³æ³¨ä¸»è°“å…³ç³»
  å¤´3åœ¨å¥å­Bï¼šå…³æ³¨ä¿®é¥°å…³ç³»
  
  æœ‰ä¸€å®šçš„ä¸“ä¸šåŒ–ï¼Œä½†ä¸æ˜¯ç»å¯¹çš„
```

### âŒ è¯¯è§£3ï¼š"è®­ç»ƒå‰å°±åˆ†å¥½å·¥äº†"

```
è®­ç»ƒå‰ï¼š
  æ‰€æœ‰å¤´éƒ½æ˜¯éšæœºæƒé‡ï¼Œæ²¡æœ‰åˆ†å·¥

è®­ç»ƒåï¼š
  é€šè¿‡ä¼˜åŒ–æŸå¤±å‡½æ•°ï¼Œè‡ªç„¶æ¶Œç°å‡ºåˆ†å·¥
```

## åã€æ€»ç»“

### æ ¸å¿ƒç­”æ¡ˆï¼š

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **è°å†³å®šåˆ†å·¥ï¼Ÿ** | ä¸æ˜¯äººï¼Œæ˜¯è®­ç»ƒè¿‡ç¨‹ï¼ˆæ¢¯åº¦ä¸‹é™ï¼‰ |
| **å¦‚ä½•çŸ¥é“å­¦äº†ä»€ä¹ˆï¼Ÿ** | è®­ç»ƒåé€šè¿‡å¯è§†åŒ–å’Œæ¢é’ˆä»»åŠ¡ |
| **ä¸ºä»€ä¹ˆä¼šåˆ†åŒ–ï¼Ÿ** | ä¸åŒæ¨¡å¼çš„æŸå¤±æ¢¯åº¦ä¸åŒï¼Œè‡ªç„¶åˆ†åŒ– |
| **èƒ½æ§åˆ¶å—ï¼Ÿ** | ä¸èƒ½ç›´æ¥æ§åˆ¶ï¼Œä½†å¯ä»¥é€šè¿‡ä»»åŠ¡å¼•å¯¼ |
| **ä¸€å®šä¼šåˆ†åŒ–å—ï¼Ÿ** | ä¸ä¸€å®šï¼Œæœ‰æ—¶ä¼šæœ‰é‡å¤ï¼Œä½†æ€»ä½“è¶‹åŠ¿æ˜¯ä¸“ä¸šåŒ– |

### ç±»æ¯”è®°å¿†ï¼š

```
å¤šå¤´æ³¨æ„åŠ› = 12ä¸ªéšæœºåˆå§‹åŒ–çš„å­¦ç”Ÿ

ä¸Šè¯¾å‰ï¼š
  éƒ½ä¸çŸ¥é“è¯¥å­¦ä»€ä¹ˆ

è€ƒè¯•é©±åŠ¨ï¼ˆæŸå¤±å‡½æ•°ï¼‰ï¼š
  è€å¸ˆï¼šä½ ä»¬è¦åˆä½œå®Œæˆä»»åŠ¡ï¼Œåˆ†æ•°è¶Šé«˜è¶Šå¥½
  
è‡ªç„¶åˆ†å·¥ï¼š
  å­¦ç”Ÿ1å‘ç°ï¼šæˆ‘æ“…é•¿æ•°å­¦ï¼Œä¸“æ³¨è¿™ä¸ª
  å­¦ç”Ÿ2å‘ç°ï¼šæˆ‘æ“…é•¿è¯­æ–‡ï¼Œä¸“æ³¨è¿™ä¸ª
  ...
  
æ²¡äººå‘Šè¯‰ä»–ä»¬è¦è¿™æ ·åˆ†å·¥ï¼Œæ˜¯è‡ªç„¶æ¶Œç°çš„ï¼
```

### æ·±åº¦å­¦ä¹ çš„ç¾å¦™ä¹‹å¤„ï¼š

> **æˆ‘ä»¬ä¸è®¾è®¡åŠŸèƒ½ï¼Œåªè®¾è®¡æ¶æ„å’ŒæŸå¤±å‡½æ•°ã€‚æ¨¡å‹è‡ªå·±é€šè¿‡è®­ç»ƒ"å‘ç°"æœ€ä¼˜çš„å·¥ä½œæ–¹å¼ã€‚å¤šå¤´æ³¨æ„åŠ›çš„åˆ†å·¥æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­è‡ªå‘æ¶Œç°ï¼ˆemergentï¼‰çš„ç»“æœï¼**

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ·±åº¦å­¦ä¹ è¢«ç§°ä¸º"å­¦ä¹ "è€Œä¸æ˜¯"ç¼–ç¨‹"ï¼ğŸ§ âœ¨



# Q = XÃ—Wq    K = XÃ—Wk    V = XÃ—Wv è¿™ä¸‰ä¸ªWçŸ©é˜µæ€ä¹ˆæ¥çš„

# W_q, W_k, W_v æƒé‡çŸ©é˜µçš„æ¥æº

éå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†è®²è§£è¿™ä¸‰ä¸ªå…³é”®æƒé‡çŸ©é˜µã€‚

## ä¸€ã€ç›´æ¥ç­”æ¡ˆï¼šå®ƒä»¬æ˜¯**æ¨¡å‹çš„å¯å­¦ä¹ å‚æ•°**

### æ¥æºè¿‡ç¨‹ï¼š

```
1. åˆå§‹åŒ–ï¼šä»æ£€æŸ¥ç‚¹æ–‡ä»¶åŠ è½½ï¼ˆå¦‚æœæ˜¯é¢„è®­ç»ƒæ¨¡å‹ï¼‰
           æˆ–éšæœºåˆå§‹åŒ–ï¼ˆå¦‚æœä»å¤´è®­ç»ƒï¼‰

2. è®­ç»ƒæ—¶ï¼šé€šè¿‡åå‘ä¼ æ’­å’Œæ¢¯åº¦ä¸‹é™ä¸æ–­æ›´æ–°

3. æ¨ç†æ—¶ï¼šå›ºå®šä¸å˜ï¼Œç›´æ¥ä½¿ç”¨
```

## äºŒã€åœ¨ä»£ç ä¸­çš„ä½ç½®

### 1. **å‚æ•°å®šä¹‰**

```c
typedef struct {
    float* wte;      // TokenåµŒå…¥
    float* wpe;      // PositionåµŒå…¥
    float* ln1w;     // LayerNormæƒé‡
    float* ln1b;     // LayerNormåç½®
    float* qkvw;     // â† QKVæƒé‡åœ¨è¿™é‡Œï¼
    float* qkvb;     // â† QKVåç½®åœ¨è¿™é‡Œï¼
    float* attprojw; // æ³¨æ„åŠ›è¾“å‡ºæŠ•å½±æƒé‡
    float* attprojb; // æ³¨æ„åŠ›è¾“å‡ºæŠ•å½±åç½®
    // ...
} ParameterTensors;
```

### 2. **å‚æ•°å¤§å°è®¡ç®—**

```c
void fill_in_parameter_sizes(size_t* param_sizes, GPT2Config config) {
    size_t C = config.channels;      // 768
    size_t L = config.num_layers;    // 12
    
    // ...
    param_sizes[4] = L * (3 * C) * C;  // qkvw
    //               â†‘    â†‘       â†‘
    //              12å±‚  2304   768
    //                    â†‘
    //              Q+K+V çš„æ€»ç»´åº¦
    
    param_sizes[5] = L * (3 * C);      // qkvb
    //               â†‘    â†‘
    //              12å±‚  2304
}
```

### 3. **å®é™…å¤§å°**

```
qkvw çš„å½¢çŠ¶ï¼š(L, 3*C, C) = (12, 2304, 768)

å¯¹äºæ¯ä¸€å±‚ï¼š
  ä¸€ä¸ªæƒé‡çŸ©é˜µï¼š(2304, 768)
  
  è¿™ä¸ªçŸ©é˜µå®é™…ä¸ŠåŒ…å«ä¸‰éƒ¨åˆ†ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ W_q (768Ã—768) â”‚ â† Queryæƒé‡
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ W_k (768Ã—768) â”‚ â† Keyæƒé‡
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ W_v (768Ã—768) â”‚ â† Valueæƒé‡
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  åˆå¹¶æˆ (2304, 768)
```

## ä¸‰ã€ä»æ–‡ä»¶åŠ è½½ï¼ˆé¢„è®­ç»ƒæ¨¡å‹ï¼‰

### 1. **åŠ è½½è¿‡ç¨‹**

```c
void gpt2_build_from_checkpoint(GPT2 *model, const char* checkpoint_path) {
    FILE *model_file = fopenCheck(checkpoint_path, "rb");
    
    // 1. è¯»å–é…ç½®
    int model_header[256];
    fread(model_header, sizeof(int), 256, model_file);
    
    // 2. è®¡ç®—å‚æ•°å¤§å°
    fill_in_parameter_sizes(model->param_sizes, model->config);
    
    // 3. åˆ†é…å†…å­˜
    model->params_memory = malloc_and_point_parameters(&model->params, 
                                                       model->param_sizes);
    
    // 4. ä»æ–‡ä»¶è¯»å–æ‰€æœ‰å‚æ•°ï¼ˆåŒ…æ‹¬qkvwï¼‰
    fread(model->params_memory, sizeof(float), num_parameters, model_file);
    //    â†‘
    // qkvw çš„æ•°æ®åœ¨è¿™é‡Œé¢ï¼
    
    fclose(model_file);
}
```

### 2. **æ£€æŸ¥ç‚¹æ–‡ä»¶ç»“æ„**

```
gpt2_124M.bin æ–‡ä»¶å†…å®¹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤´éƒ¨ä¿¡æ¯ (256ä¸ªint)                 â”‚
â”‚  - é­”æ•°ï¼š20240326                   â”‚
â”‚  - ç‰ˆæœ¬ï¼š3                          â”‚
â”‚  - max_seq_lenï¼š1024                â”‚
â”‚  - vocab_sizeï¼š50257                â”‚
â”‚  - num_layersï¼š12                   â”‚
â”‚  - num_headsï¼š12                    â”‚
â”‚  - channelsï¼š768                    â”‚
â”‚  - padded_vocab_sizeï¼š50304         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‚æ•°æ•°æ® (124Mä¸ªfloat)              â”‚
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ wte (50304Ã—768)                 â”‚â”‚ â† TokenåµŒå…¥
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ wpe (1024Ã—768)                  â”‚â”‚ â† PositionåµŒå…¥
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ ln1w (12Ã—768)                   â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ ln1b (12Ã—768)                   â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ qkvw (12Ã—2304Ã—768)              â”‚â”‚ â† Q,K,Væƒé‡åœ¨è¿™ï¼
â”‚ â”‚   = 21,233,664 ä¸ªfloat          â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ qkvb (12Ã—2304)                  â”‚â”‚ â† Q,K,Våç½®
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ ... å…¶ä»–å‚æ•°                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **æŒ‡é’ˆåˆ†é…**

```c
float* malloc_and_point_parameters(ParameterTensors* params, 
                                   size_t* param_sizes) {
    // åˆ†é…ä¸€å¤§å—è¿ç»­å†…å­˜
    size_t num_parameters = 0;
    for (size_t i = 0; i < NUM_PARAMETER_TENSORS; i++) {
        num_parameters += param_sizes[i];
    }
    float* params_memory = malloc(num_parameters * sizeof(float));
    
    // ä¾æ¬¡æŒ‡å‘å„éƒ¨åˆ†
    float* ptr = params_memory;
    
    params->wte = ptr;
    ptr += param_sizes[0];  // è·³è¿‡wte
    
    params->wpe = ptr;
    ptr += param_sizes[1];  // è·³è¿‡wpe
    
    params->ln1w = ptr;
    ptr += param_sizes[2];  // è·³è¿‡ln1w
    
    params->ln1b = ptr;
    ptr += param_sizes[3];  // è·³è¿‡ln1b
    
    params->qkvw = ptr;     // â† qkvwåœ¨è¿™é‡Œï¼
    ptr += param_sizes[4];  // è·³è¿‡qkvw
    
    params->qkvb = ptr;     // â† qkvbåœ¨è¿™é‡Œï¼
    ptr += param_sizes[5];
    
    // ... å…¶ä»–å‚æ•°
    
    return params_memory;
}
```

## å››ã€ä»å¤´è®­ç»ƒï¼ˆéšæœºåˆå§‹åŒ–ï¼‰

### å¦‚æœæ²¡æœ‰é¢„è®­ç»ƒæ¨¡å‹ï¼Œä»é›¶å¼€å§‹ï¼š

```c
void initialize_parameters_random(ParameterTensors* params, 
                                 size_t* param_sizes,
                                 uint64_t* rng_state) {
    // åˆ†é…å†…å­˜
    float* params_memory = malloc_and_point_parameters(params, param_sizes);
    
    // éšæœºåˆå§‹åŒ–æ‰€æœ‰å‚æ•°
    for (size_t i = 0; i < total_params; i++) {
        // ä½¿ç”¨Xavieræˆ–Kaimingåˆå§‹åŒ–
        float std = sqrt(2.0f / fan_in);  // æ ‡å‡†å·®
        params_memory[i] = std * random_normal(rng_state);
    }
    
    // qkvw ä¹Ÿè¢«éšæœºåˆå§‹åŒ–äº†
}
```

### Xavieråˆå§‹åŒ–ç¤ºä¾‹ï¼š

```c
// å¯¹äº qkvw: (3C, C) = (2304, 768)
float fan_in = 768;   // è¾“å…¥ç»´åº¦
float fan_out = 2304; // è¾“å‡ºç»´åº¦

// Xavieræ ‡å‡†å·®
float std = sqrt(2.0f / (fan_in + fan_out));
            = sqrt(2.0f / (768 + 2304))
            = sqrt(2.0f / 3072)
            â‰ˆ 0.0255

// éšæœºåˆå§‹åŒ–æ¯ä¸ªå…ƒç´ 
for (int i = 0; i < 2304 * 768; i++) {
    qkvw[i] = std * random_normal();  // æ­£æ€åˆ†å¸ƒ
}

// åˆå§‹å€¼ç¤ºä¾‹ï¼š
qkvw[0]    = 0.0123
qkvw[1]    = -0.0198
qkvw[2]    = 0.0087
...
```

## äº”ã€ä½¿ç”¨æƒé‡çŸ©é˜µ

### 1. **è®¡ç®—QKV**

```c
// åœ¨æ¯ä¸€å±‚çš„å‰å‘ä¼ æ’­ä¸­
for (int l = 0; l < L; l++) {
    // è·å–è¿™ä¸€å±‚çš„qkvw
    float* l_qkvw = params.qkvw + l * 3*C * C;
    //                            â†‘
    //                    è·³åˆ°ç¬¬lå±‚çš„æƒé‡
    
    float* l_qkvb = params.qkvb + l * 3*C;
    
    // çŸ©é˜µä¹˜æ³•ï¼šç”ŸæˆQKV
    matmul_forward(l_qkv,      // è¾“å‡º (B, T, 3*C)
                   l_ln1,      // è¾“å…¥ (B, T, C)
                   l_qkvw,     // æƒé‡ (3*C, C)
                   l_qkvb,     // åç½® (3*C)
                   B, T, C, 3*C);
}
```

### 2. **çŸ©é˜µä¹˜æ³•å±•å¼€**

```
è¾“å…¥ X: (B, T, C) = (4, 64, 768)
æƒé‡ W: (3*C, C) = (2304, 768)

è®¡ç®—ï¼šQKV = X Ã— W^T
     â†“
å¯¹æ¯ä¸ªè¯ï¼ˆæ¯”å¦‚ä½ç½®tï¼‰ï¼š
  x_t = X[t]  æ˜¯ä¸€ä¸ª (768,) çš„å‘é‡
  
  è®¡ç®— qkv_t = x_t Ã— W^T
  
  qkv_t[0]    = x_t[0]*W[0,0] + x_t[1]*W[0,1] + ... + x_t[767]*W[0,767]
  qkv_t[1]    = x_t[0]*W[1,0] + x_t[1]*W[1,1] + ... + x_t[767]*W[1,767]
  ...
  qkv_t[2303] = x_t[0]*W[2303,0] + ... + x_t[767]*W[2303,767]
  
  ç»“æœ qkv_t æ˜¯ (2304,) çš„å‘é‡
```

### 3. **å®é™…ä»£ç å®ç°**

```c
void matmul_forward(float* out,
                    const float* inp, const float* weight, const float* bias,
                    int B, int T, int C, int OC) {
    // OC = 3*C = 2304
    // C = 768
    
    for (int b = 0; b < B; b++) {
        for (int t = 0; t < T; t++) {
            int bt = b * T + t;
            
            for (int o = 0; o < OC; o++) {  // è¾“å‡ºçš„æ¯ä¸€ç»´
                float val = (bias != NULL) ? bias[o] : 0.0f;
                
                for (int i = 0; i < C; i++) {  // è¾“å…¥çš„æ¯ä¸€ç»´
                    val += inp[bt * C + i] * weight[o*C + i];
                    //     â†‘ è¾“å…¥çš„ç¬¬iç»´      â†‘ æƒé‡çŸ©é˜µçš„ç¬¬(o,i)ä¸ªå…ƒç´ 
                }
                
                out[bt * OC + o] = val;
            }
        }
    }
}
```

## å…­ã€æƒé‡çš„ç»“æ„åˆ†æ

### 1. **qkvw çš„å†…éƒ¨ç»„ç»‡**

```c
// qkvw å½¢çŠ¶ï¼š(2304, 768)

float* l_qkvw = params.qkvw + l * 3*C * C;  // ç¬¬lå±‚

// å¯ä»¥çœ‹ä½œä¸‰ä¸ªå­çŸ©é˜µï¼š
float* W_q = l_qkvw + 0 * C * C;        // [0:768, 0:768]
float* W_k = l_qkvw + 1 * C * C;        // [768:1536, 0:768]
float* W_v = l_qkvw + 2 * C * C;        // [1536:2304, 0:768]

// å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ W_q (768Ã—768) = 589,824 ä¸ªfloat    â”‚  â† å‰1/3
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ W_k (768Ã—768) = 589,824 ä¸ªfloat    â”‚  â† ä¸­é—´1/3
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ W_v (768Ã—768) = 589,824 ä¸ªfloat    â”‚  â† å1/3
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»è®¡ï¼š1,769,472 ä¸ªfloat = 6.75 MBï¼ˆæ¯å±‚ï¼‰
```

### 2. **ä¸ºä»€ä¹ˆåˆå¹¶æˆä¸€ä¸ªçŸ©é˜µï¼Ÿ**

#### æ–¹æ¡ˆAï¼šä¸‰ä¸ªç‹¬ç«‹çŸ©é˜µï¼ˆæ•ˆç‡ä½ï¼‰

```c
// ä½æ•ˆæ–¹æ¡ˆï¼š
matmul(Q, X, W_q);  // ç¬¬1æ¬¡çŸ©é˜µä¹˜æ³•
matmul(K, X, W_k);  // ç¬¬2æ¬¡çŸ©é˜µä¹˜æ³•
matmul(V, X, W_v);  // ç¬¬3æ¬¡çŸ©é˜µä¹˜æ³•

é—®é¢˜ï¼š
  âœ— éœ€è¦3æ¬¡çŸ©é˜µä¹˜æ³•è°ƒç”¨
  âœ— 3æ¬¡å†…å­˜è®¿é—®X
  âœ— æ— æ³•åˆ©ç”¨BLASåº“çš„ä¼˜åŒ–
```

#### æ–¹æ¡ˆBï¼šåˆå¹¶æˆä¸€ä¸ªçŸ©é˜µï¼ˆé«˜æ•ˆï¼‰âœ“

```c
// é«˜æ•ˆæ–¹æ¡ˆï¼š
matmul(QKV, X, W_qkv);  // 1æ¬¡çŸ©é˜µä¹˜æ³•

ä¼˜ç‚¹ï¼š
  âœ“ åªéœ€1æ¬¡çŸ©é˜µä¹˜æ³•
  âœ“ åªè®¿é—®Xä¸€æ¬¡
  âœ“ å¯ä»¥ç”¨é«˜åº¦ä¼˜åŒ–çš„BLAS
  âœ“ æ›´å¥½çš„ç¼“å­˜åˆ©ç”¨
```

## ä¸ƒã€è®­ç»ƒæ—¶çš„æ›´æ–°

### 1. **åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦**

```c
void attention_backward(float* dinp, float* dpreatt, float* datt,
                        float* dout, float* inp, float* att,
                        int B, int T, int C, int NH) {
    // è®¡ç®—å¯¹ QKV çš„æ¢¯åº¦
    // ...
}

// ç„¶åå›ä¼ åˆ°æƒé‡
void matmul_backward(float* dinp, float* dweight, float* dbias,
                     const float* dout, const float* inp, 
                     const float* weight,
                     int B, int T, int C, int OC) {
    
    // è®¡ç®—å¯¹ qkvw çš„æ¢¯åº¦
    for (int o = 0; o < OC; o++) {
        for (int b = 0; b < B; b++) {
            for (int t = 0; t < T; t++) {
                const float* dout_bt = dout + b * T * OC + t * OC;
                const float* inp_bt = inp + b * T * C + t * C;
                float* dwrow = dweight + o*C;
                float d = dout_bt[o];
                
                for (int i = 0; i < C; i++) {
                    dwrow[i] += inp_bt[i] * d;  // ç´¯ç§¯æ¢¯åº¦
                }
            }
        }
    }
}
```

### 2. **å‚æ•°æ›´æ–°ï¼ˆAdamWï¼‰**

```c
void gpt2_update(GPT2 *model, float learning_rate, ...) {
    // å¯¹æ‰€æœ‰å‚æ•°ï¼ˆåŒ…æ‹¬qkvwï¼‰æ›´æ–°
    for (size_t i = 0; i < model->num_parameters; i++) {
        float param = model->params_memory[i];
        float grad = model->grads_memory[i];  // æ¢¯åº¦
        
        // AdamåŠ¨é‡
        float m = beta1 * model->m_memory[i] + (1.0f - beta1) * grad;
        float v = beta2 * model->v_memory[i] + (1.0f - beta2) * grad * grad;
        
        // æ›´æ–°å‚æ•°
        model->params_memory[i] -= learning_rate * (m_hat / (sqrt(v_hat) + eps));
        //    â†‘
        // qkvw ä¹Ÿåœ¨è¿™é‡Œé¢ï¼Œä¼šè¢«æ›´æ–°ï¼
    }
}
```

### 3. **è®­ç»ƒå‰åçš„å¯¹æ¯”**

```
è®­ç»ƒå‰ï¼ˆéšæœºåˆå§‹åŒ–ï¼‰ï¼š
qkvw[0] = 0.0123  (éšæœº)
qkvw[1] = -0.0198 (éšæœº)
...

è®­ç»ƒ1000æ­¥åï¼š
qkvw[0] = 0.0145  (ç¨å¾®å˜åŒ–)
qkvw[1] = -0.0203 (ç¨å¾®å˜åŒ–)
...

è®­ç»ƒ100ä¸‡æ­¥åï¼š
qkvw[0] = 0.1245  (æ˜¾è‘—å˜åŒ–)
qkvw[1] = -0.0987 (æ˜¾è‘—å˜åŒ–)
...

è¿™äº›å‚æ•°å­¦ä¼šäº†å¦‚ä½•ç”Ÿæˆæœ‰ç”¨çš„Qã€Kã€Vï¼
```

## å…«ã€å‚æ•°é‡è®¡ç®—

### GPT-2 Smallçš„qkvwå‚æ•°é‡ï¼š

```
æ¯å±‚çš„qkvwï¼š
  å½¢çŠ¶ï¼š(3*C, C) = (2304, 768)
  å‚æ•°é‡ï¼š2304 Ã— 768 = 1,769,472

12å±‚æ€»è®¡ï¼š
  1,769,472 Ã— 12 = 21,233,664 ä¸ªå‚æ•°
  
å æ¨¡å‹æ€»å‚æ•°çš„æ¯”ä¾‹ï¼š
  21,233,664 / 124,439,808 â‰ˆ 17%
  
qkvw æ˜¯æ¨¡å‹ä¸­æœ€å¤§çš„å‚æ•°éƒ¨åˆ†ä¹‹ä¸€ï¼
```

### å†…å­˜å ç”¨ï¼š

```
qkvwï¼ˆ12å±‚ï¼‰ï¼š
  21,233,664 Ã— 4 bytes (float32) = 84,934,656 bytes
  â‰ˆ 81 MB

åŠ ä¸Šæ¢¯åº¦ã€åŠ¨é‡ã€RMSpropç¼“å­˜ï¼ˆAdamWï¼‰ï¼š
  å‚æ•°ï¼š81 MB
  æ¢¯åº¦ï¼š81 MB
  mç¼“å­˜ï¼š81 MB
  vç¼“å­˜ï¼š81 MB
  æ€»è®¡ï¼š324 MBï¼ˆä»…qkvwéƒ¨åˆ†ï¼ï¼‰
```

## ä¹ã€å¯è§†åŒ–æƒé‡çŸ©é˜µ

### è®­ç»ƒå¥½çš„qkvwé•¿ä»€ä¹ˆæ ·ï¼Ÿ

```python
# ä¼ªä»£ç ï¼šå¯è§†åŒ–ç¬¬0å±‚çš„W_q
import matplotlib.pyplot as plt

W_q = model.params.qkvw[0, 0:768, :]  # (768, 768)

plt.imshow(W_q, cmap='coolwarm', aspect='auto')
plt.colorbar()
plt.title('Layer 0 Query Weight Matrix')
plt.xlabel('Input dimension')
plt.ylabel('Output dimension')
plt.show()

# ä¼šçœ‹åˆ°ï¼š
# - æŸäº›åŒºåŸŸçš„å€¼ç‰¹åˆ«å¤§ï¼ˆé‡è¦è¿æ¥ï¼‰
# - æœ‰æ˜æ˜¾çš„æ¨¡å¼ï¼ˆä¸æ˜¯éšæœºçš„ï¼‰
# - ä¸åŒå­ç©ºé—´å¯èƒ½æœ‰ä¸åŒçš„ç»“æ„
```

### çƒ­åŠ›å›¾ç¤ºä¾‹ï¼š

```
W_q çš„çƒ­åŠ›å›¾ï¼ˆç®€åŒ–ï¼‰ï¼š

è¾“å‡ºç»´åº¦
  â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ â– â– â–¡â–¡â– â– â– â–¡â–¡â–¡â– â– â–¡â–¡â–¡â–¡â–¡â–¡â– â–       â”‚ è“=è´Ÿ
  â”‚ â–¡â–¡â– â– â–¡â–¡â–¡â– â– â– â–¡â–¡â– â– â– â– â– â– â–¡â–¡      â”‚ ç™½=0
  â”‚ â– â– â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â– â–       â”‚ çº¢=æ­£
  â”‚ â–¡â–¡â–¡â–¡â–¡â–¡â– â– â– â– â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡      â”‚
  â”‚ â– â– â–¡â–¡â– â– â– â–¡â–¡â–¡â– â– â–¡â–¡â– â– â– â– â– â–       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†’ è¾“å…¥ç»´åº¦

å¯ä»¥çœ‹åˆ°ç»“æ„åŒ–çš„æ¨¡å¼ï¼Œä¸æ˜¯éšæœºå™ªå£°ï¼
```

## åã€æ€»ç»“

### æƒé‡çŸ©é˜µçš„ç”Ÿå‘½å‘¨æœŸï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯ç”Ÿ                                     â”‚
â”‚    - ä»æ£€æŸ¥ç‚¹åŠ è½½ï¼ˆé¢„è®­ç»ƒï¼‰                 â”‚
â”‚    - æˆ–éšæœºåˆå§‹åŒ–ï¼ˆä»å¤´è®­ç»ƒï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰å‘ä¼ æ’­                                 â”‚
â”‚    QKV = X Ã— W_qkv                          â”‚
â”‚    ç”¨äºè®¡ç®—æ³¨æ„åŠ›                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åå‘ä¼ æ’­                                 â”‚
â”‚    è®¡ç®— âˆ‚Loss/âˆ‚W_qkv                        â”‚
â”‚    å¾—åˆ°æ¢¯åº¦                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‚æ•°æ›´æ–°                                 â”‚
â”‚    W_qkv -= lr Ã— gradient                   â”‚
â”‚    ï¼ˆå®é™…ç”¨AdamWæ›´å¤æ‚ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
        é‡å¤2-4æ­¥éª¤
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ä¿å­˜                                     â”‚
â”‚    å†™å…¥æ£€æŸ¥ç‚¹æ–‡ä»¶                           â”‚
â”‚    ä¾›ä»¥åä½¿ç”¨                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç‚¹ï¼š

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **æ¥æº** | æ£€æŸ¥ç‚¹æ–‡ä»¶åŠ è½½æˆ–éšæœºåˆå§‹åŒ– |
| **å¤§å°** | æ¯å±‚ (2304, 768) = 1.77M å‚æ•° |
| **ç»„ç»‡** | åŒ…å«W_q, W_k, W_vä¸‰éƒ¨åˆ† |
| **ä½¿ç”¨** | é€šè¿‡çŸ©é˜µä¹˜æ³•ç”ŸæˆQKV |
| **æ›´æ–°** | è®­ç»ƒæ—¶é€šè¿‡æ¢¯åº¦ä¸‹é™æ›´æ–° |
| **å­˜å‚¨** | è¿ç»­å†…å­˜ï¼Œä¾¿äºåŠ è½½å’Œè®¡ç®— |

W_qã€W_kã€W_v ä¸æ˜¯ç¥ç§˜çš„é­”æ³•ï¼Œè€Œæ˜¯é€šè¿‡å¤§é‡æ•°æ®è®­ç»ƒå‡ºæ¥çš„**å¯å­¦ä¹ å‚æ•°**ï¼Œå®ƒä»¬ç¼–ç äº†å¦‚ä½•å°†è¾“å…¥è½¬æ¢æˆæœ‰ç”¨çš„Queryã€Keyã€Valueè¡¨ç¤ºï¼ğŸ¯


# æ£€æŸ¥ç‚¹æ–‡ä»¶åŠ è½½ æ˜¯ä»€ä¹ˆæ„æ€

# æ£€æŸ¥ç‚¹æ–‡ä»¶ï¼ˆCheckpointï¼‰è¯¦è§£

éå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘å½»åº•è®²æ¸…æ¥š"æ£€æŸ¥ç‚¹æ–‡ä»¶"æ˜¯ä»€ä¹ˆã€‚

## ä¸€ã€æœ€ç®€å•çš„ç†è§£

### ç±»æ¯”ï¼šæ¸¸æˆå­˜æ¡£

```
ç©æ¸¸æˆæ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ ç©äº†10å°æ—¶ï¼Œåˆ°äº†ç¬¬8å…³        â”‚
â”‚ è§’è‰²ç­‰çº§20ï¼Œè£…å¤‡é½å…¨            â”‚
â”‚ å„ç§æŠ€èƒ½éƒ½å­¦ä¼šäº†                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ ä¿å­˜æ¸¸æˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ save_game.dat                  â”‚
â”‚  - å½“å‰å…³å¡ï¼š8                  â”‚
â”‚  - è§’è‰²ç­‰çº§ï¼š20                 â”‚
â”‚  - ç”Ÿå‘½å€¼ï¼š100                  â”‚
â”‚  - è£…å¤‡åˆ—è¡¨ï¼š[å‰‘, ç›¾ç‰Œ, ...]    â”‚
â”‚  - æŠ€èƒ½ï¼š[ç«çƒæœ¯, æ²»æ„ˆæœ¯, ...]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ ä¸‹æ¬¡åŠ è½½
ç›´æ¥ä»ç¬¬8å…³å¼€å§‹ï¼Œä¸ç”¨é‡æ–°ç©ï¼
```

### ç¥ç»ç½‘ç»œçš„"å­˜æ¡£"

```
è®­ç»ƒæ¨¡å‹æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®­ç»ƒäº†100ä¸‡æ­¥                   â”‚
â”‚ æ‰€æœ‰å‚æ•°éƒ½å­¦å¥½äº†                â”‚
â”‚ æ¨¡å‹å·²ç»å¾ˆèªæ˜äº†                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ ä¿å­˜æ£€æŸ¥ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ gpt2_124M.bin                  â”‚
â”‚  - wte: [50304Ã—768ä¸ªæ•°å­—]      â”‚
â”‚  - wpe: [1024Ã—768ä¸ªæ•°å­—]       â”‚
â”‚  - qkvw: [21Mä¸ªæ•°å­—]           â”‚
â”‚  - ... æ‰€æœ‰å‚æ•°                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ åŠ è½½
ç›´æ¥ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œä¸ç”¨é‡æ–°è®­ç»ƒï¼
```

## äºŒã€æ£€æŸ¥ç‚¹æ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ

### å®šä¹‰ï¼š

> **æ£€æŸ¥ç‚¹æ–‡ä»¶ = æ¨¡å‹åœ¨æŸä¸ªæ—¶åˆ»çš„å®Œæ•´çŠ¶æ€å¿«ç…§**

åŒ…å«ï¼š
1. æ‰€æœ‰å‚æ•°çš„å€¼ï¼ˆæƒé‡å’Œåç½®ï¼‰
2. æ¨¡å‹çš„é…ç½®ä¿¡æ¯
3. ï¼ˆæœ‰æ—¶ï¼‰è®­ç»ƒçŠ¶æ€ï¼ˆä¼˜åŒ–å™¨çš„çŠ¶æ€ç­‰ï¼‰

## ä¸‰ã€ä¸ºä»€ä¹ˆå«"æ£€æŸ¥ç‚¹"ï¼ˆCheckpointï¼‰ï¼Ÿ

### ç±»æ¯”ï¼šé•¿é€”æ—…è¡Œçš„ä¼‘æ¯ç«™

```
è®­ç»ƒç¥ç»ç½‘ç»œ = é•¿é€”æ—…è¡Œï¼ˆå¯èƒ½è¦å‡ å¤©å‡ å‘¨ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ èµ·ç‚¹ â”‚â”€â”€â”€â”€â”€â”€â”€â†’â”‚æ£€æŸ¥ç‚¹1â”‚â”€â”€â”€â”€â”€â”€â”€â†’â”‚æ£€æŸ¥ç‚¹2â”‚â”€â”€â”€â”€â”€â”€â”€â†’â”‚ ç»ˆç‚¹ â”‚
â”‚éšæœºåˆå§‹â”‚       â”‚1000æ­¥ â”‚       â”‚5000æ­¥ â”‚       â”‚100ä¸‡æ­¥â”‚
â””â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”˜
                    â†“               â†“               â†“
                 ä¿å­˜çŠ¶æ€         ä¿å­˜çŠ¶æ€         ä¿å­˜çŠ¶æ€

ä½œç”¨ï¼š
  1. å¦‚æœè®­ç»ƒä¸­æ–­ï¼ˆåœç”µã€å´©æºƒï¼‰ï¼Œå¯ä»¥ä»æœ€è¿‘çš„æ£€æŸ¥ç‚¹ç»§ç»­
  2. å¯ä»¥é€‰æ‹©è¡¨ç°æœ€å¥½çš„æ£€æŸ¥ç‚¹ä½¿ç”¨
  3. å¯ä»¥åˆ†äº«ç»™åˆ«äººï¼Œä¸ç”¨é‡æ–°è®­ç»ƒ
```

## å››ã€ä»£ç ä¸­çš„æ£€æŸ¥ç‚¹åŠ è½½

### 1. **æ–‡ä»¶è·¯å¾„**

```c
int main() {
    GPT2 model;
    // ä»æ£€æŸ¥ç‚¹æ–‡ä»¶åŠ è½½æ¨¡å‹
    gpt2_build_from_checkpoint(&model, "gpt2_124M.bin");
    //                                  â†‘
    //                          æ£€æŸ¥ç‚¹æ–‡ä»¶è·¯å¾„
}
```

### 2. **æ£€æŸ¥ç‚¹æ–‡ä»¶çš„ç»“æ„**

```
gpt2_124M.bin æ–‡ä»¶ï¼ˆçº¦475MBï¼‰ï¼š

å­—èŠ‚åç§»    å†…å®¹                              å¤§å°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0x0000      [å¤´éƒ¨ä¿¡æ¯ - 256ä¸ªæ•´æ•°]           1024 bytes
            â”œâ”€ é­”æ•°: 20240326               4 bytes
            â”œâ”€ ç‰ˆæœ¬: 3                      4 bytes
            â”œâ”€ max_seq_len: 1024            4 bytes
            â”œâ”€ vocab_size: 50257            4 bytes
            â”œâ”€ num_layers: 12               4 bytes
            â”œâ”€ num_heads: 12                4 bytes
            â”œâ”€ channels: 768                4 bytes
            â”œâ”€ padded_vocab_size: 50304     4 bytes
            â””â”€ (ä¿ç•™ç©ºé—´)                   992 bytes

0x0400      [å‚æ•°æ•°æ® - 124,439,808ä¸ªfloat] 497,759,232 bytes
            â”œâ”€ wte (TokenåµŒå…¥)
            â”‚   50304 Ã— 768 = 38,633,472 ä¸ªfloat
            â”‚   = 154,533,888 bytes (~147MB)
            â”‚
            â”œâ”€ wpe (PositionåµŒå…¥)
            â”‚   1024 Ã— 768 = 786,432 ä¸ªfloat
            â”‚   = 3,145,728 bytes (~3MB)
            â”‚
            â”œâ”€ Layer 0:
            â”‚   â”œâ”€ ln1w (768 ä¸ªfloat)
            â”‚   â”œâ”€ ln1b (768 ä¸ªfloat)
            â”‚   â”œâ”€ qkvw (2304Ã—768 ä¸ªfloat) = 6.75MB
            â”‚   â”œâ”€ qkvb (2304 ä¸ªfloat)
            â”‚   â”œâ”€ attprojw (768Ã—768 ä¸ªfloat)
            â”‚   â”œâ”€ attprojb (768 ä¸ªfloat)
            â”‚   â”œâ”€ ln2w (768 ä¸ªfloat)
            â”‚   â”œâ”€ ln2b (768 ä¸ªfloat)
            â”‚   â”œâ”€ fcw (3072Ã—768 ä¸ªfloat)
            â”‚   â”œâ”€ fcb (3072 ä¸ªfloat)
            â”‚   â”œâ”€ fcprojw (768Ã—3072 ä¸ªfloat)
            â”‚   â””â”€ fcprojb (768 ä¸ªfloat)
            â”‚
            â”œâ”€ Layer 1:
            â”‚   â””â”€ (åŒæ ·çš„ç»“æ„)
            â”‚
            â”œâ”€ ... (Layer 2-11)
            â”‚
            â””â”€ æœ€ç»ˆLayerNorm:
                â”œâ”€ lnfw (768 ä¸ªfloat)
                â””â”€ lnfb (768 ä¸ªfloat)
```

### 3. **åŠ è½½è¿‡ç¨‹è¯¦è§£**

```c
void gpt2_build_from_checkpoint(GPT2 *model, const char* checkpoint_path) {
    
    // æ­¥éª¤1ï¼šæ‰“å¼€æ–‡ä»¶
    FILE *model_file = fopen(checkpoint_path, "rb");
    //                                          â†‘
    //                                    "rb" = äºŒè¿›åˆ¶åªè¯»æ¨¡å¼
    if (model_file == NULL) {
        printf("Error: cannot open %s\n", checkpoint_path);
        exit(1);
    }
    
    // æ­¥éª¤2ï¼šè¯»å–å¤´éƒ¨ï¼ˆé…ç½®ä¿¡æ¯ï¼‰
    int model_header[256];  // 256ä¸ªæ•´æ•°
    fread(model_header, sizeof(int), 256, model_file);
    //    â†‘ è¯»åˆ°å“ªé‡Œ   â†‘ æ¯ä¸ªå¤šå¤§  â†‘ è¯»å‡ ä¸ª  â†‘ ä»å“ªè¯»
    
    // éªŒè¯æ–‡ä»¶æ ¼å¼
    if (model_header[0] != 20240326) {
        printf("Bad magic number\n");
        exit(1);
    }
    
    // æå–é…ç½®
    model->config.max_seq_len = model_header[2];      // 1024
    model->config.vocab_size = model_header[3];       // 50257
    model->config.num_layers = model_header[4];       // 12
    model->config.num_heads = model_header[5];        // 12
    model->config.channels = model_header[6];         // 768
    model->config.padded_vocab_size = model_header[7]; // 50304
    
    // æ­¥éª¤3ï¼šè®¡ç®—éœ€è¦å¤šå°‘å†…å­˜
    fill_in_parameter_sizes(model->param_sizes, model->config);
    size_t num_parameters = 0;
    for (size_t i = 0; i < NUM_PARAMETER_TENSORS; i++) {
        num_parameters += model->param_sizes[i];
    }
    // num_parameters = 124,439,808
    
    // æ­¥éª¤4ï¼šåˆ†é…å†…å­˜
    model->params_memory = malloc_and_point_parameters(&model->params, 
                                                       model->param_sizes);
    // åˆ†é…äº† 124,439,808 Ã— 4 = 497,759,232 bytes â‰ˆ 475 MB
    
    // æ­¥éª¤5ï¼šè¯»å–æ‰€æœ‰å‚æ•°
    fread(model->params_memory, sizeof(float), num_parameters, model_file);
    //    â†‘                     â†‘              â†‘                 â†‘
    //    è¯»åˆ°è¿™ä¸ªå†…å­˜å—        æ¯ä¸ª4å­—èŠ‚       è¯»124Mä¸ª          ä»æ–‡ä»¶è¯»
    
    // ç°åœ¨ model->params_memory é‡Œæœ‰äº†æ‰€æœ‰è®­ç»ƒå¥½çš„å‚æ•°ï¼
    
    // æ­¥éª¤6ï¼šå…³é—­æ–‡ä»¶
    fclose(model_file);
    
    // å®Œæˆï¼æ¨¡å‹å·²ç»åŠ è½½å¥½ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
}
```

## äº”ã€æ£€æŸ¥ç‚¹æ–‡ä»¶æ€ä¹ˆæ¥çš„ï¼Ÿ

### 1. **è®­ç»ƒè¿‡ç¨‹ä¸­ä¿å­˜**

```python
# ä¼ªä»£ç ï¼šè®­ç»ƒå¾ªç¯
for step in range(1000000):  # è®­ç»ƒ100ä¸‡æ­¥
    # å‰å‘ä¼ æ’­
    loss = model.forward(batch)
    
    # åå‘ä¼ æ’­
    model.backward()
    
    # æ›´æ–°å‚æ•°
    model.update()
    
    # æ¯10000æ­¥ä¿å­˜ä¸€æ¬¡æ£€æŸ¥ç‚¹
    if step % 10000 == 0:
        save_checkpoint(model, f"checkpoint_step_{step}.bin")
        print(f"Saved checkpoint at step {step}")

# æœ€åä¿å­˜æœ€ç»ˆæ¨¡å‹
save_checkpoint(model, "gpt2_124M_final.bin")
```

### 2. **ä¿å­˜å‡½æ•°çš„å®ç°**

```c
void save_checkpoint(GPT2 *model, const char* filename) {
    FILE *file = fopen(filename, "wb");  // "wb" = äºŒè¿›åˆ¶å†™æ¨¡å¼
    
    // å†™å…¥å¤´éƒ¨ä¿¡æ¯
    int header[256] = {0};
    header[0] = 20240326;  // é­”æ•°
    header[1] = 3;         // ç‰ˆæœ¬
    header[2] = model->config.max_seq_len;
    header[3] = model->config.vocab_size;
    header[4] = model->config.num_layers;
    header[5] = model->config.num_heads;
    header[6] = model->config.channels;
    header[7] = model->config.padded_vocab_size;
    
    fwrite(header, sizeof(int), 256, file);
    
    // å†™å…¥æ‰€æœ‰å‚æ•°
    fwrite(model->params_memory, sizeof(float), model->num_parameters, file);
    
    fclose(file);
    printf("Checkpoint saved to %s\n", filename);
}
```

## å…­ã€æ£€æŸ¥ç‚¹çš„ç”¨é€”

### 1. **æ¢å¤è®­ç»ƒï¼ˆResume Trainingï¼‰**

```c
// åœºæ™¯ï¼šè®­ç»ƒåˆ°ä¸€åŠç”µè„‘å…³æœºäº†

// ç¬¬ä¸€æ¬¡è®­ç»ƒï¼š
GPT2 model;
init_random(&model);  // éšæœºåˆå§‹åŒ–
for (int step = 0; step < 500000; step++) {
    train_step(&model);
    if (step == 100000) {
        save_checkpoint(&model, "checkpoint_100k.bin");
    }
    // ... çªç„¶åœ¨ç¬¬123456æ­¥æ—¶å´©æºƒï¼
}

// é‡æ–°å¼€å§‹æ—¶ï¼š
GPT2 model;
gpt2_build_from_checkpoint(&model, "checkpoint_100k.bin");  // ä»100kæ¢å¤
// ä¸ç”¨ä»å¤´è®­ç»ƒï¼Œç›´æ¥ä»ç¬¬100001æ­¥ç»§ç»­ï¼
for (int step = 100001; step < 500000; step++) {
    train_step(&model);
}
```

### 2. **æ¨ç†ï¼ˆInferenceï¼‰**

```c
// åœºæ™¯ï¼šåªæƒ³ä½¿ç”¨æ¨¡å‹ï¼Œä¸è®­ç»ƒ

int main() {
    GPT2 model;
    // åŠ è½½åˆ«äººè®­ç»ƒå¥½çš„æ¨¡å‹
    gpt2_build_from_checkpoint(&model, "gpt2_124M.bin");
    
    // ç›´æ¥ç”Ÿæˆæ–‡æœ¬
    generate_text(&model, "Once upon a time");
    
    // ä¸éœ€è¦è®­ç»ƒï¼Œç›´æ¥ç”¨ï¼
}
```

### 3. **è¿ç§»å­¦ä¹ ï¼ˆTransfer Learningï¼‰**

```c
// åœºæ™¯ï¼šåœ¨å·²è®­ç»ƒæ¨¡å‹çš„åŸºç¡€ä¸Šå¾®è°ƒ

GPT2 model;
// åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼ˆåœ¨å¤§é‡é€šç”¨æ•°æ®ä¸Šè®­ç»ƒå¥½çš„ï¼‰
gpt2_build_from_checkpoint(&model, "gpt2_124M_pretrained.bin");

// åœ¨ç‰¹å®šä»»åŠ¡ä¸Šå¾®è°ƒï¼ˆåªè®­ç»ƒå‡ åƒæ­¥ï¼‰
for (int step = 0; step < 5000; step++) {
    train_step(&model, medical_data);  // ç”¨åŒ»ç–—æ•°æ®å¾®è°ƒ
}

// ä¿å­˜å¾®è°ƒåçš„æ¨¡å‹
save_checkpoint(&model, "gpt2_medical.bin");
```

### 4. **æ¨¡å‹åˆ†äº«**

```
ç ”ç©¶è€…Aï¼š
  - èŠ±è´¹å‡ å‘¨æ—¶é—´è®­ç»ƒæ¨¡å‹
  - ä½¿ç”¨æ˜‚è´µçš„GPUé›†ç¾¤
  - ä¿å­˜ï¼šgpt2_124M.bin

ç ”ç©¶è€…Bï¼š
  - ä¸‹è½½ gpt2_124M.bin
  - å‡ ç§’é’Ÿå†…åŠ è½½
  - ç›´æ¥ä½¿ç”¨ï¼
  
èŠ‚çœäº†å¤§é‡æ—¶é—´å’Œè®¡ç®—èµ„æºï¼
```

## ä¸ƒã€ä¸åŒç±»å‹çš„æ£€æŸ¥ç‚¹

### 1. **å®Œæ•´æ£€æŸ¥ç‚¹ï¼ˆFull Checkpointï¼‰**

```
åŒ…å«æ‰€æœ‰ä¿¡æ¯ï¼š
  âœ“ æ¨¡å‹å‚æ•°
  âœ“ ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆm_memory, v_memoryï¼‰
  âœ“ è®­ç»ƒæ­¥æ•°
  âœ“ å½“å‰æŸå¤±
  âœ“ å­¦ä¹ ç‡

ç”¨é€”ï¼š
  - å®Œæ•´æ¢å¤è®­ç»ƒ
  - ä»ä¸­æ–­å¤„ç»§ç»­

æ–‡ä»¶å¤§å°ï¼š~1.5 GBï¼ˆGPT-2 Smallï¼‰
```

### 2. **æ¨¡å‹æ£€æŸ¥ç‚¹ï¼ˆModel-Only Checkpointï¼‰**

```
åªåŒ…å«æ¨¡å‹å‚æ•°ï¼š
  âœ“ æ¨¡å‹å‚æ•°
  âœ— ä¼˜åŒ–å™¨çŠ¶æ€
  âœ— è®­ç»ƒå…ƒä¿¡æ¯

ç”¨é€”ï¼š
  - æ¨ç†
  - åˆ†äº«æ¨¡å‹

æ–‡ä»¶å¤§å°ï¼š~475 MBï¼ˆGPT-2 Smallï¼‰
```

### 3. **é‡åŒ–æ£€æŸ¥ç‚¹ï¼ˆQuantized Checkpointï¼‰**

```
å‚æ•°ç”¨æ›´å°‘çš„ä½æ•°è¡¨ç¤ºï¼š
  - float32 (4 bytes) â†’ float16 (2 bytes)
  - æˆ– int8 (1 byte)

æ–‡ä»¶å¤§å°ï¼š~240 MB (float16) æˆ– ~120 MB (int8)
```

## å…«ã€æ£€æŸ¥ç‚¹çš„ç‰ˆæœ¬ç®¡ç†

### è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ£€æŸ¥ç‚¹ç­–ç•¥ï¼š

```
è®­ç»ƒç›®å½•ç»“æ„ï¼š
model_training/
â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ checkpoint_step_10000.bin   (1000æ­¥)
â”‚   â”œâ”€â”€ checkpoint_step_50000.bin   (5ä¸‡æ­¥)
â”‚   â”œâ”€â”€ checkpoint_step_100000.bin  (10ä¸‡æ­¥) â† æœ€å¥½çš„éªŒè¯loss
â”‚   â”œâ”€â”€ checkpoint_step_150000.bin  (15ä¸‡æ­¥)
â”‚   â”œâ”€â”€ checkpoint_step_200000.bin  (20ä¸‡æ­¥) â† æœ€æ–°çš„
â”‚   â””â”€â”€ checkpoint_best.bin         â†’ æŒ‡å‘100000.bin
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ training.log
â””â”€â”€ config.json
```

### é€‰æ‹©æ£€æŸ¥ç‚¹çš„ç­–ç•¥ï¼š

```python
# ç­–ç•¥1ï¼šä½¿ç”¨æœ€æ–°çš„
model = load_checkpoint("checkpoint_step_200000.bin")

# ç­–ç•¥2ï¼šä½¿ç”¨éªŒè¯lossæœ€ä½çš„
model = load_checkpoint("checkpoint_best.bin")

# ç­–ç•¥3ï¼šä½¿ç”¨ç‰¹å®šæ­¥æ•°çš„ï¼ˆè°ƒè¯•ç”¨ï¼‰
model = load_checkpoint("checkpoint_step_50000.bin")
```

## ä¹ã€å®é™…ä¾‹å­ï¼šä¸‹è½½å’Œä½¿ç”¨æ£€æŸ¥ç‚¹

### Hugging Faceä¸Šçš„æ£€æŸ¥ç‚¹ï¼š

```bash
# 1. ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹
wget https://huggingface.co/gpt2/resolve/main/pytorch_model.bin

# 2. è½¬æ¢æ ¼å¼ï¼ˆPyTorch â†’ è‡ªå®šä¹‰æ ¼å¼ï¼‰
python convert_checkpoint.py pytorch_model.bin gpt2_124M.bin

# 3. ä½¿ç”¨
./train_gpt2 gpt2_124M.bin
```

### ä»£ç ä½¿ç”¨ï¼š

```c
int main() {
    GPT2 model;
    
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if (access("gpt2_124M.bin", F_OK) == -1) {
        printf("Checkpoint file not found!\n");
        printf("Please download from: https://...\n");
        exit(1);
    }
    
    // åŠ è½½æ£€æŸ¥ç‚¹
    printf("Loading checkpoint...\n");
    gpt2_build_from_checkpoint(&model, "gpt2_124M.bin");
    printf("Model loaded successfully!\n");
    
    // ä½¿ç”¨æ¨¡å‹
    generate_text(&model, "Hello, world!");
    
    return 0;
}
```

## åã€æ£€æŸ¥ç‚¹ vs ä»å¤´è®­ç»ƒ

### å¯¹æ¯”ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä»å¤´è®­ç»ƒï¼ˆFrom Scratchï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆå§‹åŒ–ï¼šéšæœº                                         â”‚
â”‚ æ—¶é—´ï¼šå‡ å¤©åˆ°å‡ å‘¨                                     â”‚
â”‚ è®¡ç®—ï¼šéœ€è¦å¼ºå¤§çš„GPUé›†ç¾¤                              â”‚
â”‚ æˆæœ¬ï¼š$10,000 - $100,000                            â”‚
â”‚ æ•°æ®ï¼šéœ€è¦å¤§é‡è®­ç»ƒæ•°æ®                               â”‚
â”‚ ç»“æœï¼šä¸ç¡®å®šï¼ˆå¯èƒ½è®­ç»ƒå¤±è´¥ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åŠ è½½æ£€æŸ¥ç‚¹ï¼ˆLoad Checkpointï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆå§‹åŒ–ï¼šè®­ç»ƒå¥½çš„å‚æ•°                                 â”‚
â”‚ æ—¶é—´ï¼šå‡ ç§’é’Ÿ                                         â”‚
â”‚ è®¡ç®—ï¼šåªéœ€è¦ä¸‹è½½                                     â”‚
â”‚ æˆæœ¬ï¼šå…è´¹æˆ–å¾ˆä¾¿å®œ                                   â”‚
â”‚ æ•°æ®ï¼šä¸éœ€è¦è®­ç»ƒæ•°æ®                                 â”‚
â”‚ ç»“æœï¼šå·²ç»è®­ç»ƒå¥½ï¼Œç›´æ¥å¯ç”¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åä¸€ã€æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µï¼š

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| **æ£€æŸ¥ç‚¹** | æ¨¡å‹åœ¨æŸä¸ªæ—¶åˆ»çš„å®Œæ•´å¿«ç…§ |
| **æ–‡ä»¶æ ¼å¼** | äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ.bin, .ckpt, .pthç­‰ï¼‰ |
| **å†…å®¹** | æ¨¡å‹é…ç½® + æ‰€æœ‰å‚æ•°çš„æ•°å€¼ |
| **å¤§å°** | GPT-2 Small â‰ˆ 475 MB |
| **ä½œç”¨** | ä¿å­˜/æ¢å¤è®­ç»ƒï¼Œåˆ†äº«æ¨¡å‹ |

### ç±»æ¯”è®°å¿†ï¼š

```
æ£€æŸ¥ç‚¹æ–‡ä»¶ = æ¨¡å‹çš„"DNA"

å°±åƒï¼š
  âœ“ äººçš„DNAåŒ…å«äº†æ‰€æœ‰é—ä¼ ä¿¡æ¯
  âœ“ æ£€æŸ¥ç‚¹åŒ…å«äº†æ¨¡å‹çš„æ‰€æœ‰"çŸ¥è¯†"

æœ‰äº†DNAï¼ˆæ£€æŸ¥ç‚¹ï¼‰ï¼š
  âœ“ å¯ä»¥"å…‹éš†"å‡ºç›¸åŒçš„æ¨¡å‹
  âœ“ ä¸éœ€è¦é‡æ–°"æˆé•¿"ï¼ˆè®­ç»ƒï¼‰
  âœ“ å¯ä»¥åˆ†äº«ç»™å…¨ä¸–ç•Œ
```

### å…³é”®ä»£ç ï¼š

```c
// åŠ è½½æ£€æŸ¥ç‚¹çš„æœ¬è´¨ï¼š
// 1. æ‰“å¼€æ–‡ä»¶
FILE* f = fopen("gpt2_124M.bin", "rb");

// 2. è¯»å–é…ç½®
fread(header, ...);

// 3. è¯»å–å‚æ•°ï¼ˆ124Mä¸ªæ•°å­—ï¼‰
fread(params_memory, sizeof(float), 124439808, f);

// 4. å…³é—­æ–‡ä»¶
fclose(f);

// å®Œæˆï¼æ¨¡å‹å°±"å¤æ´»"äº†ï¼
```

æ£€æŸ¥ç‚¹å°±æ˜¯æŠŠæ¨¡å‹çš„"çµé­‚"ï¼ˆå‚æ•°ï¼‰å­˜åˆ°æ–‡ä»¶é‡Œï¼Œéœ€è¦æ—¶å†è¯»å‡ºæ¥ï¼Œè®©æ¨¡å‹"å¤æ´»"ï¼ğŸ¯



# å‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFeed-Forward Networkï¼‰æ˜¯ä»€ä¹ˆï¼Œè¯¦ç»†é€šä¿—è§£é‡Š


# å‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFeed-Forward Networkï¼‰è¯¦è§£

è¿™æ˜¯ Transformer ä¸­çš„å¦ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼è®©æˆ‘ä»æœ€åŸºç¡€å¼€å§‹è®²æ¸…æ¥šã€‚

## ä¸€ã€æœ€ç®€å•çš„ç†è§£

### ä»€ä¹ˆæ˜¯"å‰é¦ˆ"ï¼Ÿ

> **å‰é¦ˆ = ä¿¡æ¯åªèƒ½å•å‘æµåŠ¨ï¼Œä»è¾“å…¥åˆ°è¾“å‡ºï¼Œä¸èµ°å›å¤´è·¯**

### ç”Ÿæ´»ç±»æ¯”ï¼š

```
å·¥å‚æµæ°´çº¿ï¼ˆå‰é¦ˆï¼‰ï¼š
åŸææ–™ â†’ åŠ å·¥1 â†’ åŠ å·¥2 â†’ åŠ å·¥3 â†’ æˆå“
         â†“       â†“       â†“
      åªèƒ½å‘å‰ï¼Œä¸èƒ½å€’é€€

å¯¹æ¯”ï¼š
å¾ªç¯ï¼ˆä¸æ˜¯å‰é¦ˆï¼‰ï¼š
åŸææ–™ â‡„ åŠ å·¥1 â‡„ åŠ å·¥2 â‡„ åŠ å·¥3 â†’ æˆå“
         â†‘_______|_______|
         å¯ä»¥å¾€å›èµ°ï¼Œåå¤å¤„ç†
```

## äºŒã€åœ¨ GPT-2 ä¸­çš„ä½ç½®

### Transformer å±‚çš„ç»“æ„ï¼š

```
è¾“å…¥
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Layer Normalization      â”‚  â† ç¬¬1æ­¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Multi-Head Attention     â”‚  â† ç¬¬2æ­¥ï¼ˆè¯ä¹‹é—´äº¤äº’ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Residual Connection      â”‚  â† ç¬¬3æ­¥ï¼ˆè·³è·ƒè¿æ¥ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Layer Normalization      â”‚  â† ç¬¬4æ­¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘ Feed-Forward Network (FFN)  â•‘  â† ç¬¬5æ­¥ â˜… æˆ‘ä»¬åœ¨è¿™ï¼
â•‘  - ç¬¬ä¸€å±‚ï¼šæ‰©å±•              â•‘
â•‘  - æ¿€æ´»å‡½æ•°ï¼šGeLU            â•‘
â•‘  - ç¬¬äºŒå±‚ï¼šå‹ç¼©              â•‘
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Residual Connection      â”‚  â† ç¬¬6æ­¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†“
è¾“å‡º
```

## ä¸‰ã€ä»£ç ä¸­çš„å®ç°

### 1. **ä¸‰ä¸ªæ­¥éª¤**

```c
// æ­¥éª¤1ï¼šç¬¬ä¸€å±‚çº¿æ€§å˜æ¢ï¼ˆæ‰©å±• 4å€ï¼‰
matmul_forward(l_fch, l_ln2, l_fcw, l_fcb, B, T, C, 4*C);
//             è¾“å‡º   è¾“å…¥   æƒé‡  åç½®
//           (B,T,4C)(B,T,C)(4C,C)(4C)

// æ­¥éª¤2ï¼šGeLU æ¿€æ´»å‡½æ•°
gelu_forward(l_fch_gelu, l_fch, B*T*4*C);
//           è¾“å‡º        è¾“å…¥

// æ­¥éª¤3ï¼šç¬¬äºŒå±‚çº¿æ€§å˜æ¢ï¼ˆå‹ç¼©å›åŸç»´åº¦ï¼‰
matmul_forward(l_fcproj, l_fch_gelu, l_fcprojw, l_fcprojb, B, T, 4*C, C);
//             è¾“å‡º      è¾“å…¥        æƒé‡       åç½®
//           (B,T,C)   (B,T,4C)   (C,4C)     (C)
```

### 2. **ç»´åº¦å˜åŒ–**

```
è¾“å…¥:  (B, T, C)   = (4, 64, 768)   â† 768ç»´
  â†“
ç¬¬ä¸€å±‚: (B, T, 4C) = (4, 64, 3072)  â† æ‰©å±•åˆ°3072ç»´ (4å€)
  â†“
GeLU:  (B, T, 4C) = (4, 64, 3072)  â† ç»´åº¦ä¸å˜ï¼Œé€å…ƒç´ æ“ä½œ
  â†“
ç¬¬äºŒå±‚: (B, T, C)  = (4, 64, 768)   â† å‹ç¼©å›768ç»´
```

## å››ã€ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

### 1. **ä¸ºä»€ä¹ˆè¦æ‰©å±•å†å‹ç¼©ï¼Ÿ**

#### ç±»æ¯”ï¼šæ€è€ƒè¿‡ç¨‹

```
äººçš„æ€è€ƒè¿‡ç¨‹ï¼š

ç®€å•æƒ³æ³• â†’ å±•å¼€æ€è€ƒ â†’ æ€»ç»“ç»“è®º
  (768ç»´)   (3072ç»´)    (768ç»´)

ä¾‹å­ï¼š
è¾“å…¥ï¼š"æˆ‘é¥¿äº†"
  â†“ å±•å¼€
ä¸­é—´æ€è€ƒï¼š
  - ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ
  - ä¸Šæ¬¡åƒé¥­æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ
  - é™„è¿‘æœ‰ä»€ä¹ˆé¤é¦†ï¼Ÿ
  - æˆ‘å–œæ¬¢åƒä»€ä¹ˆï¼Ÿ
  - é¢„ç®—å¤Ÿä¸å¤Ÿï¼Ÿ
  - æœ‰æ²¡æœ‰æ—¶é—´ï¼Ÿ
  â†“ æ€»ç»“
è¾“å‡ºï¼š"å»åƒæ‹‰é¢"
```

#### æ•°å­¦è§’åº¦ï¼š

```
é—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ 768 â†’ 768ï¼Ÿ

768 â†’ 768 çš„å˜æ¢ï¼š
  è¡¨è¾¾èƒ½åŠ›æœ‰é™
  åªèƒ½å­¦ä¹ çº¿æ€§æˆ–ç®€å•çš„éçº¿æ€§å…³ç³»

768 â†’ 3072 â†’ 768 çš„å˜æ¢ï¼š
  âœ“ ä¸­é—´çš„3072ç»´æä¾›äº†"æ€è€ƒç©ºé—´"
  âœ“ å¯ä»¥å­¦ä¹ æ›´å¤æ‚çš„æ¨¡å¼
  âœ“ ç±»ä¼¼äº"ç¼–ç -è§£ç "ç»“æ„
```

### 2. **ä¸ºä»€ä¹ˆæ˜¯ 4å€ï¼Ÿ**

```
ä¸åŒçš„å€æ•°å¯¹æ¯”ï¼š

2å€ (768 â†’ 1536 â†’ 768):
  âœ— æ€è€ƒç©ºé—´å¤ªå°
  âœ— è¡¨è¾¾èƒ½åŠ›ä¸è¶³

4å€ (768 â†’ 3072 â†’ 768): âœ“
  âœ“ é»„é‡‘æ¯”ä¾‹
  âœ“ æ€§èƒ½å’Œè®¡ç®—é‡çš„å¹³è¡¡

8å€ (768 â†’ 6144 â†’ 768):
  âœ— è®¡ç®—é‡å¤ªå¤§
  âœ— è¿‡åº¦æ‹Ÿåˆé£é™©
  âœ— æ”¶ç›Šé€’å‡

ç»éªŒå‘ç°ï¼š4å€æ˜¯æœ€ä½³é€‰æ‹©ï¼
```

## äº”ã€è¯¦ç»†åˆ†è§£æ¯ä¸€æ­¥

### æ­¥éª¤1ï¼šç¬¬ä¸€å±‚çº¿æ€§å˜æ¢ï¼ˆæ‰©å±•ï¼‰

#### æ•°å­¦å…¬å¼ï¼š

```
h = x Ã— W1 + b1

å…¶ä¸­ï¼š
  x:  è¾“å…¥ (B, T, 768)
  W1: æƒé‡ (3072, 768)  â† æ³¨æ„ï¼šå®é™…å­˜å‚¨æ˜¯è½¬ç½®çš„
  b1: åç½® (3072,)
  h:  è¾“å‡º (B, T, 3072)
```

#### å…·ä½“ä¾‹å­ï¼š

```
å‡è®¾ç®€åŒ–ç‰ˆæœ¬ï¼šC=3, 4C=12

è¾“å…¥å‘é‡ x = [0.1, 0.2, 0.3]  (3ç»´)

æƒé‡çŸ©é˜µ W1 (12Ã—3)ï¼š
     x[0]  x[1]  x[2]
h[0]  0.5   0.2   0.1
h[1]  0.3   0.4   0.2
h[2]  0.1   0.5   0.3
h[3]  0.4   0.1   0.5
...
h[11] 0.2   0.3   0.4

åç½® b1 = [0.01, 0.02, ..., 0.12]  (12ç»´)

è®¡ç®—ï¼š
h[0] = 0.1Ã—0.5 + 0.2Ã—0.2 + 0.3Ã—0.1 + 0.01 = 0.12
h[1] = 0.1Ã—0.3 + 0.2Ã—0.4 + 0.3Ã—0.2 + 0.02 = 0.19
...
h[11] = ...

è¾“å‡º h = [0.12, 0.19, ..., ?]  (12ç»´)
```

#### ä»£ç å®ç°ï¼š

```c
void matmul_forward(float* out,
                    const float* inp, const float* weight, const float* bias,
                    int B, int T, int C, int OC) {
    // C = 768, OC = 3072
    
    for (int b = 0; b < B; b++) {
        for (int t = 0; t < T; t++) {
            int bt = b * T + t;
            
            for (int o = 0; o < OC; o++) {  // 3072 ä¸ªè¾“å‡ºç»´åº¦
                float val = bias[o];  // ä»åç½®å¼€å§‹
                
                for (int i = 0; i < C; i++) {  // 768 ä¸ªè¾“å…¥ç»´åº¦
                    val += inp[bt * C + i] * weight[o*C + i];
                    //     â†‘ è¾“å…¥çš„ç¬¬iç»´    â†‘ æƒé‡çŸ©é˜µçš„(o,i)å…ƒç´ 
                }
                
                out[bt * OC + o] = val;
            }
        }
    }
}
```

### æ­¥éª¤2ï¼šGeLU æ¿€æ´»å‡½æ•°

#### ä»€ä¹ˆæ˜¯æ¿€æ´»å‡½æ•°ï¼Ÿ

```
é—®é¢˜ï¼šæ²¡æœ‰æ¿€æ´»å‡½æ•°çš„ç½‘ç»œ

layer1: y = x Ã— W1 + b1
layer2: z = y Ã— W2 + b2

å±•å¼€ï¼š
z = (x Ã— W1 + b1) Ã— W2 + b2
  = x Ã— (W1 Ã— W2) + (b1 Ã— W2 + b2)
  = x Ã— W_combined + b_combined

ç»“æœï¼šå¤šå±‚ç½‘ç»œé€€åŒ–æˆå•å±‚ï¼âŒ

è§£å†³ï¼šåŠ å…¥éçº¿æ€§æ¿€æ´»å‡½æ•°

layer1: y = GeLU(x Ã— W1 + b1)  â† éçº¿æ€§ï¼
layer2: z = y Ã— W2 + b2

ç°åœ¨æ— æ³•åŒ–ç®€ï¼Œä¿æŒäº†å¤šå±‚çš„è¡¨è¾¾èƒ½åŠ› âœ“
```

#### GeLU çš„å…¬å¼ï¼š

```c
#define GELU_SCALING_FACTOR sqrtf(2.0f / M_PI)

void gelu_forward(float* out, float* inp, int N) {
    for (int i = 0; i < N; i++) {
        float x = inp[i];
        float cube = 0.044715f * x * x * x;
        out[i] = 0.5f * x * (1.0f + tanhf(GELU_SCALING_FACTOR * (x + cube)));
        //       â†‘                  â†‘
        //      0.5x            tanh(...)
    }
}
```

#### GeLU çš„å½¢çŠ¶ï¼š

```
æ•°å­¦è¡¨è¾¾å¼ï¼ˆè¿‘ä¼¼ï¼‰ï¼š
GeLU(x) â‰ˆ 0.5 Ã— x Ã— (1 + tanh(âˆš(2/Ï€) Ã— (x + 0.044715 Ã— xÂ³)))

å›¾åƒï¼š
      â†‘ GeLU(x)
    3 â”‚         â•±
      â”‚        â•±
    2 â”‚       â•±
      â”‚      â•±
    1 â”‚     â•±
      â”‚    â•±
    0 â”‚___â•±____________â†’ x
      â”‚  â•±
   -1 â”‚_â•±
      â”‚
   -2 â”‚

ç‰¹ç‚¹ï¼š
  - x > 0: åŸºæœ¬ä¿æŒ x çš„å€¼ï¼ˆç•¥å°ï¼‰
  - x < 0: æ¥è¿‘0ï¼Œä½†ä¸å®Œå…¨æ˜¯0ï¼ˆæ¯”ReLUæ›´å¹³æ»‘ï¼‰
  - x â‰ˆ 0: å¹³æ»‘è¿‡æ¸¡
```

#### å…·ä½“æ•°å€¼ï¼š

```
è¾“å…¥x      GeLU(x)    å¯¹æ¯”ReLU(x)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 3.0       2.996       3.0
 2.0       1.954       2.0
 1.0       0.841       1.0
 0.5       0.346       0.5
 0.0       0.000       0.0
-0.5      -0.154       0.0  â† ä¸åŒï¼
-1.0      -0.159       0.0  â† ä¸åŒï¼
-2.0      -0.046       0.0  â† ä¸åŒï¼
-3.0      -0.004       0.0  â† ä¸åŒï¼

GeLU çš„ä¼˜åŠ¿ï¼š
  âœ“ è´Ÿå€¼åŒºåŸŸæœ‰å°çš„æ¢¯åº¦ï¼ˆä¸ä¼š"æ­»"ï¼‰
  âœ“ æ›´å¹³æ»‘ï¼ˆè®­ç»ƒæ›´ç¨³å®šï¼‰
  âœ“ å®éªŒè¡¨ç°æ›´å¥½
```

#### ä¸ºä»€ä¹ˆç”¨ GeLU è€Œä¸æ˜¯ ReLUï¼Ÿ

```
ReLU(x) = max(0, x)
      â†‘ ReLU(x)
    3 â”‚         â•±
      â”‚        â•±
    2 â”‚       â•±
      â”‚      â•±
    1 â”‚     â•±
      â”‚    â•±
    0 â”‚___â•±____________â†’ x
      â”‚
      â”‚  (x<0æ—¶å®Œå…¨æ˜¯0)

é—®é¢˜ï¼š
  âœ— x<0 æ—¶æ¢¯åº¦ä¸º0 â†’ "ç¥ç»å…ƒæ­»äº¡"
  âœ— ä¸å¤Ÿå¹³æ»‘

GeLU çš„æ”¹è¿›ï¼š
  âœ“ x<0 æ—¶ä»æœ‰å°çš„æ¢¯åº¦
  âœ“ æ›´å¹³æ»‘çš„è¿‡æ¸¡
  âœ“ Transformer ä¸­æ™®éä½¿ç”¨
```

### æ­¥éª¤3ï¼šç¬¬äºŒå±‚çº¿æ€§å˜æ¢ï¼ˆå‹ç¼©ï¼‰

#### æ•°å­¦å…¬å¼ï¼š

```
output = h_gelu Ã— W2 + b2

å…¶ä¸­ï¼š
  h_gelu: GeLUæ¿€æ´»å (B, T, 3072)
  W2:     æƒé‡ (768, 3072)
  b2:     åç½® (768,)
  output: è¾“å‡º (B, T, 768)
```

#### å…·ä½“ä¾‹å­ï¼š

```
è¾“å…¥ h_gelu = [0.12, 0.19, ..., 0.45]  (3072ç»´)

æƒé‡çŸ©é˜µ W2 (768Ã—3072)ï¼š
       h[0]  h[1]  ... h[3071]
out[0]  0.3   0.1  ...  0.2
out[1]  0.2   0.4  ...  0.1
...
out[767] 0.1  0.3  ...  0.5

è®¡ç®—ï¼š
out[0] = h_gelu[0]Ã—0.3 + h_gelu[1]Ã—0.1 + ... + h_gelu[3071]Ã—0.2 + b2[0]
out[1] = h_gelu[0]Ã—0.2 + h_gelu[1]Ã—0.4 + ... + h_gelu[3071]Ã—0.1 + b2[1]
...

è¾“å‡º = [?, ?, ..., ?]  (768ç»´)
```

## å…­ã€å®Œæ•´æµç¨‹å¯è§†åŒ–

### å¤„ç†ä¸€ä¸ªè¯å‘é‡çš„å®Œæ•´è¿‡ç¨‹ï¼š

```
è¾“å…¥ï¼šæŸä¸ªè¯çš„å‘é‡ï¼ˆæ¥è‡ªæ³¨æ„åŠ›å±‚ä¹‹åï¼‰
x = [0.1, 0.2, 0.3, ..., 0.5]  (768ç»´)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1ï¼šç¬¬ä¸€å±‚çº¿æ€§å˜æ¢                â”‚
â”‚ h = x Ã— W1 + b1                     â”‚
â”‚                                     â”‚
â”‚ 768ç»´ Ã— (3072Ã—768) â†’ 3072ç»´         â”‚
â”‚                                     â”‚
â”‚ æ¯ä¸ªè¾“å‡ºç»´åº¦æ˜¯è¾“å…¥çš„åŠ æƒå’Œï¼š          â”‚
â”‚ h[0] = Î£(x[i] Ã— W1[0,i]) + b1[0]   â”‚
â”‚ h[1] = Î£(x[i] Ã— W1[1,i]) + b1[1]   â”‚
â”‚ ...                                 â”‚
â”‚                                     â”‚
â”‚ ç»“æœï¼šh = [1.2, -0.5, ..., 0.8]    â”‚
â”‚         (3072ç»´)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2ï¼šGeLU æ¿€æ´»                    â”‚
â”‚ h_gelu = GeLU(h)                    â”‚
â”‚                                     â”‚
â”‚ é€å…ƒç´ æ“ä½œï¼š                         â”‚
â”‚ h_gelu[0] = GeLU(1.2)  = 1.15      â”‚
â”‚ h_gelu[1] = GeLU(-0.5) = -0.15     â”‚
â”‚ h_gelu[2] = GeLU(0.8)  = 0.68      â”‚
â”‚ ...                                 â”‚
â”‚                                     â”‚
â”‚ ç»“æœï¼šh_gelu = [1.15, -0.15, ..., 0.68]â”‚
â”‚              (3072ç»´)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3ï¼šç¬¬äºŒå±‚çº¿æ€§å˜æ¢                â”‚
â”‚ y = h_gelu Ã— W2 + b2                â”‚
â”‚                                     â”‚
â”‚ 3072ç»´ Ã— (768Ã—3072) â†’ 768ç»´         â”‚
â”‚                                     â”‚
â”‚ å‹ç¼©å›åŸç»´åº¦ï¼š                       â”‚
â”‚ y[0] = Î£(h_gelu[i] Ã— W2[0,i]) + b2[0]â”‚
â”‚ y[1] = Î£(h_gelu[i] Ã— W2[1,i]) + b2[1]â”‚
â”‚ ...                                 â”‚
â”‚                                     â”‚
â”‚ ç»“æœï¼šy = [0.15, 0.28, ..., 0.42]  â”‚
â”‚         (768ç»´)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
è¾“å‡ºï¼šFFNå¤„ç†åçš„å‘é‡
y = [0.15, 0.28, ..., 0.42]  (768ç»´)
```

## ä¸ƒã€FFN åœ¨åšä»€ä¹ˆï¼Ÿ

### 1. **æ³¨æ„åŠ› vs FFN çš„åˆ†å·¥**

```
Multi-Head Attentionï¼ˆæ³¨æ„åŠ›ï¼‰ï¼š
  ä½œç”¨ï¼šè¯ä¸è¯ä¹‹é—´çš„äº¤äº’
  
  ä¾‹å­ï¼š"The cat sat on the mat"
  - "cat" çœ‹ "The" â†’ çŸ¥é“æ˜¯å®šå† è¯
  - "sat" çœ‹ "cat" â†’ çŸ¥é“ä¸»è¯­æ˜¯è°
  - "mat" çœ‹ "on the" â†’ çŸ¥é“æ˜¯åœ°ç‚¹
  
  å…³é”®ï¼šè·¨ä½ç½®çš„ä¿¡æ¯æµåŠ¨

Feed-Forward Networkï¼ˆFFNï¼‰ï¼š
  ä½œç”¨ï¼šå¯¹æ¯ä¸ªè¯ç‹¬ç«‹å¤„ç†
  
  ä¾‹å­ï¼šå¯¹ "cat" è¿™ä¸ªè¯
  - è¾“å…¥ï¼š"cat" çš„å‘é‡ï¼ˆå·²ç»åŒ…å«äº†ä»æ³¨æ„åŠ›è·å¾—çš„ä¸Šä¸‹æ–‡ï¼‰
  - å¤„ç†ï¼šåœ¨3072ç»´ç©ºé—´ä¸­"æ€è€ƒ"
  - è¾“å‡ºï¼šæ›´ä¸°å¯Œçš„ "cat" è¡¨ç¤º
  
  å…³é”®ï¼šæ¯ä¸ªä½ç½®ç‹¬ç«‹ï¼Œæ·±åŒ–ç†è§£
```

### 2. **ç±»æ¯”ç†è§£**

#### ç±»æ¯”1ï¼šä¼šè®®è®¨è®º

```
æ³¨æ„åŠ›å±‚ = åœ†æ¡Œä¼šè®®
  - æ‰€æœ‰äººäº’ç›¸è®¨è®º
  - äº¤æ¢ä¿¡æ¯å’Œè§‚ç‚¹
  - "æˆ‘å¬å¬å…¶ä»–äººæ€ä¹ˆè¯´"

FFNå±‚ = ä¸ªäººæ€è€ƒ
  - æ¯ä¸ªäººç‹¬è‡ªæ¶ˆåŒ–ä¿¡æ¯
  - æ·±å…¥å¤„ç†å’Œç†è§£
  - "è®©æˆ‘å¥½å¥½æƒ³æƒ³åˆšæ‰å¬åˆ°çš„"
```

#### ç±»æ¯”2ï¼šå­¦ä¹ è¿‡ç¨‹

```
ä¸Šè¯¾æ—¶ï¼ˆæ³¨æ„åŠ›ï¼‰ï¼š
  - è€å¸ˆè®²è§£
  - åŒå­¦è®¨è®º
  - è·å–å¤šæ–¹ä¿¡æ¯

è¯¾åå¤ä¹ ï¼ˆFFNï¼‰ï¼š
  - ç‹¬è‡ªæ€è€ƒ
  - æ•´ç†ç¬”è®°
  - æ·±åŒ–ç†è§£
```

### 3. **FFN å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ**

ç ”ç©¶å‘ç°ï¼ŒFFN çš„ç¥ç»å…ƒä¼šå­¦ä¹ ç‰¹å®šæ¨¡å¼ï¼š

```
æŸäº›ç¥ç»å…ƒæ¿€æ´»å½“é‡åˆ°ï¼š

ç¥ç»å…ƒ#123ï¼š
  - "åŠ¨ç‰©"ç›¸å…³çš„è¯
  - cat, dog, bird â†’ å¼ºæ¿€æ´»
  - car, book â†’ å¼±æ¿€æ´»

ç¥ç»å…ƒ#456ï¼š
  - "è¿‡å»æ—¶"åŠ¨è¯
  - walked, ate, ran â†’ å¼ºæ¿€æ´»
  - walk, eat, run â†’ å¼±æ¿€æ´»

ç¥ç»å…ƒ#789ï¼š
  - "å¦å®š"è¯­å¢ƒ
  - not, never, no â†’ å¼ºæ¿€æ´»
  - yes, always â†’ å¼±æ¿€æ´»

æ¯ä¸ªç¥ç»å…ƒæ˜¯ä¸€ä¸ª"ç‰¹å¾æ£€æµ‹å™¨"ï¼
```

## å…«ã€å‚æ•°é‡åˆ†æ

### FFN çš„å‚æ•°ï¼š

```
ç¬¬ä¸€å±‚ï¼ˆæ‰©å±•ï¼‰ï¼š
  W1: (3072, 768) = 2,359,296 ä¸ªå‚æ•°
  b1: (3072,)     = 3,072 ä¸ªå‚æ•°

ç¬¬äºŒå±‚ï¼ˆå‹ç¼©ï¼‰ï¼š
  W2: (768, 3072) = 2,359,296 ä¸ªå‚æ•°
  b2: (768,)      = 768 ä¸ªå‚æ•°

æ¯å±‚FFNæ€»è®¡ï¼š4,722,432 ä¸ªå‚æ•°

12å±‚æ€»è®¡ï¼š
  4,722,432 Ã— 12 = 56,669,184 ä¸ªå‚æ•°
  
å GPT-2 Smallæ€»å‚æ•°çš„æ¯”ä¾‹ï¼š
  56,669,184 / 124,439,808 â‰ˆ 45.5%
  
FFN æ˜¯æ¨¡å‹ä¸­å‚æ•°æœ€å¤šçš„éƒ¨åˆ†ï¼
```

## ä¹ã€FFN çš„å˜ä½“

### 1. **æ ‡å‡† FFNï¼ˆGPT-2 ä½¿ç”¨çš„ï¼‰**

```
x â†’ Linear(4xæ‰©å±•) â†’ GeLU â†’ Linear(å‹ç¼©) â†’ out
```

### 2. **GLUï¼ˆGated Linear Unitï¼‰**

```
x â†’ Linear â†’ åˆ†æˆä¸¤ä»½ â†’ ä¸€ä»½ç»è¿‡sigmoid â†’ ç›¸ä¹˜ â†’ out
     â†“
  [A, B]
     â†“
  A âŠ™ Ïƒ(B)
```

### 3. **SwiGLUï¼ˆç°ä»£å˜ä½“ï¼Œå¦‚LLaMAï¼‰**

```
x â†’ Linear â†’ Swish(x) â†’ âŠ™ â†’ Linear â†’ out
         â†˜  Linear  â†—
```

### 4. **MoEï¼ˆMixture of Expertsï¼‰**

```
x â†’ è·¯ç”±å™¨å†³å®š â†’ é€‰æ‹©å‡ ä¸ªä¸“å®¶FFN â†’ åŠ æƒå¹³å‡ â†’ out
      â†“
   ä¸“å®¶1, ä¸“å®¶3, ä¸“å®¶7
```

## åã€ä»£ç ä¼˜åŒ–æŠ€å·§

### 1. **å¾ªç¯å±•å¼€ï¼ˆä»£ç ä¸­ä½¿ç”¨çš„ï¼‰**

```c
void matmul_forward(float* out, const float* inp, const float* weight,
                    const float* bias, int B, int T, int C, int OC) {
    
    const int LOOP_UNROLL = 8;
    
    #pragma omp parallel for
    for (int obt = 0; obt < B * T; obt += LOOP_UNROLL) {
        for (int o = 0; o < OC; o++) {
            // ä¸€æ¬¡å¤„ç†8ä¸ªä½ç½®
            float result[LOOP_UNROLL];
            for (int ibt = 0; ibt < LOOP_UNROLL; ibt++) {
                result[ibt] = (bias != NULL) ? bias[o] : 0.0f;
            }
            
            // å¯¹æ¯ä¸ªè¾“å…¥ç»´åº¦
            for (int i = 0; i < C; i++) {
                float w = weight[i + o * C];  // å¤ç”¨æƒé‡
                for (int ibt = 0; ibt < LOOP_UNROLL; ibt++) {
                    int bt = obt + ibt;
                    result[ibt] += inp[bt * C + i] * w;
                }
            }
            
            // å†™å›ç»“æœ
            for (int ibt = 0; ibt < LOOP_UNROLL; ibt++) {
                int bt = obt + ibt;
                out[bt * OC + o] = result[ibt];
            }
        }
    }
}
```

å¥½å¤„ï¼š
- å¤ç”¨æƒé‡ `w`ï¼ˆåªè¯»ä¸€æ¬¡ï¼Œç”¨8æ¬¡ï¼‰
- æ›´å¥½çš„ç¼“å­˜åˆ©ç”¨
- å‡å°‘å†…å­˜è®¿é—®æ¬¡æ•°

### 2. **OpenMP å¹¶è¡ŒåŒ–**

```c
#pragma omp parallel for
```

è‡ªåŠ¨åœ¨å¤šä¸ªCPUæ ¸å¿ƒä¸Šå¹¶è¡Œè®¡ç®—ã€‚

## åä¸€ã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹ï¼š

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **ä½œç”¨** | å¯¹æ¯ä¸ªè¯ç‹¬ç«‹è¿›è¡Œéçº¿æ€§å˜æ¢ |
| **ç»“æ„** | ä¸¤å±‚çº¿æ€§å˜æ¢ + ä¸€ä¸ªæ¿€æ´»å‡½æ•° |
| **ç»´åº¦** | 768 â†’ 3072 â†’ 768ï¼ˆæ‰©å±•4å€å†å‹ç¼©ï¼‰ |
| **æ¿€æ´»å‡½æ•°** | GeLUï¼ˆæ¯”ReLUæ›´å¹³æ»‘ï¼‰ |
| **ç‰¹ç‚¹** | ä½ç½®ç‹¬ç«‹ï¼ˆä¸è·¨è¯äº¤äº’ï¼‰ |
| **å‚æ•°é‡** | çº¦å æ¨¡å‹æ€»å‚æ•°çš„45% |

### ç±»æ¯”è®°å¿†ï¼š

```
FFN = ä¸ªäººçš„æ·±åº¦æ€è€ƒ

æ³¨æ„åŠ›å±‚å‘Šè¯‰ä½ ï¼š"å…¶ä»–è¯è¯´äº†ä»€ä¹ˆ"
FFNå±‚è®©ä½ æƒ³ï¼š"æˆ‘è¯¥å¦‚ä½•ç†è§£å’Œååº”"

å°±åƒï¼š
  å¬å®Œåˆ«äººè®²è¯ï¼ˆæ³¨æ„åŠ›ï¼‰
  â†“
  è‡ªå·±æ€è€ƒæ¶ˆåŒ–ï¼ˆFFNï¼‰
  â†“
  å½¢æˆè‡ªå·±çš„è§‚ç‚¹
```

### å…¬å¼æ€»ç»“ï¼š

```
FFN(x) = W2 Ã— GeLU(W1 Ã— x + b1) + b2

å…¶ä¸­ï¼š
  x:  è¾“å…¥ (768ç»´)
  W1: (3072, 768)
  b1: (3072,)
  GeLU: æ¿€æ´»å‡½æ•°
  W2: (768, 3072)
  b2: (768,)
  è¾“å‡º: (768ç»´)
```

FFN è™½ç„¶ç»“æ„ç®€å•ï¼Œä½†é€šè¿‡**é«˜ç»´ç©ºé—´çš„éçº¿æ€§å˜æ¢**ï¼Œèµ‹äºˆäº†æ¨¡å‹å¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›ï¼è¿™æ˜¯ Transformer æˆåŠŸçš„å…³é”®ç»„ä»¶ä¹‹ä¸€ã€‚ğŸš€


# Layer Normalization æ˜¯ä»€ä¹ˆ

# Layer Normalization è¯¦è§£

Layer Normalizationï¼ˆå±‚å½’ä¸€åŒ–ï¼‰æ˜¯æ·±åº¦å­¦ä¹ ä¸­çš„é‡è¦æŠ€æœ¯ï¼Œè®©æˆ‘ä»é›¶å¼€å§‹è®²æ¸…æ¥šã€‚

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å½’ä¸€åŒ–ï¼Ÿ

### 1. **é—®é¢˜ï¼šæ•°å€¼ä¸ç¨³å®š**

#### åœºæ™¯1ï¼šè®­ç»ƒåˆæœŸçš„çˆ†ç‚¸

```
æ²¡æœ‰å½’ä¸€åŒ–æ—¶ï¼š

Layer 1 è¾“å‡º: [0.5, 0.8, 0.3, ...]   (æ­£å¸¸èŒƒå›´)
    â†“ çº¿æ€§å˜æ¢
Layer 2 è¾“å‡º: [5.2, 8.1, 3.4, ...]   (å˜å¤§äº†)
    â†“ çº¿æ€§å˜æ¢
Layer 3 è¾“å‡º: [52, 81, 34, ...]      (æ›´å¤§äº†)
    â†“ çº¿æ€§å˜æ¢
Layer 4 è¾“å‡º: [520, 810, 340, ...]   (çˆ†ç‚¸ï¼)
    â†“
æ¢¯åº¦çˆ†ç‚¸ï¼Œè®­ç»ƒå´©æºƒ âŒ
```

#### åœºæ™¯2ï¼šè®­ç»ƒå›°éš¾

```
å‡è®¾ä¸¤ä¸ªç‰¹å¾çš„å€¼ï¼š

ç‰¹å¾1: [0.001, 0.002, 0.001, ...]  (å¾ˆå°)
ç‰¹å¾2: [100, 200, 150, ...]         (å¾ˆå¤§)

é—®é¢˜ï¼š
  - æ¢¯åº¦ä¸»è¦è¢«å¤§çš„ç‰¹å¾ä¸»å¯¼
  - å°çš„ç‰¹å¾å‡ ä¹å­¦ä¸åˆ°ä¸œè¥¿
  - è®­ç»ƒç¼“æ…¢ä¸”ä¸ç¨³å®š
```

### 2. **è§£å†³æ–¹æ¡ˆï¼šå½’ä¸€åŒ–**

```
å½’ä¸€åŒ–åï¼š

ç‰¹å¾1: [0.001, 0.002, 0.001, ...] â†’ [-1.0, 0.5, -0.8, ...]
ç‰¹å¾2: [100, 200, 150, ...]        â†’ [-1.1, 0.9, -0.2, ...]

æ‰€æœ‰ç‰¹å¾åœ¨ç›¸ä¼¼çš„èŒƒå›´å†…ï¼
  âœ“ è®­ç»ƒç¨³å®š
  âœ“ æ”¶æ•›æ›´å¿«
  âœ“ æ€§èƒ½æ›´å¥½
```

## äºŒã€Layer Normalization æ˜¯ä»€ä¹ˆï¼Ÿ

### ç®€å•å®šä¹‰ï¼š

> **å¯¹æ¯ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä½¿å…¶å‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1**

### å…³é”®å…¬å¼ï¼š

```
y = (x - mean) / std Ã— Î³ + Î²

å…¶ä¸­ï¼š
  x:    è¾“å…¥
  mean: å‡å€¼
  std:  æ ‡å‡†å·®
  Î³:    å¯å­¦ä¹ çš„ç¼©æ”¾å‚æ•°ï¼ˆscaleï¼‰
  Î²:    å¯å­¦ä¹ çš„åç§»å‚æ•°ï¼ˆshiftï¼‰
  y:    è¾“å‡º
```

## ä¸‰ã€ä»£ç å®ç°è¯¦è§£

### 1. **å‰å‘ä¼ æ’­**

```c
void layernorm_forward(float* out, float* mean, float* rstd,
                       float* inp, float* weight, float* bias,
                       int B, int T, int C) {
    // inp: (B, T, C) è¾“å…¥
    // out: (B, T, C) è¾“å‡º
    // mean: (B, T) æ¯ä¸ªä½ç½®çš„å‡å€¼
    // rstd: (B, T) æ¯ä¸ªä½ç½®çš„æ ‡å‡†å·®å€’æ•°
    // weight: (C,) Î³å‚æ•°
    // bias: (C,) Î²å‚æ•°
    
    float eps = 1e-5f;  // é˜²æ­¢é™¤é›¶
    
    for (int b = 0; b < B; b++) {
        for (int t = 0; t < T; t++) {
            // å¯¹æ¯ä¸ªä½ç½®(b,t)çš„Cç»´å‘é‡è¿›è¡Œå½’ä¸€åŒ–
            float* x = inp + b * T * C + t * C;  // æŒ‡å‘è¾“å…¥å‘é‡
            
            // === æ­¥éª¤1ï¼šè®¡ç®—å‡å€¼ ===
            float m = 0.0f;
            for (int i = 0; i < C; i++) {
                m += x[i];
            }
            m = m / C;
            
            // === æ­¥éª¤2ï¼šè®¡ç®—æ–¹å·® ===
            float v = 0.0f;
            for (int i = 0; i < C; i++) {
                float xshift = x[i] - m;
                v += xshift * xshift;
            }
            v = v / C;
            
            // === æ­¥éª¤3ï¼šè®¡ç®—æ ‡å‡†å·®çš„å€’æ•° ===
            float s = 1.0f / sqrtf(v + eps);
            //                        â†‘
            //              åŠ ä¸€ä¸ªå°å€¼é˜²æ­¢é™¤é›¶
            
            // === æ­¥éª¤4ï¼šå½’ä¸€åŒ–ã€ç¼©æ”¾ã€åç§» ===
            float* out_bt = out + b * T * C + t * C;
            for (int i = 0; i < C; i++) {
                float n = (s * (x[i] - m));        // å½’ä¸€åŒ–
                float o = n * weight[i] + bias[i]; // ç¼©æ”¾å’Œåç§»
                out_bt[i] = o;
            }
            
            // ç¼“å­˜å‡å€¼å’Œæ ‡å‡†å·®å€’æ•°ï¼ˆåå‘ä¼ æ’­éœ€è¦ï¼‰
            mean[b * T + t] = m;
            rstd[b * T + t] = s;
        }
    }
}
```

### 2. **é€æ­¥æ‹†è§£**

#### å‡è®¾ç®€åŒ–ä¾‹å­ï¼šC=4ï¼ˆ4ç»´å‘é‡ï¼‰

```
è¾“å…¥å‘é‡ x = [10.0, 20.0, 30.0, 40.0]

æ­¥éª¤1ï¼šè®¡ç®—å‡å€¼
  mean = (10 + 20 + 30 + 40) / 4 = 25

æ­¥éª¤2ï¼šè®¡ç®—æ–¹å·®
  var = [(10-25)Â² + (20-25)Â² + (30-25)Â² + (40-25)Â²] / 4
      = [225 + 25 + 25 + 225] / 4
      = 500 / 4
      = 125

æ­¥éª¤3ï¼šè®¡ç®—æ ‡å‡†å·®
  std = âˆš(125 + 1e-5) â‰ˆ 11.18
  rstd = 1 / std â‰ˆ 0.0894

æ­¥éª¤4ï¼šå½’ä¸€åŒ–
  norm[0] = (10 - 25) / 11.18 = -1.34
  norm[1] = (20 - 25) / 11.18 = -0.45
  norm[2] = (30 - 25) / 11.18 = 0.45
  norm[3] = (40 - 25) / 11.18 = 1.34

éªŒè¯ï¼šå‡å€¼â‰ˆ0, æ–¹å·®â‰ˆ1 âœ“

æ­¥éª¤5ï¼šç¼©æ”¾å’Œåç§»ï¼ˆå‡è®¾weight=[1,1,1,1], bias=[0,0,0,0]ï¼‰
  out[0] = -1.34 Ã— 1 + 0 = -1.34
  out[1] = -0.45 Ã— 1 + 0 = -0.45
  out[2] = 0.45 Ã— 1 + 0 = 0.45
  out[3] = 1.34 Ã— 1 + 0 = 1.34

è¾“å‡º = [-1.34, -0.45, 0.45, 1.34]
```

## å››ã€ä¸ºä»€ä¹ˆè¦ Î³ (weight) å’Œ Î² (bias)ï¼Ÿ

### é—®é¢˜ï¼šçº¯å½’ä¸€åŒ–é™åˆ¶äº†è¡¨è¾¾èƒ½åŠ›

```
å¦‚æœåªåšå½’ä¸€åŒ–ï¼š
  out = (x - mean) / std

é—®é¢˜ï¼š
  âœ— å¼ºåˆ¶å‡å€¼=0, æ–¹å·®=1
  âœ— å¦‚æœæ¨¡å‹éœ€è¦å…¶ä»–åˆ†å¸ƒå‘¢ï¼Ÿ
  âœ— é™åˆ¶äº†æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›

ä¾‹å­ï¼š
  æ¨¡å‹å¯èƒ½å­¦åˆ°ï¼šæŸä¸€å±‚æœ€å¥½æ˜¯å‡å€¼=2, æ–¹å·®=0.5
  ä½†çº¯å½’ä¸€åŒ–å¼ºåˆ¶æ˜¯å‡å€¼=0, æ–¹å·®=1
```

### è§£å†³ï¼šåŠ å…¥å¯å­¦ä¹ å‚æ•°

```
out = Î³ Ã— (x - mean) / std + Î²

Î³ (weight) å’Œ Î² (bias) æ˜¯å¯å­¦ä¹ çš„ï¼

ç†è®ºä¸Šï¼Œæ¨¡å‹å¯ä»¥å­¦åˆ°ï¼š
  Î³ = std_desired
  Î² = mean_desired

å°±èƒ½æ¢å¤åˆ°ä»»ä½•æƒ³è¦çš„åˆ†å¸ƒï¼

ç”šè‡³å¯ä»¥å­¦åˆ°ï¼š
  Î³ = std_original
  Î² = mean_original
  
å®Œå…¨æ’¤é”€å½’ä¸€åŒ–ï¼ˆå¦‚æœè¿™æ ·æ›´å¥½çš„è¯ï¼‰
```

### å®é™…ä¾‹å­ï¼š

```
å‡è®¾æ¨¡å‹å­¦åˆ°ï¼š
  weight = [2.0, 1.0, 0.5, 3.0]  (Î³)
  bias   = [0.1, -0.2, 0.3, 0.0]  (Î²)

å½’ä¸€åŒ–åçš„å€¼: [-1.34, -0.45, 0.45, 1.34]

åº”ç”¨ç¼©æ”¾å’Œåç§»ï¼š
  out[0] = -1.34 Ã— 2.0 + 0.1  = -2.58
  out[1] = -0.45 Ã— 1.0 + (-0.2) = -0.65
  out[2] = 0.45 Ã— 0.5 + 0.3   = 0.525
  out[3] = 1.34 Ã— 3.0 + 0.0   = 4.02

æ¯ä¸ªç»´åº¦å¯ä»¥æœ‰ä¸åŒçš„ç¼©æ”¾å’Œåç§»ï¼
```

## äº”ã€ä¸åŒå½’ä¸€åŒ–æ–¹æ³•å¯¹æ¯”

### 1. **Batch Normalization (BN)**

```
å¯¹æ¯ä¸ªç‰¹å¾ï¼Œåœ¨æ‰¹æ¬¡ç»´åº¦ä¸Šå½’ä¸€åŒ–

è¾“å…¥å½¢çŠ¶ï¼š(B, T, C) = (4, 64, 768)

å¯¹ç¬¬iä¸ªç‰¹å¾ï¼š
  åœ¨æ‰€æœ‰BÃ—Tä¸ªæ ·æœ¬ä¸Šè®¡ç®—å‡å€¼å’Œæ–¹å·®
  
  mean[i] = average over (B, T) dimension
  
ç¤ºæ„ï¼š
       æ ·æœ¬1  æ ·æœ¬2  æ ·æœ¬3  æ ·æœ¬4  ...
ç‰¹å¾0   [ 0.5,  0.3,  0.7,  0.4, ...]  â†’ è®¡ç®—è¿™ä¸€è¡Œçš„å‡å€¼
ç‰¹å¾1   [ 1.2,  0.9,  1.5,  1.1, ...]  â†’ è®¡ç®—è¿™ä¸€è¡Œçš„å‡å€¼
ç‰¹å¾2   [ 0.8,  0.6,  0.9,  0.7, ...]  â†’ è®¡ç®—è¿™ä¸€è¡Œçš„å‡å€¼
...

é—®é¢˜ï¼š
  âœ— ä¾èµ–æ‰¹æ¬¡å¤§å°ï¼ˆbatch sizeå°æ—¶æ•ˆæœå·®ï¼‰
  âœ— è®­ç»ƒå’Œæ¨ç†æ—¶è¡Œä¸ºä¸åŒ
  âœ— ä¸é€‚åˆåºåˆ—ä»»åŠ¡ï¼ˆRNN, Transformerï¼‰
```

### 2. **Layer Normalization (LN)**

```
å¯¹æ¯ä¸ªæ ·æœ¬ï¼Œåœ¨ç‰¹å¾ç»´åº¦ä¸Šå½’ä¸€åŒ–

è¾“å…¥å½¢çŠ¶ï¼š(B, T, C) = (4, 64, 768)

å¯¹æ¯ä¸ªæ ·æœ¬çš„æ¯ä¸ªä½ç½®ï¼š
  åœ¨Cä¸ªç‰¹å¾ä¸Šè®¡ç®—å‡å€¼å’Œæ–¹å·®
  
ç¤ºæ„ï¼š
æ ·æœ¬1, ä½ç½®0:
  [ç‰¹å¾0, ç‰¹å¾1, ç‰¹å¾2, ..., ç‰¹å¾767]
   0.5,   1.2,   0.8,  ...,   0.3
   â†‘__________________________|
   åœ¨è¿™C=768ä¸ªå€¼ä¸Šè®¡ç®—å‡å€¼å’Œæ–¹å·®

ä¼˜ç‚¹ï¼š
  âœ“ ä¸æ‰¹æ¬¡å¤§å°æ— å…³
  âœ“ è®­ç»ƒå’Œæ¨ç†æ—¶è¡Œä¸ºä¸€è‡´
  âœ“ é€‚åˆåºåˆ—ä»»åŠ¡
  âœ“ Transformerçš„æ ‡é…
```

### 3. **å¯è§†åŒ–å¯¹æ¯”**

```
è¾“å…¥ï¼š(B=2, T=3, C=4)

æ•°æ®ï¼š
Batch 0:
  pos 0: [1, 2, 3, 4]
  pos 1: [5, 6, 7, 8]
  pos 2: [9, 10, 11, 12]

Batch 1:
  pos 0: [2, 4, 6, 8]
  pos 1: [10, 12, 14, 16]
  pos 2: [18, 20, 22, 24]

Batch Normï¼ˆè·¨æ ·æœ¬å½’ä¸€åŒ–ï¼‰ï¼š
  å¯¹ç‰¹å¾0: [1, 5, 9, 2, 10, 18] â†’ å½’ä¸€åŒ–
  å¯¹ç‰¹å¾1: [2, 6, 10, 4, 12, 20] â†’ å½’ä¸€åŒ–
  å¯¹ç‰¹å¾2: [3, 7, 11, 6, 14, 22] â†’ å½’ä¸€åŒ–
  å¯¹ç‰¹å¾3: [4, 8, 12, 8, 16, 24] â†’ å½’ä¸€åŒ–

Layer Normï¼ˆæ¯ä¸ªæ ·æœ¬ç‹¬ç«‹ï¼‰ï¼š
  Batch 0, pos 0: [1, 2, 3, 4] â†’ å½’ä¸€åŒ–
  Batch 0, pos 1: [5, 6, 7, 8] â†’ å½’ä¸€åŒ–
  Batch 0, pos 2: [9, 10, 11, 12] â†’ å½’ä¸€åŒ–
  Batch 1, pos 0: [2, 4, 6, 8] â†’ å½’ä¸€åŒ–
  Batch 1, pos 1: [10, 12, 14, 16] â†’ å½’ä¸€åŒ–
  Batch 1, pos 2: [18, 20, 22, 24] â†’ å½’ä¸€åŒ–
```

## å…­ã€Layer Normalization åœ¨ GPT-2 ä¸­çš„ä½¿ç”¨

### 1. **ä½ç½®ï¼šPre-Norm æ¶æ„**

```
Transformer å±‚ï¼ˆGPT-2çš„å®ç°ï¼‰ï¼š

è¾“å…¥ x
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LayerNorm               â”‚  â† ç¬¬1ä¸ªLNï¼ˆåœ¨æ³¨æ„åŠ›ä¹‹å‰ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Multi-Head Attention    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Residual: x + attention â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LayerNorm               â”‚  â† ç¬¬2ä¸ªLNï¼ˆåœ¨FFNä¹‹å‰ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feed-Forward Network    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Residual: x + ffn       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
è¾“å‡º
```

### 2. **ä»£ç ä¸­çš„ä½¿ç”¨**

```c
for (int l = 0; l < L; l++) {
    residual = l == 0 ? acts.encoded : acts.residual3 + (l-1) * B * T * C;
    
    // è·å–è¿™ä¸€å±‚çš„å‚æ•°
    float* l_ln1w = params.ln1w + l * C;  // Î³å‚æ•°
    float* l_ln1b = params.ln1b + l * C;  // Î²å‚æ•°
    
    // === ç¬¬1ä¸ªLayerNormï¼ˆæ³¨æ„åŠ›ä¹‹å‰ï¼‰===
    layernorm_forward(l_ln1, l_ln1_mean, l_ln1_rstd, 
                      residual, l_ln1w, l_ln1b, B, T, C);
    
    // QKVç”Ÿæˆå’Œæ³¨æ„åŠ›è®¡ç®—
    matmul_forward(l_qkv, l_ln1, l_qkvw, l_qkvb, B, T, C, 3*C);
    attention_forward(l_atty, l_preatt, l_att, l_qkv, B, T, C, NH);
    matmul_forward(l_attproj, l_atty, l_attprojw, l_attprojb, B, T, C, C);
    
    // æ®‹å·®è¿æ¥
    residual_forward(l_residual2, residual, l_attproj, B*T*C);
    
    // è·å–ç¬¬2ä¸ªLNçš„å‚æ•°
    float* l_ln2w = params.ln2w + l * C;
    float* l_ln2b = params.ln2b + l * C;
    
    // === ç¬¬2ä¸ªLayerNormï¼ˆFFNä¹‹å‰ï¼‰===
    layernorm_forward(l_ln2, l_ln2_mean, l_ln2_rstd, 
                      l_residual2, l_ln2w, l_ln2b, B, T, C);
    
    // FFN
    matmul_forward(l_fch, l_ln2, l_fcw, l_fcb, B, T, C, 4*C);
    gelu_forward(l_fch_gelu, l_fch, B*T*4*C);
    matmul_forward(l_fcproj, l_fch_gelu, l_fcprojw, l_fcprojb, B, T, 4*C, C);
    
    // æ®‹å·®è¿æ¥
    residual_forward(l_residual3, l_residual2, l_fcproj, B*T*C);
}

// === æœ€åä¸€ä¸ªLayerNorm ===
residual = acts.residual3 + (L-1) * B * T * C;
layernorm_forward(acts.lnf, acts.lnf_mean, acts.lnf_rstd, 
                  residual, params.lnfw, params.lnfb, B, T, C);
```

### 3. **å‚æ•°é‡**

```
æ¯å±‚æœ‰2ä¸ªLayerNormï¼š
  - ln1: weight(768) + bias(768) = 1,536 å‚æ•°
  - ln2: weight(768) + bias(768) = 1,536 å‚æ•°
  
æ¯å±‚æ€»è®¡ï¼š3,072 å‚æ•°

12å±‚ï¼š3,072 Ã— 12 = 36,864 å‚æ•°

æœ€åä¸€ä¸ªLayerNormï¼š
  - lnf: weight(768) + bias(768) = 1,536 å‚æ•°

æ€»è®¡ï¼š36,864 + 1,536 = 38,400 å‚æ•°

å æ€»å‚æ•°çš„æ¯”ä¾‹ï¼š
  38,400 / 124,439,808 â‰ˆ 0.03%ï¼ˆéå¸¸å°ï¼‰
```

## ä¸ƒã€ä¸ºä»€ä¹ˆ Layer Normalization æœ‰æ•ˆï¼Ÿ

### 1. **ç¨³å®šè®­ç»ƒ**

```
æ²¡æœ‰LNï¼š
  Layer 10 çš„è¾“å‡º: [50, -30, 80, ...]  (èŒƒå›´å¤§)
  æ¢¯åº¦å¯èƒ½å¾ˆå¤§æˆ–å¾ˆå°
  å­¦ä¹ ç‡éš¾ä»¥è°ƒæ•´

æœ‰LNï¼š
  Layer 10 çš„è¾“å‡º: [0.5, -0.3, 0.8, ...]  (å½’ä¸€åŒ–)
  æ¢¯åº¦ç¨³å®š
  è®­ç»ƒé¡ºåˆ©
```

### 2. **åŠ é€Ÿæ”¶æ•›**

```
å®éªŒæ•°æ®ï¼š

ä¸ç”¨LNï¼š
  è¾¾åˆ°ç›¸åŒæ€§èƒ½éœ€è¦ï¼š100,000 æ­¥

ä½¿ç”¨LNï¼š
  è¾¾åˆ°ç›¸åŒæ€§èƒ½éœ€è¦ï¼š30,000 æ­¥
  
åŠ é€Ÿçº¦3å€ï¼
```

### 3. **å…è®¸æ›´å¤§çš„å­¦ä¹ ç‡**

```
æ²¡æœ‰LNï¼š
  å­¦ä¹ ç‡ > 0.0001 â†’ è®­ç»ƒä¸ç¨³å®š

æœ‰LNï¼š
  å­¦ä¹ ç‡å¯ä»¥ç”¨åˆ° 0.001
  è®­ç»ƒæ›´å¿«
```

## å…«ã€åå‘ä¼ æ’­

### 1. **æ¢¯åº¦è®¡ç®—**

```c
void layernorm_backward(float* dinp, float* dweight, float* dbias,
                        float* dout, float* inp, float* weight, 
                        float* mean, float* rstd,
                        int B, int T, int C) {
    
    for (int b = 0; b < B; b++) {
        for (int t = 0; t < T; t++) {
            float* dout_bt = dout + b * T * C + t * C;
            float* inp_bt = inp + b * T * C + t * C;
            float* dinp_bt = dinp + b * T * C + t * C;
            float mean_bt = mean[b * T + t];
            float rstd_bt = rstd[b * T + t];

            // === ç¬¬ä¸€éï¼šè®¡ç®—ä¸­é—´ç»Ÿè®¡é‡ ===
            float dnorm_mean = 0.0f;
            float dnorm_norm_mean = 0.0f;
            for (int i = 0; i < C; i++) {
                float norm_bti = (inp_bt[i] - mean_bt) * rstd_bt;
                float dnorm_i = weight[i] * dout_bt[i];
                dnorm_mean += dnorm_i;
                dnorm_norm_mean += dnorm_i * norm_bti;
            }
            dnorm_mean = dnorm_mean / C;
            dnorm_norm_mean = dnorm_norm_mean / C;

            // === ç¬¬äºŒéï¼šè®¡ç®—æ‰€æœ‰æ¢¯åº¦ ===
            for (int i = 0; i < C; i++) {
                float norm_bti = (inp_bt[i] - mean_bt) * rstd_bt;
                float dnorm_i = weight[i] * dout_bt[i];
                
                // å¯¹biasçš„æ¢¯åº¦
                dbias[i] += dout_bt[i];
                
                // å¯¹weightçš„æ¢¯åº¦
                dweight[i] += norm_bti * dout_bt[i];
                
                // å¯¹è¾“å…¥çš„æ¢¯åº¦ï¼ˆæœ€å¤æ‚ï¼‰
                float dval = 0.0f;
                dval += dnorm_i;                    // é¡¹1
                dval -= dnorm_mean;                 // é¡¹2
                dval -= norm_bti * dnorm_norm_mean; // é¡¹3
                dval *= rstd_bt;                    // æœ€ç»ˆç¼©æ”¾
                dinp_bt[i] += dval;
            }
        }
    }
}
```

### 2. **æ¢¯åº¦æµåŠ¨**

```
å‰å‘ï¼š
  x â†’ [å‡å€¼, æ–¹å·®] â†’ å½’ä¸€åŒ– â†’ Ã— Î³ â†’ + Î² â†’ y

åå‘ï¼š
  dy â† [å¤æ‚è®¡ç®—] â† å½’ä¸€åŒ–æ¢¯åº¦ â† Ã— Î³ â† + Î² â† dy
   â†“
  dx (è€ƒè™‘äº†å‡å€¼å’Œæ–¹å·®çš„ä¾èµ–å…³ç³»)
```

## ä¹ã€å¸¸è§å˜ä½“

### 1. **RMSNormï¼ˆRoot Mean Square Normï¼‰**

```
ç®€åŒ–ç‰ˆæœ¬ï¼šåªç”¨RMSï¼Œä¸å‡å‡å€¼

RMSNorm(x) = x / RMS(x) Ã— Î³

å…¶ä¸­ï¼š
  RMS(x) = âˆš(mean(xÂ²))

ä¼˜ç‚¹ï¼š
  âœ“ è®¡ç®—æ›´å¿«ï¼ˆçœç•¥äº†å‡å€¼è®¡ç®—ï¼‰
  âœ“ å†…å­˜æ›´å°‘
  âœ“ LLaMAç­‰ç°ä»£æ¨¡å‹ä½¿ç”¨

ä»£ç ï¼š
float rms = 0.0f;
for (int i = 0; i < C; i++) {
    rms += x[i] * x[i];
}
rms = sqrtf(rms / C);
for (int i = 0; i < C; i++) {
    out[i] = x[i] / rms * weight[i];
}
```

### 2. **Pre-LN vs Post-LN**

```
Pre-LNï¼ˆGPT-2ä½¿ç”¨ï¼‰ï¼š
  x â†’ LN â†’ Attention â†’ + â†’ LN â†’ FFN â†’ +
  
  ä¼˜ç‚¹ï¼šè®­ç»ƒæ›´ç¨³å®š

Post-LNï¼ˆåŸå§‹Transformerï¼‰ï¼š
  x â†’ Attention â†’ + â†’ LN â†’ FFN â†’ + â†’ LN
  
  éœ€è¦å­¦ä¹ ç‡é¢„çƒ­ï¼ˆwarmupï¼‰
```

## åã€å®é™…ä¾‹å­

### å®Œæ•´çš„æ•°å€¼ä¾‹å­ï¼š

```c
// è¾“å…¥
float inp[4] = {10.0f, 20.0f, 30.0f, 40.0f};
float weight[4] = {1.0f, 1.0f, 1.0f, 1.0f};
float bias[4] = {0.0f, 0.0f, 0.0f, 0.0f};
float out[4];
float mean_val, rstd_val;

// è®¡ç®—å‡å€¼
mean_val = (10 + 20 + 30 + 40) / 4.0f = 25.0f

// è®¡ç®—æ–¹å·®
float var = ((10-25)Â² + (20-25)Â² + (30-25)Â² + (40-25)Â²) / 4.0f
          = (225 + 25 + 25 + 225) / 4.0f
          = 125.0f

// è®¡ç®—æ ‡å‡†å·®å€’æ•°
rstd_val = 1.0f / sqrtf(125.0f + 1e-5f) = 0.08944f

// å½’ä¸€åŒ–
out[0] = (10 - 25) * 0.08944 * 1.0 + 0.0 = -1.3416
out[1] = (20 - 25) * 0.08944 * 1.0 + 0.0 = -0.4472
out[2] = (30 - 25) * 0.08944 * 1.0 + 0.0 = 0.4472
out[3] = (40 - 25) * 0.08944 * 1.0 + 0.0 = 1.3416

// éªŒè¯ï¼šå‡å€¼ â‰ˆ 0, æ ‡å‡†å·® â‰ˆ 1
éªŒè¯å‡å€¼: (-1.3416 + -0.4472 + 0.4472 + 1.3416) / 4 = 0.0 âœ“
éªŒè¯æ–¹å·®: (1.3416Â² + 0.4472Â² + 0.4472Â² + 1.3416Â²) / 4 = 1.0 âœ“
```

## åä¸€ã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹ï¼š

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **ä½œç”¨** | ç¨³å®šè®­ç»ƒï¼ŒåŠ é€Ÿæ”¶æ•› |
| **æ–¹æ³•** | æ¯ä¸ªæ ·æœ¬ç‹¬ç«‹å½’ä¸€åŒ–åˆ°å‡å€¼0æ–¹å·®1 |
| **å…¬å¼** | y = Î³ Ã— (x-mean)/std + Î² |
| **å‚æ•°** | Î³(weight) å’Œ Î²(bias)ï¼Œå¯å­¦ä¹  |
| **ä½ç½®** | åœ¨æ³¨æ„åŠ›å’ŒFFNä¹‹å‰ |
| **ä¼˜ç‚¹** | ä¸batch sizeæ— å…³ï¼Œé€‚åˆåºåˆ—ä»»åŠ¡ |

### ç±»æ¯”è®°å¿†ï¼š

```
Layer Normalization = è€ƒè¯•æˆç»©æ ‡å‡†åŒ–

åŸå§‹åˆ†æ•°ï¼š[60, 70, 80, 90]
  â†“
è®¡ç®—è¿™ä¸ªå­¦ç”Ÿçš„å¹³å‡åˆ†å’Œæ ‡å‡†å·®
  â†“
æ ‡å‡†åŒ–ï¼š[-1.34, -0.45, 0.45, 1.34]
  â†“
æ‰€æœ‰å­¦ç”Ÿçš„åˆ†æ•°åœ¨å¯æ¯”è¾ƒçš„èŒƒå›´å†…

ä½œç”¨ï¼š
  âœ“ æ¶ˆé™¤ä¸åŒç§‘ç›®çš„åˆ†æ•°èŒƒå›´å·®å¼‚
  âœ“ è®©æ¯”è¾ƒæ›´å…¬å¹³
  âœ“ ç±»ä¼¼åœ°ï¼ŒLNè®©ä¸åŒå±‚çš„æ•°å€¼åœ¨ç›¸ä¼¼èŒƒå›´
```

### å…³é”®å…¬å¼ï¼š

```c
// å‡å€¼
mean = Î£x[i] / C

// æ–¹å·®
var = Î£(x[i] - mean)Â² / C

// æ ‡å‡†å·®å€’æ•°
rstd = 1 / âˆš(var + Îµ)

// å½’ä¸€åŒ–ã€ç¼©æ”¾ã€åç§»
out[i] = ((x[i] - mean) * rstd) * weight[i] + bias[i]
```

Layer Normalization æ˜¯ Transformer æˆåŠŸçš„å…³é”®æŠ€æœ¯ä¹‹ä¸€ï¼Œå®ƒè®©æ·±å±‚ç½‘ç»œçš„è®­ç»ƒå˜å¾—ç¨³å®šå¯é ï¼ğŸ¯








